<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Êó•Êú¨ÂØåÂ£´Èú≤Ááü & Êé¢Á¥¢ | Travel Plan</title>
        <!-- Vue 3 -->
        <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Google Fonts -->
        <link
            href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
            rel="stylesheet"
        />
        <!-- Phosphor Icons -->
        <script src="https://unpkg.com/@phosphor-icons/web"></script>
        <!-- Leaflet CSS & JS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

        <style>
            :root {
                --camp-forest: #0d1b2a;
                --camp-forest-2: #123047;
                --camp-deep: #0a0f1a;
                --camp-surface: #0f172a;
                --camp-card: #f8fafc;
                --camp-accent: #f59e0b;
                --camp-accent-2: #22c55e;
                --camp-ice: #e0f2f1;
            }
            .camp-header {
                background: linear-gradient(135deg, var(--camp-forest), var(--camp-forest-2));
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
            }
            .camp-title {
                color: #f1f5f9;
                text-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
            }
            .camp-day {
                background: rgba(255, 255, 255, 0.05);
                color: #e2e8f0;
                border-color: rgba(255, 255, 255, 0.07);
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
            }
            .camp-day-active {
                background: linear-gradient(145deg, var(--camp-accent), #facc15);
                color: #0f172a;
                border-color: rgba(255, 255, 255, 0.9);
                box-shadow: 0 14px 28px rgba(245, 158, 11, 0.25);
            }
            .camp-day-inactive:hover {
                background: rgba(255, 255, 255, 0.1);
                color: #f8fafc;
            }
            .camp-day-add {
                border-color: rgba(255, 255, 255, 0.28);
                color: rgba(255, 255, 255, 0.78);
            }
            .camp-day-add:hover {
                border-color: var(--camp-accent);
                color: #fff;
                background: rgba(245, 158, 11, 0.18);
            }
            .camp-chip {
                background: rgba(255, 255, 255, 0.08);
                color: #cbd5e1;
                border-color: rgba(255, 255, 255, 0.12);
            }
            .camp-chip span {
                color: #e2e8f0;
            }
            .camp-toggle {
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
            }
            .camp-toggle-btn {
                color: #cbd5e1;
            }
            .camp-toggle-btn-active {
                background: linear-gradient(135deg, var(--camp-accent), #fbbf24);
                color: #0f172a !important;
                box-shadow: 0 10px 22px rgba(245, 158, 11, 0.28);
            }
            .plan-surface {
                background: linear-gradient(180deg, #666666 0%, #888888 100%);
            }
            html,
            body {
                font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif;
                background: linear-gradient(180deg, #0b1723, #0e1f30 40%, #0f172a 100%);
                margin: 0;
                min-height: 100vh;
            }
            .main-surface {
                background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(15, 23, 42, 0.15));
            }
            /* ÁßªÈô§ÂÆπÂô®Â§ñÊ°ÜÁôΩÈÇä */
            #app {
                border: none !important;
                background: transparent;
            }
            .hide-scroll::-webkit-scrollbar {
                display: none;
            }
            .hide-scroll {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .fade-enter-active,
            .fade-leave-active {
                transition: opacity 0.3s ease;
            }
            .fade-enter-from,
            .fade-leave-to {
                opacity: 0;
            }
            #map-container {
                z-index: 1;
            }
            .gps-pulse {
                width: 14px;
                height: 14px;
                border: 2px solid #fff;
                border-radius: 50%;
                background-color: #3b82f6;
                box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
                animation: pulse-blue 2s infinite;
            }
            @keyframes pulse-blue {
                0% {
                    box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
                }
            }
            .leaflet-popup-content-wrapper {
                border-radius: 12px;
                padding: 0;
                overflow: hidden;
            }
            .leaflet-popup-content {
                margin: 0;
                width: 200px !important;
            }
            @keyframes fade-in-up {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            .animate-fade-in {
                animation: fade-in-up 0.4s ease-out forwards;
            }
            .time-picker-button {
                position: absolute;
                inset: 0;
                width: 100%;
                height: 100%;
                z-index: 2;
                cursor: pointer;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 2px;
                background: transparent;
                border: none;
                padding: 0;
            }
            .time-picker-period {
                font-size: 13px;
                font-weight: 500;
                color: rgb(148, 163, 184);
            }
            .time-picker-time {
                font-size: 15px;
                font-weight: bold;
                color: rgb(51, 65, 184);
                font-family: monospace;
                line-height: 1;
            }
            .destination-text {
                max-width: 200px;
                overflow: hidden;
                white-space: nowrap;
                display: inline-block;
                transition: font-size 0.2s ease;
            }
            @media (max-width: 400px) {
                .destination-text {
                    max-width: 140px;
                }
            }
        </style>
    </head>
    <body class="text-slate-700 h-screen flex flex-col overflow-hidden">
        <div
            id="app"
            class="flex flex-col h-full max-w-md mx-auto w-full bg-white shadow-2xl relative sm:rounded-xl sm:my-4 sm:h-[95vh] sm:border-4 sm:border-slate-100"
        >
            <!-- Header -->
            <header class="camp-header text-white shrink-0 z-20 shadow-md">
                <div class="p-4 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <!-- ÂÅ¥ÈÇäÊ¨ÑÈÅ∏ÂñÆÊåâÈàï -->
                        <button @click="showTripMenu = true" class="text-teal-100 hover:text-white transition">
                            <i class="ph-bold ph-list text-2xl"></i>
                        </button>
                        <div class="overflow-hidden flex-1">
                            <h1 class="text-xl font-bold tracking-wide flex items-center gap-2 truncate">
                                <span v-if="!isEditingTitle" class="flex items-center gap-2 truncate min-w-0">
                                    <span class="destination-text camp-title" ref="titleTextRef"
                                        >{{ setup.title || 'ÊóÖÈÅäË®àÁï´' }}</span
                                    >
                                    <button
                                        @click="startEditTitle"
                                        class="w-5 h-5 flex items-center justify-center text-teal-100 hover:text-white hover:bg-white/20 rounded transition-all cursor-pointer shrink-0"
                                        title="Á∑®ËºØÊ®ôÈ°å"
                                    >
                                        <i class="ph-bold ph-pencil-simple text-xs"></i>
                                    </button>
                                </span>
                                <div v-else class="flex items-center gap-2 flex-1 min-w-0">
                                    <input
                                        v-model="editingTitleValue"
                                        @blur="saveTitle"
                                        @keyup.enter="saveTitle"
                                        @keyup.esc="cancelEditTitle"
                                        class="flex-1 bg-teal-700 text-white border border-teal-500 rounded px-2 py-1 text-lg font-bold focus:outline-none focus:ring-2 focus:ring-white/50 min-w-0"
                                        placeholder="Ëº∏ÂÖ•ÊóÖÈÅäÊ®ôÈ°å"
                                        ref="titleInputRef"
                                    />
                                    <button
                                        @click="saveTitle"
                                        class="w-6 h-6 flex items-center justify-center text-teal-100 hover:text-white hover:bg-white/20 rounded transition-all cursor-pointer shrink-0"
                                        title="ÂÑ≤Â≠ò"
                                    >
                                        <i class="ph-bold ph-check text-sm"></i>
                                    </button>
                                    <button
                                        @click="cancelEditTitle"
                                        class="w-6 h-6 flex items-center justify-center text-teal-100 hover:text-white hover:bg-white/20 rounded transition-all cursor-pointer shrink-0"
                                        title="ÂèñÊ∂à"
                                    >
                                        <i class="ph-bold ph-x text-sm"></i>
                                    </button>
                                </div>
                                <i v-if="!isEditingTitle" class="ph-fill ph-airplane-tilt text-sm opacity-70"></i>
                                <!-- Ë§áË£ΩÈÇÄË´ãÁ¢ºÊåâÈàïÔºàÂÉÖÈõ≤Á´ØÊóÖÁ®ãÈ°ØÁ§∫Ôºâ -->
                                <button
                                    v-if="isCloudTrip && inviteCode && !isEditingTitle"
                                    @click="copyInviteCode"
                                    class="ml-1 w-6 h-6 flex items-center justify-center text-teal-100 hover:text-white hover:bg-white/20 rounded transition-all cursor-pointer shrink-0"
                                    title="Ë§áË£ΩÈÇÄË´ãÁ¢º"
                                >
                                    <i class="ph-bold ph-copy text-sm"></i>
                                </button>
                            </h1>
                            <!-- ÂúãÂÆ∂/Âú∞ÈªûÁ∑®ËºØÔºàÁßªËá≥Ê®ôÈ°å‰∏ãÊñπÔºâ -->
                            <div class="flex items-center gap-2 text-xs text-teal-50 mt-1">
                                <i class="ph-bold ph-map-pin text-[11px] opacity-70"></i>
                                <div class="flex-1 min-w-0">
                                    <span v-if="!isEditingDestination" class="inline-flex items-center gap-2">
                                        <span class="truncate">{{ setup.destination || 'Ëº∏ÂÖ•ÂúãÂÆ∂ / Âú∞Èªû' }}</span>
                                        <button
                                            @click="startEditDestination"
                                            class="w-5 h-5 flex items-center justify-center text-teal-100 hover:text-white hover:bg-white/20 rounded transition-all cursor-pointer shrink-0"
                                            title="Á∑®ËºØÂúãÂÆ∂/Âú∞Èªû"
                                        >
                                            <i class="ph-bold ph-pencil-simple text-[10px]"></i>
                                        </button>
                                    </span>
                                    <div v-else class="flex items-center gap-2">
                                        <input
                                            v-model="editingDestinationValue"
                                            @blur="saveDestination"
                                            @keyup.enter="saveDestination"
                                            @keyup.esc="cancelEditDestination"
                                            class="flex-1 bg-white/10 text-white border border-white/30 rounded px-2 py-1 text-xs font-bold focus:outline-none focus:ring-2 focus:ring-white/50 min-w-0"
                                            placeholder="Ëº∏ÂÖ•ÂúãÂÆ∂ / Âú∞ÈªûÔºàÁî®ÊñºÂ§©Ê∞£„ÄÅÂåØÁéá„ÄÅË™ûË®ÄÔºâ"
                                            ref="destinationInputRef"
                                        />
                                        <button
                                            @click="saveDestination"
                                            class="w-6 h-6 flex items-center justify-center text-teal-100 hover:text-white hover:bg-white/20 rounded transition-all cursor-pointer shrink-0"
                                            title="ÂÑ≤Â≠ò"
                                        >
                                            <i class="ph-bold ph-check text-[11px]"></i>
                                        </button>
                                        <button
                                            @click="cancelEditDestination"
                                            class="w-6 h-6 flex items-center justify-center text-teal-100 hover:text-white hover:bg-white/20 rounded transition-all cursor-pointer shrink-0"
                                            title="ÂèñÊ∂à"
                                        >
                                            <i class="ph-bold ph-x text-[11px]"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- <p class="text-xs text-teal-100 mt-0.5 font-light tracking-wider truncate">
                                ÈªûÊìä‰∏ãÊñπÊó•ÊúüÂàáÊèõË°åÁ®ã
                            </p> -->
                        </div>
                    </div>
                    <div class="flex items-center gap-2 shrink-0">
                        <div class="flex camp-toggle p-1 rounded-xl">
                            <button
                                @click="viewMode = 'plan'"
                                :class="viewMode === 'plan' ? 'camp-toggle-btn-active' : 'camp-toggle-btn'"
                                class="p-2 rounded-lg transition-all"
                            >
                                <i class="ph-bold ph-calendar-check text-lg"></i>
                            </button>
                            <button
                                @click="viewMode = 'map'"
                                :class="viewMode === 'map' ? 'camp-toggle-btn-active' : 'camp-toggle-btn'"
                                class="p-2 rounded-lg transition-all"
                            >
                                <i class="ph-bold ph-map-trifold text-lg"></i>
                            </button>
                            <button
                                @click="viewMode = 'money'"
                                :class="viewMode === 'money' ? 'camp-toggle-btn-active' : 'camp-toggle-btn'"
                                class="p-2 rounded-lg transition-all"
                            >
                                <i class="ph-bold ph-currency-dollar text-lg"></i>
                            </button>
                            <!-- ÁøªË≠ØÂäüËÉΩÊåâÈàï -->
                            <button
                                @click="viewMode = 'translate'"
                                :class="viewMode === 'translate' ? 'camp-toggle-btn-active' : 'camp-toggle-btn'"
                                class="p-2 rounded-lg transition-all"
                            >
                                <i class="ph-bold ph-translate text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex overflow-x-auto hide-scroll px-2 pb-3 space-x-3 snap-x">
                    <div
                        v-for="(day, index) in days"
                        :key="index"
                        @click="currentDayIdx = index"
                        class="snap-center shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-xl cursor-pointer transition-all border-2 camp-day"
                        :class="currentDayIdx === index ? 'camp-day-active scale-105' : 'camp-day-inactive'"
                    >
                        <span class="text-xs font-medium opacity-80">{{ day.shortDate }}</span>
                        <span class="text-lg font-bold">D{{ index }}</span>
                    </div>
                    <button
                        @click="addDay"
                        class="shrink-0 w-12 h-16 rounded-xl flex items-center justify-center border-2 border-dashed camp-day-add transition"
                    >
                        <i class="ph-bold ph-plus"></i>
                    </button>
                </div>
            </header>

            <!-- Main Content -->
            <main class="flex-1 overflow-y-auto relative hide-scroll main-surface">
                <!-- Ë°åÁ®ãË°® (Plan View) -->
                <transition name="fade" mode="out-in">
                    <div v-if="viewMode === 'plan'" :key="currentDayIdx" class="p-4 pb-24 plan-surface">
                        <div
                            class="bg-white p-4 rounded-2xl shadow-sm mb-4 border border-slate-100 flex justify-between items-start"
                        >
                            <div class="flex-1 relative pt-0.5">
                                <!-- Èö±ÂΩ¢Êó•ÊúüÈÅ∏ÊìáÂô®ÔºàÂÆåÂÖ®Ë¶ÜËìãÊï¥ÂÄãÊó•ÊúüÂçÄÂüüÔºâ -->
                                <input
                                    type="date"
                                    :value="currentDay.fullDate"
                                    @change="updateDate($event, currentDay)"
                                    class="absolute top-0 left-0 right-0 bottom-0 w-full opacity-0 z-30 cursor-pointer"
                                    style="height: 100%; min-height: 80px"
                                />
                                <!-- Êó•ÊúüÈ°ØÁ§∫ -->
                                <div class="relative z-10 pointer-events-none">
                                    <input
                                        v-model="currentDay.date"
                                        class="text-xl font-bold text-slate-800 bg-transparent border-none p-0 focus:ring-0 w-full"
                                        placeholder="Day 1 (ÈªûÊìäË®≠ÂÆö)"
                                        readonly
                                    />
                                    <input
                                        v-model="currentDay.title"
                                        class="text-sm text-slate-500 bg-transparent border-b border-dashed border-slate-300 focus:border-teal-500 focus:outline-none w-full mt-1"
                                        placeholder="Ëº∏ÂÖ•Áï∂Êó•‰∏ªÈ°å"
                                        readonly
                                    />
                                </div>
                            </div>
                            <!-- Â§©Ê∞£È°ØÁ§∫ -->
                            <div class="flex flex-col items-end pl-2">
                                <div v-if="weatherDisplay" class="text-right">
                                    <div class="flex items-center justify-end gap-1 text-indigo-600">
                                        <i :class="['ph-duotone', weatherDisplay.icon, 'text-2xl']"></i>
                                        <span class="text-xl font-bold font-mono whitespace-nowrap"
                                            >{{ weatherDisplay.temp }}</span
                                        >
                                    </div>
                                    <div class="text-[10px] text-slate-400 flex items-center gap-1 justify-end mt-0.5">
                                        <i
                                            :class="weatherDisplay.isForecast ? 'ph-bold ph-calendar' : 'ph-bold ph-map-pin'"
                                        ></i>
                                        {{ weatherDisplay.label }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ëà™Áè≠Âç°Áâá (ÁôªÊ©üË≠âÊ®£Âºè) -->
                        <div class="mb-6">
                            <div
                                v-if="currentDay.flight"
                                class="relative bg-gradient-to-r from-blue-600 to-teal-500 rounded-2xl text-white shadow-lg overflow-hidden"
                            >
                                <div
                                    class="absolute -left-3 top-1/2 -translate-y-1/2 w-6 h-6 rounded-full z-10"
                                    style="background: #666666"
                                ></div>
                                <div
                                    class="absolute -right-3 top-1/2 -translate-y-1/2 w-6 h-6 rounded-full z-10"
                                    style="background: #666666"
                                ></div>
                                <div class="p-4 relative z-0">
                                    <button
                                        @click="toggleFlightCard"
                                        class="absolute top-2 right-2 text-white/50 hover:text-white hover:bg-white/20 rounded-full p-1 transition"
                                    >
                                        <i class="ph-bold ph-x"></i>
                                    </button>
                                    <div class="flex justify-between items-center mb-1 pt-2">
                                        <!-- Âá∫Áôº -->
                                        <div class="flex flex-col items-center w-1/3">
                                            <input
                                                v-model="currentDay.flight.startTime"
                                                type="time"
                                                class="text-2xl font-black bg-transparent border-b border-white/30 w-full text-center text-white placeholder-white/50 focus:outline-none focus:border-white font-mono p-0"
                                            />
                                            <div class="text-[9px] opacity-60 mt-1">Ëµ∑È£õ (Áï∂Âú∞ÊôÇÈñì)</div>
                                            <input
                                                v-model="currentDay.flight.startAirport"
                                                class="text-sm font-bold opacity-90 bg-transparent border-none text-center w-full text-teal-100 placeholder-white/50 focus:ring-0 uppercase p-0"
                                                placeholder="TPE"
                                            />
                                        </div>
                                        <!-- Ë≥áË®ä -->
                                        <div class="flex flex-col items-center justify-center w-1/3 px-2">
                                            <i class="ph-fill ph-airplane text-2xl mb-1 transform rotate-90"></i>
                                            <input
                                                v-model="currentDay.flight.number"
                                                class="text-[10px] font-mono tracking-widest opacity-80 bg-transparent border-none text-center w-full text-white placeholder-white/50 focus:ring-0 uppercase p-0"
                                                placeholder="BR198"
                                            />
                                            <div class="w-full h-0.5 bg-white/30 rounded-full mt-1"></div>
                                        </div>
                                        <!-- ÊäµÈÅî -->
                                        <div class="flex flex-col items-center w-1/3">
                                            <input
                                                v-model="currentDay.flight.endTime"
                                                type="time"
                                                class="text-2xl font-black bg-transparent border-b border-white/30 w-full text-center text-white placeholder-white/50 focus:outline-none focus:border-white font-mono p-0"
                                            />
                                            <div class="relative w-full mt-0.5">
                                                <select
                                                    v-model="currentDay.flight.arrivalOffset"
                                                    class="appearance-none bg-black/20 text-white text-[9px] rounded border-none w-full py-0.5 px-1 text-center focus:ring-0 cursor-pointer hover:bg-black/30"
                                                >
                                                    <option value="0" class="text-slate-800">ÂêåÊó•ÊäµÈÅî</option>
                                                    <option value="1" class="text-slate-800">+1Â§© (ÈöîÊó•)</option>
                                                    <option value="-1" class="text-slate-800">-1Â§© (ÂâçÊó•)</option>
                                                </select>
                                                <div
                                                    v-if="currentDay.flight.arrivalOffset != 0"
                                                    class="absolute -top-8 right-0 bg-red-500 text-white text-[9px] px-1.5 py-0.5 rounded shadow font-bold animate-pulse"
                                                >
                                                    {{ currentDay.flight.arrivalOffset > 0 ? '+1' : '-1' }}
                                                </div>
                                            </div>
                                            <input
                                                v-model="currentDay.flight.endAirport"
                                                class="text-sm font-bold opacity-90 bg-transparent border-none text-center w-full text-teal-100 placeholder-white/50 focus:ring-0 uppercase p-0"
                                                placeholder="NRT"
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button
                                v-else
                                @click="toggleFlightCard"
                                class="w-full py-3 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 hover:border-teal-400 hover:text-teal-500 hover:bg-teal-50/50 transition flex items-center justify-center gap-2 group"
                            >
                                <i
                                    class="ph-bold ph-airplane-tilt text-lg group-hover:scale-110 transition-transform"
                                ></i>
                                <span class="text-sm font-bold">Êñ∞Â¢ûÁï∂Êó•Ëà™Áè≠Ë≥áË®ä</span>
                            </button>
                        </div>

                        <div class="relative pl-4 border-l-2 border-teal-100 space-y-8">
                            <div v-for="(item, idx) in currentDay.items" :key="idx" class="relative group">
                                <div
                                    class="absolute -left-[21px] top-3 w-3 h-3 rounded-full border-2 border-white shadow-sm"
                                    :class="getDotColor(item.type)"
                                ></div>
                                <div
                                    class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow"
                                >
                                    <div class="flex flex-col gap-2">
                                        <div class="flex items-start gap-3">
                                            <!-- ÊôÇÈñìËº∏ÂÖ•Â°ä -->
                                            <div class="flex flex-col items-center w-20 shrink-0 gap-2">
                                                <div
                                                    class="relative flex flex-col items-center justify-center bg-slate-50 border border-slate-200 rounded-xl p-1 w-full h-16 cursor-pointer hover:bg-teal-50 hover:border-teal-200 transition group/time"
                                                >
                                                    <input
                                                        v-model="item.time"
                                                        type="time"
                                                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-0"
                                                    />
                                                    <button @click="openTimePickerFromEvent" class="time-picker-button">
                                                        <span class="time-picker-period">
                                                            {{ getTimePeriod(item.time) }}
                                                        </span>
                                                        <span class="time-picker-time">
                                                            {{ item.time || 'ÈÅ∏ÊìáÊôÇÈñì üïí' }}
                                                        </span>
                                                    </button>
                                                </div>
                                                <select
                                                    v-model="item.type"
                                                    class="text-[10px] bg-white border border-slate-200 rounded-md py-1 px-1 w-full text-center"
                                                >
                                                    <option value="spot">üìç ÊôØÈªû</option>
                                                    <option value="food">üç¥ ÁæéÈ£ü</option>
                                                    <option value="shop">üõçÔ∏è Ë≥ºÁâ©</option>
                                                    <option value="transport">üöá ‰∫§ÈÄö</option>
                                                    <option value="flight">‚úàÔ∏è Ëà™Áè≠</option>
                                                </select>
                                            </div>
                                            <!-- ÂÖßÂÆπËº∏ÂÖ• -->
                                            <div class="flex-1 min-w-0 pt-1">
                                                <input
                                                    v-model="item.activity"
                                                    class="block w-full font-bold text-slate-800 bg-transparent border-none p-0 focus:ring-0"
                                                    placeholder="Ë°åÁ®ãÂêçÁ®±..."
                                                />
                                                <div class="flex items-center gap-1 mt-1">
                                                    <i class="ph-fill ph-map-pin text-teal-400 text-xs"></i>
                                                    <input
                                                        v-model="item.location"
                                                        class="flex-1 text-xs text-slate-500 bg-transparent border-none p-0 focus:ring-0 truncate"
                                                        placeholder="Ëº∏ÂÖ•Âú∞Èªû (‰æãÂ¶Ç: Êñ∞ÂÆø)"
                                                    />
                                                </div>
                                                <div class="flex items-center gap-1 mt-1">
                                                    <i class="ph-bold ph-info text-orange-400 text-xs"></i>
                                                    <input
                                                        v-model="item.note"
                                                        class="flex-1 text-xs text-orange-600/90 bg-transparent border-none p-0 focus:ring-0 truncate"
                                                        placeholder="ÂÇôË®ª"
                                                    />
                                                </div>
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <a
                                                    :href="getGoogleMapLink(item.location)"
                                                    target="_blank"
                                                    class="text-teal-500 hover:bg-teal-50 p-1 rounded"
                                                    ><i class="ph-bold ph-navigation-arrow"></i
                                                ></a>
                                                <button
                                                    @click="removeItem(idx)"
                                                    class="text-red-300 hover:text-red-500 p-1 rounded"
                                                >
                                                    <i class="ph-bold ph-trash"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Êô∫ÊÖßÊé®Ëñ¶ÂçÄ (ÂÉÖÁæéÈ£ü) -->
                                        <div
                                            v-if="item.type === 'food'"
                                            class="p-2 bg-orange-50 rounded-lg border border-orange-100/50 mt-1"
                                        >
                                            <div class="flex items-center justify-between mb-1">
                                                <p
                                                    class="text-[10px] font-bold text-orange-400 flex items-center gap-1"
                                                >
                                                    <i class="ph-fill ph-fork-knife"></i> ÁæéÈ£üÊé®Ëñ¶
                                                </p>
                                                <button
                                                    @click="searchNearby(item, idx)"
                                                    class="text-[10px] text-teal-600 hover:text-teal-800 flex items-center gap-1 bg-white px-2 py-0.5 rounded border border-teal-100 shadow-sm"
                                                    :disabled="!item.location"
                                                >
                                                    <i
                                                        v-if="isSearchingRecs && searchTargetIndex === `${currentDayIdx}-${idx}`"
                                                        class="ph-bold ph-spinner animate-spin"
                                                    ></i>
                                                    <i v-else class="ph-bold ph-magnifying-glass"></i>
                                                    ÊêúÂ∞ã
                                                </button>
                                            </div>

                                            <div
                                                v-if="recommendationsMap[`${currentDayIdx}-${idx}`] && recommendationsMap[`${currentDayIdx}-${idx}`].length > 0"
                                                class="flex flex-wrap gap-2 mt-1"
                                            >
                                                <button
                                                    v-for="rec in recommendationsMap[`${currentDayIdx}-${idx}`]"
                                                    :key="rec.name"
                                                    @click="applyRecommendation(item, rec)"
                                                    class="text-[10px] px-2 py-1.5 bg-white border border-orange-200 rounded-lg text-slate-600 hover:bg-orange-500 hover:text-white hover:border-orange-500 transition shadow-sm flex flex-col items-start gap-0.5 max-w-[120px] truncate"
                                                >
                                                    <span class="font-bold truncate w-full text-left"
                                                        >{{ rec.name }}</span
                                                    >
                                                </button>
                                            </div>
                                            <div v-else-if="!item.location" class="text-[9px] text-slate-400 italic">
                                                Ë´ãÂÖàËº∏ÂÖ•Âú∞Èªû (‰æãÂ¶Ç: ÊæÄË∞∑)ÔºåÂÜçÈªûÊìäÊêúÂ∞ã
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button
                                @click="addItem"
                                class="flex items-center gap-2 text-teal-400 hover:text-teal-600 text-sm font-medium px-2 py-1"
                            >
                                <div class="w-2 h-2 bg-teal-300 rounded-full"></div>
                                <i class="ph-bold ph-plus"></i> Êñ∞Â¢ûË°åÁ®ã
                            </button>
                        </div>
                        <div class="mt-12 pt-6 border-t border-slate-200 text-center">
                            <button
                                @click="removeCurrentDay"
                                class="text-xs text-red-300 hover:text-red-500 flex items-center justify-center gap-1 mx-auto"
                            >
                                <i class="ph-bold ph-trash"></i> Âà™Èô§ÈÄô‰∏ÄÂ§©
                            </button>
                        </div>
                    </div>
                </transition>

                <!-- Âú∞ÂúñË¶ñÂúñ -->
                <div v-if="viewMode === 'map'" class="h-full flex flex-col relative">
                    <div id="map" class="flex-1 w-full h-full bg-slate-200 z-0"></div>
                    <div
                        v-if="isMapLoading"
                        class="absolute inset-0 bg-white/50 backdrop-blur-sm z-10 flex flex-col items-center justify-center text-teal-600"
                    >
                        <i class="ph-duotone ph-spinner animate-spin text-4xl mb-2"></i
                        ><span class="text-xs font-bold">ËÆÄÂèñ‰∏≠...</span>
                    </div>
                    <div
                        class="absolute bottom-4 left-4 right-4 bg-white/90 backdrop-blur rounded-xl p-3 shadow-lg border border-white/50 z-10 flex justify-between items-center"
                    >
                        <div class="text-sm font-bold text-slate-800">
                            üìç {{ currentDay.items.filter(i=>i.location).length }} ÂÄãÂú∞Èªû
                        </div>
                        <div class="flex gap-2">
                            <button @click="initMap" class="p-2 bg-teal-100 text-teal-600 rounded-lg">
                                <i class="ph-bold ph-arrows-clockwise"></i>
                            </button>
                            <button @click="centerOnUser" class="p-2 bg-blue-500 text-white rounded-lg shadow-md">
                                <i class="ph-bold ph-crosshair"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ÂàÜÂ∏≥Ë¶ñÂúñ -->
                <div v-if="viewMode === 'money'" class="p-4 pb-24 plan-surface">
                    <div class="bg-teal-600 text-white rounded-2xl p-6 shadow-lg mb-6 text-center relative">
                        <div class="absolute top-4 right-4 flex flex-col items-end gap-2 z-10">
                            <!-- ÂÄã‰∫∫/Â§ö‰∫∫Ë®òÂ∏≥ÂàáÊèõÊåâÈàï -->
                            <button
                                @click="isPersonalMode = !isPersonalMode"
                                :class="isPersonalMode ? 'bg-white text-teal-600' : 'bg-teal-500/30 text-white'"
                                class="relative z-20 px-3 py-1.5 rounded-lg text-xs font-bold transition-all shadow-sm hover:bg-teal-500/50 flex items-center gap-1.5 cursor-pointer"
                                title="ÂàáÊèõÂÄã‰∫∫/Â§ö‰∫∫Ë®òÂ∏≥Ê®°Âºè"
                            >
                                <i :class="isPersonalMode ? 'ph-bold ph-user' : 'ph-bold ph-users'"></i>
                                <span>{{ isPersonalMode ? 'ÂÄã‰∫∫' : 'Â§ö‰∫∫' }}</span>
                            </button>
                            <!-- ÂåØÁéáËº∏ÂÖ• -->
                            <div class="flex flex-col items-end relative z-10">
                                <label class="text-[10px] text-teal-200 mb-1">ÂåØÁéá ({{ currencyLabel }})</label>
                                <input
                                    v-model.number="exchangeRate"
                                    type="number"
                                    step="0.001"
                                    class="w-16 text-right text-xs text-teal-900 rounded px-1 py-0.5"
                                />
                            </div>
                        </div>
                        <div class="text-sm opacity-80 mb-1">{{ isPersonalMode ? 'ÂÄã‰∫∫Á∏ΩÊîØÂá∫' : 'Á∏ΩÊîØÂá∫ Total' }}</div>
                        <div class="text-4xl font-bold font-mono">
                            {{ currencySymbol }} {{ totalExpense.toLocaleString() }}
                        </div>
                        <div class="text-lg font-bold text-teal-200 mt-1">
                            ‚âà NT$ {{ Math.round(totalExpense * exchangeRate).toLocaleString() }}
                        </div>
                    </div>
                    <!-- ÊàêÂì°Ë®≠ÂÆöÔºàÂÉÖÂ§ö‰∫∫Ë®òÂ∏≥Ê®°ÂºèÈ°ØÁ§∫Ôºâ -->
                    <div v-if="!isPersonalMode" class="mb-4 bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                        <div class="text-xs font-bold text-slate-400 mb-2">ÂàÜÂ∏≥ÊàêÂì° (Áî®ÈÄóËôüÂàÜÈöî)</div>
                        <input
                            v-model="participantsStr"
                            @change="updateParticipants"
                            class="w-full text-sm bg-slate-50 rounded px-2 py-1 border border-slate-200"
                            placeholder="‰æãÂ¶Ç: Êàë, ÊúãÂèãA, ÊúãÂèãB"
                        />
                    </div>
                    <div v-if="!isPersonalMode" class="grid grid-cols-2 gap-2 mb-6">
                        <div
                            v-for="p in participants"
                            :key="p"
                            class="bg-white p-3 rounded-xl border border-slate-100 text-center shadow-sm"
                        >
                            <div class="text-xs text-slate-400 mb-1">{{ p }}</div>
                            <!-- Â¢ä‰ªòÈáëÈ°ç -->
                            <div class="text-xs text-slate-500 mb-0.5">Â¢ä‰ªò</div>
                            <div class="text-sm font-bold text-teal-600 mb-1">
                                {{ currencySymbol }}{{ paidByPerson[p]?.toLocaleString() || 0 }}
                            </div>
                            <!-- Êáâ‰ªòÈáëÈ°ç -->
                            <div class="text-xs text-slate-500 mb-0.5">Êáâ‰ªò</div>
                            <div class="text-sm font-bold text-slate-600 mb-1">
                                {{ currencySymbol }}{{ Math.round(owedByPerson[p] || 0).toLocaleString() }}
                            </div>
                            <!-- Ê∑®È°çÔºàÂ¢ä‰ªò - Êáâ‰ªòÔºâ -->
                            <div class="border-t border-slate-200 pt-1 mt-1">
                                <div class="text-[10px] text-slate-400 mb-0.5">Ê∑®È°ç</div>
                                <div
                                    :class="
                                        (paidByPerson[p] || 0) - (owedByPerson[p] || 0) > 0
                                            ? 'text-red-600 font-bold'
                                            : (paidByPerson[p] || 0) - (owedByPerson[p] || 0) < 0
                                            ? 'text-teal-600 font-bold'
                                            : 'text-slate-500 font-bold'
                                    "
                                    class="text-sm"
                                >
                                    {{ (paidByPerson[p] || 0) - (owedByPerson[p] || 0) > 0 ? '+' : (paidByPerson[p] ||
                                    0) - (owedByPerson[p] || 0) < 0 ? '' : '' }}{{ currencySymbol }}{{ Math.abs(
                                    Math.round((paidByPerson[p] || 0) - (owedByPerson[p] || 0)) ).toLocaleString() }}
                                </div>
                                <div
                                    v-if="(paidByPerson[p] || 0) - (owedByPerson[p] || 0) > 0"
                                    class="text-[9px] text-red-500 mt-0.5"
                                >
                                    ÊáâÊî∂
                                </div>
                                <div
                                    v-else-if="(paidByPerson[p] || 0) - (owedByPerson[p] || 0) < 0"
                                    class="text-[9px] text-teal-500 mt-0.5"
                                >
                                    Êáâ‰ªò
                                </div>
                                <div v-else class="text-[9px] text-slate-400 mt-0.5">Â∑≤ÁµêÊ∏Ö</div>
                            </div>
                        </div>
                    </div>
                    <div
                        v-if="!isPersonalMode && settlementPlan.length > 0"
                        class="bg-teal-50 rounded-xl p-4 mb-6 border border-teal-100"
                    >
                        <h3 class="text-xs font-bold text-teal-400 uppercase tracking-wide mb-3">ÁµêÂ∏≥Âª∫Ë≠∞</h3>
                        <div class="space-y-2">
                            <div
                                v-for="(plan, idx) in settlementPlan"
                                :key="idx"
                                class="flex items-center justify-between text-sm bg-white p-2 rounded-lg shadow-sm"
                            >
                                <span class="font-bold text-slate-600"
                                    >{{ plan.from }} <i class="ph-bold ph-arrow-right text-xs"></i> {{ plan.to }}</span
                                >
                                <span class="font-mono font-bold text-teal-600"
                                    >{{ currencySymbol }}{{ plan.amount.toLocaleString() }}</span
                                >
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-slate-100">
                        <div class="flex gap-2 mb-2">
                            <input
                                v-model="newExpense.item"
                                placeholder="È†ÖÁõÆ"
                                class="flex-1 bg-slate-50 border-none rounded-lg text-sm px-3 py-2"
                            />
                            <select
                                v-if="!isPersonalMode"
                                v-model="newExpense.payer"
                                class="w-[120px] bg-slate-50 border-none rounded-lg text-sm px-2 py-2 min-w-0"
                            >
                                <option v-for="p in participants" :value="p">{{ p }}</option>
                            </select>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <input
                                v-model="newExpense.time"
                                type="datetime-local"
                                placeholder="ÊôÇÈñìÔºàÈÅ∏Â°´Ôºâ"
                                class="flex-1 bg-slate-50 border-none rounded-lg text-sm px-3 py-2"
                            />
                        </div>
                        <div class="flex gap-2">
                            <input
                                v-model.number="newExpense.amount"
                                type="number"
                                :placeholder="currencySymbol + ' ÈáëÈ°ç'"
                                class="w-full bg-slate-50 border-none rounded-lg text-sm pl-3 pr-3 py-2 font-mono"
                            />
                            <button
                                v-if="!isPersonalMode"
                                @click="selectAllSplits"
                                class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-xs font-bold border border-slate-200"
                                title="ÂÖ®ÈÅ∏ÂàÜÊî§ÊàêÂì°"
                            >
                                ÂÖ®ÈÅ∏
                            </button>
                            <button
                                @click="addExpense"
                                class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-bold"
                            >
                                <i class="ph-bold ph-plus"></i>
                            </button>
                        </div>
                        <div v-if="!isPersonalMode" class="bg-slate-50 rounded-lg border border-slate-200 p-3 mt-2">
                            <div class="text-[11px] text-slate-500 font-bold mb-2">ÂàÜÊî§ÊàêÂì°</div>
                            <div class="flex flex-wrap gap-2">
                                <label
                                    v-for="p in participants"
                                    :key="p"
                                    class="flex items-center gap-1 bg-white border border-slate-200 rounded-full px-3 py-1 text-xs text-slate-700 shadow-sm"
                                >
                                    <input
                                        type="checkbox"
                                        v-model="newExpense.splitParticipants"
                                        :value="p"
                                        class="accent-teal-600"
                                    />
                                    {{ p }}
                                </label>
                            </div>
                            <div v-if="newExpense.splitParticipants.length === 0" class="text-[10px] text-red-500 mt-2">
                                Ëã•Êú™ÈÅ∏ÊìáÔºåÂ∞áËá™Âãï‰ΩøÁî®ÂÖ®È´îÊàêÂì°ÂàÜÊî§
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div
                            v-for="(exp, idx) in currentExpenses"
                            :key="idx"
                            class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm"
                        >
                            <div class="flex items-center gap-3">
                                <div
                                    v-if="!isPersonalMode"
                                    class="w-8 h-8 rounded-full bg-teal-50 flex items-center justify-center text-teal-600 text-xs font-bold"
                                >
                                    {{ exp.payer.charAt(0) }}
                                </div>
                                <div
                                    v-else
                                    class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 text-xs font-bold"
                                >
                                    <i class="ph-bold ph-user"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-slate-700 text-sm">{{ exp.item }}</div>
                                    <div
                                        v-if="!isPersonalMode && exp.splitParticipants && exp.splitParticipants.length > 0"
                                        class="text-[11px] text-slate-400 mt-0.5"
                                    >
                                        ÂàÜÊî§Ôºö{{ exp.splitParticipants.join('„ÄÅ') }}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-mono font-bold text-slate-700"
                                    >{{ currencySymbol }}{{ exp.amount.toLocaleString() }}</span
                                >
                                <button @click="removeExpense(idx)" class="text-slate-300 hover:text-red-400">
                                    <i class="ph-fill ph-x-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÁøªË≠ØÂäüËÉΩ -->
                <div
                    v-if="viewMode === 'translate'"
                    class="p-6 h-full flex flex-col justify-center items-center pb-32 plan-surface"
                >
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Google ÁøªË≠ØÊç∑Âæë</h2>
                        <p class="text-sm text-slate-400">Ë´ãÈÅ∏ÊìáÊÇ®ÈúÄË¶ÅÁöÑÁøªË≠ØÊ®°Âºè</p>
                    </div>
                    <div class="w-full mb-4">
                        <a href="https://translate.google.com/?op=images" target="_blank" class="block w-full">
                            <button
                                class="w-full bg-gradient-to-br from-orange-400 to-red-500 text-white rounded-2xl p-6 shadow-lg active:scale-95 transition-transform relative overflow-hidden group"
                            >
                                <div class="relative z-10 flex items-center justify-between">
                                    <div class="text-left">
                                        <div class="text-xs opacity-80 mb-1 tracking-wider">ËèúÂñÆ / ÁúãÊùø</div>
                                        <div class="text-2xl font-bold">
                                            ÁÖßÁõ∏ÁøªË≠Ø <i class="ph-bold ph-camera text-sm"></i>
                                        </div>
                                    </div>
                                    <i
                                        class="ph-duotone ph-camera-plus text-3xl opacity-60 group-hover:opacity-100"
                                    ></i>
                                </div>
                            </button>
                        </a>
                    </div>
                    <div class="w-full mb-4">
                        <a
                            :href="`https://translate.google.com/?sl=zh-TW&tl=${setup.langCode}&op=translate`"
                            target="_blank"
                            class="block w-full"
                        >
                            <button
                                class="w-full bg-gradient-to-br from-indigo-500 to-blue-600 text-white rounded-2xl p-6 shadow-lg active:scale-95 transition-transform relative overflow-hidden group"
                            >
                                <div class="relative z-10 flex items-center justify-between">
                                    <div class="text-left">
                                        <div class="text-xs opacity-80 mb-1 tracking-wider">
                                            ÊàëË™™‰∏≠Êñá (ËΩâ{{ setup.langName }})
                                        </div>
                                        <div class="text-2xl font-bold">
                                            CH <i class="ph-bold ph-arrow-right text-sm"></i> {{
                                            setup.langCode.toUpperCase() }}
                                        </div>
                                    </div>
                                    <i
                                        class="ph-duotone ph-arrow-square-out text-3xl opacity-60 group-hover:opacity-100"
                                    ></i>
                                </div>
                            </button>
                        </a>
                    </div>
                    <div class="w-full">
                        <a
                            :href="`https://translate.google.com/?sl=${setup.langCode}&tl=zh-TW&op=translate`"
                            target="_blank"
                            class="block w-full"
                        >
                            <button
                                class="w-full bg-white border-2 border-slate-200 text-slate-700 rounded-2xl p-6 shadow-sm active:scale-95 transition-transform relative overflow-hidden group hover:border-indigo-300"
                            >
                                <div class="relative z-10 flex items-center justify-between">
                                    <div class="text-left">
                                        <div class="text-xs text-slate-400 mb-1 tracking-wider">
                                            Â∞çÊñπË™™{{ setup.langName }} (ËΩâ‰∏≠Êñá)
                                        </div>
                                        <div class="text-2xl font-bold font-jp">
                                            {{ setup.langCode.toUpperCase() }}
                                            <i class="ph-bold ph-arrow-right text-sm"></i> CH
                                        </div>
                                    </div>
                                    <i
                                        class="ph-duotone ph-arrow-square-out text-3xl text-slate-300 group-hover:text-indigo-500 transition-colors"
                                    ></i>
                                </div>
                            </button>
                        </a>
                    </div>
                </div>
            </main>

            <!-- ÂÅ¥ÈÇäÊ¨Ñ (ÊóÖÁ®ãÈÅ∏ÂñÆ) -->
            <transition name="slide">
                <div v-if="showTripMenu" class="fixed inset-0 z-50 flex">
                    <div class="bg-white w-4/5 max-w-xs h-full shadow-2xl flex flex-col relative z-50 p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-slate-800">ÊàëÁöÑÊóÖÁ®ã</h2>
                            <button @click="showTripMenu = false" class="text-slate-400 hover:text-slate-600">
                                <i class="ph-bold ph-x text-xl"></i>
                            </button>
                        </div>
                        <button
                            @click="createNewTrip"
                            class="w-full py-3 mb-3 border-2 border-dashed border-teal-400 text-teal-600 rounded-xl font-bold hover:bg-teal-50 flex items-center justify-center gap-2"
                        >
                            <i class="ph-bold ph-plus-circle"></i> Âª∫Á´ãÊñ∞ÊóÖÁ®ã
                        </button>
                        <button
                            @click="showTemplatePreview = true"
                            class="w-full py-3 mb-6 bg-gradient-to-r from-pink-500 to-orange-500 text-white rounded-xl font-bold hover:from-pink-600 hover:to-orange-600 flex items-center justify-center gap-2 shadow-lg transition-all transform hover:scale-105"
                        >
                            <i class="ph-bold ph-sparkle"></i> ËºâÂÖ•È†êË®≠Ë°åÁ®ãÊ®°Êùø
                        </button>
                        <div class="flex-1 overflow-y-auto space-y-3 hide-scroll">
                            <div
                                v-for="trip in tripList"
                                :key="trip.id"
                                class="p-4 rounded-xl border transition relative group"
                                :class="currentTripId === trip.id ? 'bg-teal-50 border-teal-500 shadow-sm' : 'bg-slate-50 border-transparent hover:bg-slate-100'"
                            >
                                <div @click="switchTrip(trip.id)" class="cursor-pointer">
                                    <div class="font-bold text-slate-800">{{ trip.destination || 'Êú™ÂëΩÂêçË°åÁ®ã' }}</div>
                                    <div class="text-xs text-slate-400 mt-1">
                                        {{ trip.startDate }} ‚Ä¢ {{ trip.daysCount }} Â§©
                                    </div>
                                </div>

                                <!-- Èõ≤Á´ØÂäüËÉΩÊåâÈàïÂçÄ -->
                                <div class="mt-3 flex gap-2" @click.stop>
                                    <!-- A: ‰∏äÂÇ≥Èõ≤Á´Ø (ÂßãÁµÇÈ°ØÁ§∫ÔºåËÆì‰ΩøÁî®ËÄÖÂèØ‰ª•Èö®ÊôÇ‰∏äÂÇ≥Áï∂Ââç‰øÆÊîπ) -->
                                    <button
                                        @click="handleUploadToCloud(trip.id)"
                                        :disabled="isUploading"
                                        class="flex-1 py-2 px-3 bg-teal-600 hover:bg-teal-700 text-white text-xs font-bold rounded-lg transition flex items-center justify-center gap-1.5 disabled:opacity-50"
                                    >
                                        <i
                                            v-if="isUploading && currentTripId === trip.id"
                                            class="ph-bold ph-spinner animate-spin"
                                        ></i>
                                        <i v-else class="ph-bold ph-cloud-arrow-up"></i>
                                        ‰∏äÂÇ≥Èõ≤Á´Ø
                                    </button>

                                    <!-- B: ÂêåÊ≠•Ë≥áË®ä (ÂÉÖÂ∑≤‰∏äÂÇ≥ÁöÑÊóÖÁ®ãÈ°ØÁ§∫ÔºåÂæû Firebase ÊãâÂèñË≥áÊñôË¶ÜËìãÊú¨Âú∞) -->
                                    <button
                                        v-if="getTripCloudStatus(trip.id)"
                                        @click="handleSyncFromCloud(trip.id)"
                                        :disabled="isSyncing"
                                        class="flex-1 py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold rounded-lg transition flex items-center justify-center gap-1.5 disabled:opacity-50"
                                    >
                                        <i
                                            v-if="isSyncing && currentTripId === trip.id"
                                            class="ph-bold ph-spinner animate-spin"
                                        ></i>
                                        <i v-else class="ph-bold ph-arrows-clockwise"></i>
                                        ÂêåÊ≠•
                                    </button>

                                    <!-- C: ÂàÜ‰∫´ÈÇÄË´ãÁ¢º (ÂÉÖÂ∑≤‰∏äÂÇ≥ÁöÑÊóÖÁ®ãÈ°ØÁ§∫) -->
                                    <button
                                        v-if="getTripCloudStatus(trip.id)"
                                        @click="handleShowInviteModal(trip.id)"
                                        class="flex-1 py-2 px-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold rounded-lg transition flex items-center justify-center gap-1.5"
                                    >
                                        <i class="ph-bold ph-share-network"></i>
                                        ÂàÜ‰∫´
                                    </button>
                                </div>

                                <button
                                    v-if="tripList.length > 1"
                                    @click.stop="deleteTrip(trip.id)"
                                    class="absolute right-3 top-3 text-slate-300 hover:text-red-500 p-1"
                                >
                                    <i class="ph-bold ph-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Âà™Èô§ÊâÄÊúâÊú¨Âú∞Á´Ø storage ÊåâÈàï (Âú®Ê∏ÖÂñÆÊúÄ‰∏ãÊñπ) -->
                        <div class="mt-4 pt-4 border-t border-slate-200">
                            <button
                                @click="handleClearAllLocalStorage"
                                class="w-full py-2 px-3 bg-red-500 hover:bg-red-600 text-white text-xs font-bold rounded-lg transition flex items-center justify-center gap-1.5"
                            >
                                <i class="ph-bold ph-trash"></i>
                                Ê∏ÖÈô§ÊâÄÊúâÊú¨Âú∞Á´ØË≥áÊñô
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 bg-black/50 backdrop-blur-sm z-40" @click="showTripMenu = false"></div>
                </div>
            </transition>

            <!-- ÂàùÂßãË®≠ÂÆöË¶ñÁ™ó -->
            <div
                v-if="showSetupModal"
                class="absolute inset-0 bg-teal-800/90 backdrop-blur-sm z-50 flex items-center justify-center p-6 animate-fade-in"
            >
                <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="ph-duotone ph-airplane-tilt text-3xl text-teal-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800">Âª∫Á´ãÊñ∞ÊóÖÁ®ã</h2>
                        <p class="text-sm text-slate-400">Á∞°ÂñÆÂπæÊ≠•ÔºåÈñãÂßãË¶èÂäÉÊÇ®ÁöÑÂÜíÈö™ÔºÅ</p>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">ÊóÖÈÅäÊ®ôÈ°å</label>
                            <input
                                v-model="setup.title"
                                type="text"
                                placeholder="‰æãÂ¶Ç: Êó•Êú¨Êù±‰∫¨Ëá™Áî±Ë°å"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-teal-500 font-bold"
                            />
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1 ml-1"
                                >ÂúãÂÆ∂/Âú∞Èªû (Áî®ÊñºÂ§©Ê∞£„ÄÅÂåØÁéá„ÄÅË™ûË®Ä)</label
                            >
                            <div class="relative">
                                <input
                                    v-model="setup.destination"
                                    @blur="detectRate"
                                    type="text"
                                    placeholder="‰æãÂ¶Ç: Tokyo, Osaka"
                                    class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-teal-500 font-bold"
                                />
                                <button
                                    @click="detectRate"
                                    class="absolute right-3 top-3 text-teal-500 hover:text-teal-700"
                                >
                                    <i class="ph-bold ph-magnifying-glass"></i>
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="col-span-2">
                                <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">ÈñãÂßãÊó•Êúü</label>
                                <input
                                    v-model="setup.startDate"
                                    type="date"
                                    class="h-12 w-full bg-slate-50 border border-slate-200 rounded-xl px-3 text-slate-700 focus:ring-2 focus:ring-teal-500 text-sm"
                                />
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">Â§©Êï∏</label>
                                <input
                                    v-model.number="setup.days"
                                    type="number"
                                    min="1"
                                    max="30"
                                    class="h-12 w-full bg-slate-50 border border-slate-200 rounded-xl px-3 text-slate-700 focus:ring-2 focus:ring-teal-500 text-center font-bold"
                                />
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1 ml-1 flex justify-between"
                                ><span>ÂåØÁéá ({{ setup.currency || 'Â§ñÂπ£' }}:Âè∞Âπ£)</span
                                ><span v-if="isRateLoading" class="text-teal-500 animate-pulse">ÊäìÂèñ‰∏≠...</span></label
                            >
                            <input
                                v-model.number="setup.rate"
                                type="number"
                                step="0.001"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-teal-500 font-mono text-right"
                            />
                        </div>
                        <button
                            @click="initTrip"
                            class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3.5 rounded-xl shadow-lg transform active:scale-95 transition flex items-center justify-center gap-2 mt-2"
                        >
                            ÈñãÂßãË¶èÂäÉ <i class="ph-bold ph-arrow-right"></i>
                        </button>
                        <button
                            v-if="tripList.length>0"
                            @click="showSetupModal = false"
                            class="w-full text-slate-400 text-xs py-2 hover:text-slate-600"
                        >
                            ÂèñÊ∂à
                        </button>
                    </div>
                </div>
            </div>

            <!-- È†êË®≠Ë°åÁ®ãÊ®°ÊùøÈ†êË¶ΩÊ®°ÊÖãÊ°Ü -->
            <div
                v-if="showTemplatePreview"
                class="fixed inset-0 z-[60] flex items-center justify-center p-4 animate-fade-in"
            >
                <div
                    class="bg-white w-full max-w-2xl max-h-[90vh] rounded-3xl shadow-2xl relative flex flex-col overflow-hidden"
                >
                    <!-- Ê®ôÈ°åÂçÄ -->
                    <div
                        class="bg-gradient-to-r from-pink-500 via-orange-500 to-yellow-500 p-6 text-white relative overflow-hidden"
                    >
                        <div class="absolute inset-0 opacity-20">
                            <div class="absolute top-0 right-0 w-64 h-64 bg-white rounded-full -mr-32 -mt-32"></div>
                            <div class="absolute bottom-0 left-0 w-48 h-48 bg-white rounded-full -ml-24 -mb-24"></div>
                        </div>
                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <h2 class="text-2xl font-bold mb-1 flex items-center gap-2">
                                    <i class="ph-bold ph-sparkle"></i>
                                    Êó•Êú¨Êù±‰∫¨ÂØåÂ£´Ë°åÁ®ãÊ®°Êùø
                                </h2>
                                <p class="text-white/90 text-sm">{{ JP_TRIP_DATA.length }} Â§©Á≤æÂΩ©Ë°åÁ®ã</p>
                            </div>
                            <button
                                @click="showTemplatePreview = false"
                                class="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-1 transition"
                            >
                                <i class="ph-bold ph-x text-xl"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ÂÖßÂÆπÂçÄÔºàÂèØÊªæÂãïÔºâ -->
                    <div class="flex-1 overflow-y-auto p-6 space-y-4 hide-scroll">
                        <!-- Ë°åÁ®ãÊ¶ÇË¶Ω -->
                        <div>
                            <h3 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2">
                                <i class="ph-bold ph-calendar-check text-teal-600"></i>
                                Ë°åÁ®ãÊ¶ÇË¶Ω
                            </h3>
                            <div class="grid grid-cols-1 gap-3">
                                <div
                                    v-for="(day, idx) in JP_TRIP_DATA"
                                    :key="idx"
                                    class="bg-gradient-to-r from-slate-50 to-white p-4 rounded-xl border border-slate-200 hover:border-teal-300 transition-all"
                                >
                                    <div class="flex items-start justify-between mb-2">
                                        <div>
                                            <div class="font-bold text-slate-800">{{ day.date }}</div>
                                            <div class="text-sm text-teal-600 font-medium">{{ day.title }}</div>
                                        </div>
                                        <div class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded-full">
                                            {{ day.items.length }} ÂÄãÊ¥ªÂãï
                                        </div>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-2 line-clamp-2">
                                        {{ day.items.slice(0, 2).map(i => i.activity).join(' ‚Ä¢ ') }}
                                        <span v-if="day.items.length > 2">...</span>
                                    </div>
                                    <div v-if="day.flight" class="mt-2 flex items-center gap-1 text-xs text-blue-600">
                                        <i class="ph-bold ph-airplane"></i>
                                        <span>{{ day.flight.type === 'arrival' ? 'ÊäµÈÅî' : 'Âá∫Áôº' }}Ëà™Áè≠</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- È†êË®≠ÊîØÂá∫ -->
                        <div>
                            <h3 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2">
                                <i class="ph-bold ph-currency-dollar text-green-600"></i>
                                È†êË®≠ÊîØÂá∫È†ÖÁõÆ
                            </h3>
                            <div class="bg-slate-50 rounded-xl p-4 space-y-2">
                                <div
                                    v-for="(exp, idx) in JP_EXPENSES"
                                    :key="idx"
                                    class="flex justify-between items-center text-sm"
                                >
                                    <span class="text-slate-700">{{ exp.item }}</span>
                                    <span class="font-bold text-slate-800">¬•{{ exp.amount.toLocaleString() }}</span>
                                </div>
                                <div
                                    class="pt-2 border-t border-slate-200 mt-2 flex justify-between items-center font-bold"
                                >
                                    <span class="text-slate-800">Á∏ΩË®à</span>
                                    <span class="text-teal-600">
                                        ¬•{{ JP_EXPENSES.reduce((sum, e) => sum + e.amount, 0).toLocaleString() }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Êìç‰ΩúÊåâÈàïÂçÄ -->
                    <div class="border-t border-slate-200 p-6 bg-slate-50 space-y-3">
                        <div class="flex gap-3">
                            <button
                                @click="loadTemplateAsNew"
                                :disabled="isLoadingTemplate"
                                class="flex-1 bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 text-white font-bold py-3 rounded-xl shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:transform-none flex items-center justify-center gap-2"
                            >
                                <i v-if="isLoadingTemplate" class="ph-bold ph-spinner animate-spin"></i>
                                <i v-else class="ph-bold ph-plus-circle"></i>
                                ÂâµÂª∫Êñ∞Ë°åÁ®ã
                            </button>
                            <button
                                v-if="currentTripId"
                                @click="loadTemplateToCurrent"
                                :disabled="isLoadingTemplate"
                                class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:transform-none flex items-center justify-center gap-2"
                            >
                                <i v-if="isLoadingTemplate" class="ph-bold ph-spinner animate-spin"></i>
                                <i v-else class="ph-bold ph-arrow-down"></i>
                                ËºâÂÖ•Âà∞Áï∂ÂâçË°åÁ®ã
                            </button>
                        </div>
                        <button
                            @click="showTemplatePreview = false"
                            class="w-full text-slate-400 text-sm py-2 hover:text-slate-600 transition"
                        >
                            ÂèñÊ∂à
                        </button>
                    </div>
                </div>
                <div
                    class="absolute inset-0 bg-black/50 backdrop-blur-sm -z-10"
                    @click="showTemplatePreview = false"
                ></div>
            </div>
        </div>

        <script type="module">
            import {
                createApp,
                ref,
                computed,
                watch,
                onMounted,
                nextTick,
                reactive,
            } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.prod.js';
            import { JP_TRIP_ID, JP_TRIP_DATA, JP_EXPENSES, FirebaseConfig } from './data/trip-data.js';

            // --- FIREBASE Ë®≠ÂÆöÂçÄ (Ë´ã‰ΩøÁî®ËÄÖÂ°´ÂØ´) ---
            const useFirebase = true;
            const FIREBASE_VERSION = '10.7.1';
            const FIREBASE_APP_URL = `https://www.gstatic.com/firebasejs/${FIREBASE_VERSION}/firebase-app.js`;
            const FIREBASE_FIRESTORE_URL = `https://www.gstatic.com/firebasejs/${FIREBASE_VERSION}/firebase-firestore.js`;
            // ------------------------------------

            // Firebase Ê®°ÁµÑÁ∑©Â≠òÔºàÈÅøÂÖçÈáçË§áËºâÂÖ•Ôºâ
            let firebaseAppModule = null;
            let firebaseFirestoreModule = null;
            let appInstance = null;
            let db = null;

            // Áµ±‰∏ÄËºâÂÖ• Firebase App Ê®°ÁµÑ
            const loadFirebaseApp = async () => {
                if (firebaseAppModule) return firebaseAppModule;
                firebaseAppModule = await import(FIREBASE_APP_URL);
                return firebaseAppModule;
            };

            // Áµ±‰∏ÄËºâÂÖ• Firebase Firestore Ê®°ÁµÑ
            const loadFirebaseFirestore = async () => {
                if (firebaseFirestoreModule) return firebaseFirestoreModule;
                firebaseFirestoreModule = await import(FIREBASE_FIRESTORE_URL);
                return firebaseFirestoreModule;
            };

            // ÂàùÂßãÂåñ Firebase
            if (useFirebase) {
                loadFirebaseApp().then((m) => {
                    appInstance = m.initializeApp(FirebaseConfig);
                    loadFirebaseFirestore().then((f) => {
                        db = f.getFirestore(appInstance);
                    });
                });
            }

            // Firebase Â∑•ÂÖ∑ÂáΩÊï∏
            const getFirestoreModule = async () => await loadFirebaseFirestore();

            const waitForDb = async () => {
                if (!useFirebase) return null;
                let attempts = 0;
                while (!db && attempts < DB_WAIT_MAX_ATTEMPTS) {
                    await new Promise((resolve) => setTimeout(resolve, DB_WAIT_INTERVAL));
                    attempts++;
                }
                return db;
            };

            const checkFirebaseReady = async () => {
                if (!useFirebase) return { ready: false, error: 'Firebase Êú™ÂïüÁî®' };
                const firestoreDb = await waitForDb();
                if (!firestoreDb) return { ready: false, error: 'Firebase ÈÄ£Á∑öÂ§±Êïó' };
                return { ready: true, db: firestoreDb };
            };

            // --- Constants ---
            const WEEKDAY_ZH = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            const DEFAULT_PARTICIPANTS = ['Êàë', 'ÊóÖ‰º¥A'];
            const DEFAULT_PARTICIPANTS_STR = 'Êàë, ÊóÖ‰º¥A';
            const DEFAULT_EXCHANGE_RATE = 0.215;
            const AUTO_SYNC_DELAY = 1000;
            const DB_WAIT_MAX_ATTEMPTS = 50;
            const DB_WAIT_INTERVAL = 100;

            createApp({
                setup() {
                    const viewMode = ref('plan');
                    const currentDayIdx = ref(0);
                    let mapInstance = null;
                    let userMarker = null;
                    let geoWatchId = null;

                    // Âç≥ÊôÇÁõ£ËÅΩÁõ∏ÈóúËÆäÊï∏
                    let expensesUnsubscribe = null; // ÂÑ≤Â≠òÁõ£ËÅΩÂô®ÁöÑÂèñÊ∂àÂáΩÊï∏
                    let isLocalUpdate = false; // Ê®ôË®òÊòØÂê¶ÁÇ∫Êú¨Âú∞Êõ¥Êñ∞ÔºåÈÅøÂÖçËß∏ÁôºÂêåÊ≠•
                    let expensesAutoSyncTimer = null; // ÂàÜÂ∏≥Ëá™ÂãïÂêåÊ≠•ÁöÑ debounce Ë®àÊôÇÂô®
                    let expensesSyncInProgress = false; // Ê®ôË®òÊòØÂê¶ÊúâÂêåÊ≠•Ê≠£Âú®ÈÄ≤Ë°å‰∏≠
                    let expensesSyncAbortFlag = false; // Ê®ôË®òÊòØÂê¶ÊáâË©≤ÂèñÊ∂àÊ≠£Âú®ÈÄ≤Ë°åÁöÑÂêåÊ≠•

                    // Â§öÊóÖÁ®ã
                    const showTripMenu = ref(false);
                    const tripList = ref([]);
                    const currentTripId = ref(null);
                    const showSetupModal = ref(false);
                    const showTemplatePreview = ref(false);
                    const isLoadingTemplate = ref(false);

                    // Ë≥áÊñô
                    const days = ref([]);
                    const expenses = ref([]);
                    const personalExpenses = ref([]); // ÂÄã‰∫∫Ë®òÂ∏≥ÂàóË°®
                    const isPersonalMode = ref(false); // ÂÄã‰∫∫/Â§ö‰∫∫Ë®òÂ∏≥Ê®°ÂºèÂàáÊèõ
                    const participants = ref([...DEFAULT_PARTICIPANTS]);
                    const participantsStr = ref(DEFAULT_PARTICIPANTS_STR);
                    const exchangeRate = ref(DEFAULT_EXCHANGE_RATE);
                    const newExpense = ref({ item: '', amount: '', payer: 'Êàë', time: '', splitParticipants: [] });
                    const timeInputRefs = ref({}); // ÊôÇÈñìËº∏ÂÖ•Ê°ÜÁöÑ ref ÂºïÁî®

                    // È†êË®≠ÂàÜÊî§ÊàêÂì°ÔºàÂ§ö‰∫∫Ê®°Âºè‰ΩøÁî®Ôºâ
                    const resetNewExpenseSplits = () => {
                        newExpense.value.splitParticipants = [...participants.value];
                    };

                    const selectAllSplits = () => {
                        resetNewExpenseSplits();
                    };

                    // Êö´Â≠òËàáË®≠ÂÆö
                    const isRateLoading = ref(false);
                    const isMapLoading = ref(false);
                    const userLocation = ref(null);
                    const weather = ref({ temp: null, icon: 'ph-sun', code: 0, location: '', daily: [] });
                    const setup = ref({
                        title: 'ÊóÖÈÅäË®àÁï´', // ‰ΩøÁî®ËÄÖËá™ÂÆöÁæ©ÁöÑÊóÖÈÅäÊ®ôÈ°åÔºàUI È°ØÁ§∫Áî®Ôºâ
                        destination: 'Tokyo', // ÂúãÂÆ∂/Âú∞ÈªûÔºàÁî®ÊñºÂ§©Ê∞£„ÄÅÂåØÁéá„ÄÅË™ûË®ÄÁ≠âÂäüËÉΩÔºâ
                        startDate: new Date().toISOString().split('T')[0],
                        days: 5,
                        rate: 0.215,
                        currency: 'JPY',
                        langCode: 'ja',
                        langName: 'Êó•Êñá',
                    });

                    // Êô∫ÊÖßÊé®Ëñ¶Á≥ªÁµ±
                    const recommendationsMap = reactive({});
                    const isSearchingRecs = ref(false);
                    const searchTargetIndex = ref('');

                    // Èõ≤Á´ØÊóÖÁ®ãÁõ∏Èóú
                    const isCloudTrip = ref(false);
                    const cloudTripId = ref(null);
                    const inviteCode = ref('');
                    const isUploading = ref(false);
                    const isSyncing = ref(false);

                    // Á∑®ËºØ title Áõ∏ÈóúÔºàÊóÖÈÅäÊ®ôÈ°åÔºâ
                    const isEditingTitle = ref(false);
                    const editingTitleValue = ref('');
                    const titleInputRef = ref(null);
                    const titleTextRef = ref(null);
                    // Á∑®ËºØ destinationÔºàÂúãÂÆ∂/Âú∞ÈªûÔºâ
                    const isEditingDestination = ref(false);
                    const editingDestinationValue = ref('');
                    const destinationInputRef = ref(null);

                    // --- Computed ---
                    const currentDay = computed(
                        () => days.value[currentDayIdx.value] || { items: [], flight: null, date: '', title: '' }
                    );
                    const totalExpense = computed(() => {
                        const expenseList = isPersonalMode.value ? personalExpenses.value : expenses.value;
                        return expenseList.reduce((sum, item) => sum + item.amount, 0);
                    });
                    const currentExpenses = computed(() => {
                        return isPersonalMode.value ? personalExpenses.value : expenses.value;
                    });
                    const paidByPerson = computed(() => {
                        const map = {};
                        participants.value.forEach((p) => (map[p] = 0));
                        expenses.value.forEach((e) => {
                            if (map[e.payer] === undefined) map[e.payer] = 0;
                            map[e.payer] += e.amount;
                        });
                        return map;
                    });

                    // ÊØè‰∫∫ÊáâÂàÜÊî§ÁöÑÈáëÈ°çÔºàÂè™Ë®àÂ§ö‰∫∫Ê®°ÂºèÔºâ
                    const owedByPerson = computed(() => {
                        const map = {};
                        participants.value.forEach((p) => (map[p] = 0));
                        if (isPersonalMode.value) return map;
                        expenses.value.forEach((e) => {
                            const splits =
                                e.splitParticipants && e.splitParticipants.length > 0
                                    ? e.splitParticipants
                                    : participants.value;
                            if (splits.length === 0) return;
                            const share = e.amount / splits.length;
                            splits.forEach((p) => {
                                if (map[p] === undefined) map[p] = 0;
                                map[p] += share;
                            });
                        });
                        return map;
                    });
                    const settlementPlan = computed(() => {
                        if (isPersonalMode.value) return []; // ÂÄã‰∫∫Ë®òÂ∏≥‰∏çÈ°ØÁ§∫ÁµêÂ∏≥Âª∫Ë≠∞
                        if (totalExpense.value === 0) return [];
                        // ÊîπÁÇ∫„ÄåÂØ¶ÈöõÊîØ‰ªò - ÊáâÂàÜÊî§„ÄçÁöÑÂ∑ÆÈ°ç
                        let balances = participants.value.map((p) => ({
                            name: p,
                            val: (paidByPerson.value[p] || 0) - (owedByPerson.value[p] || 0),
                        }));
                        let debtors = balances.filter((b) => b.val < -1).sort((a, b) => a.val - b.val);
                        let creditors = balances.filter((b) => b.val > 1).sort((a, b) => b.val - a.val);
                        const result = [];
                        let i = 0;
                        let j = 0;
                        while (i < debtors.length && j < creditors.length) {
                            let debtor = debtors[i];
                            let creditor = creditors[j];
                            let amount = Math.min(Math.abs(debtor.val), creditor.val);
                            amount = Math.round(amount);
                            if (amount > 0) result.push({ from: debtor.name, to: creditor.name, amount: amount });
                            debtor.val += amount;
                            creditor.val -= amount;
                            if (Math.abs(debtor.val) < 1) i++;
                            if (creditor.val < 1) j++;
                        }
                        return result;
                    });
                    const currencyLabel = computed(() => setup.value?.currency || 'Â§ñÂπ£');
                    const currencySymbol = computed(() => {
                        const map = {
                            JPY: '¬•',
                            CNY: '¬•',
                            USD: '$',
                            EUR: '‚Ç¨',
                            KRW: '‚Ç©',
                            GBP: '¬£',
                            TWD: 'NT$',
                            HKD: 'HK$',
                            THB: '‡∏ø',
                            VND: '‚Ç´',
                        };
                        return map[setup.value?.currency] || '$';
                    });
                    const inviteLink = computed(() => {
                        if (!inviteCode.value) return '';
                        return `${window.location.origin}${window.location.pathname}?code=${inviteCode.value}`;
                    });
                    const weatherDisplay = computed(() => {
                        const destination = setup.value?.destination || 'Áï∂Âú∞';
                        if (!currentDay.value || !currentDay.value.fullDate || weather.value.daily.length === 0) {
                            return {
                                temp: weather.value.temp !== null ? `${weather.value.temp}¬∞` : '--',
                                icon: weather.value.icon || 'ph-sun',
                                label: `${destination} (ÁõÆÂâç)`,
                                isForecast: false,
                            };
                        }
                        const targetDate = currentDay.value.fullDate;
                        const idx = weather.value.daily.time.indexOf(targetDate);
                        if (idx !== -1) {
                            const max = Math.round(weather.value.daily.temperature_2m_max[idx]);
                            const min = Math.round(weather.value.daily.temperature_2m_min[idx]);
                            return {
                                temp: `${min}¬∞ - ${max}¬∞`,
                                icon: getWeatherIcon(weather.value.daily.weathercode[idx]),
                                label: `${destination} (È†êÂ†±)`,
                                isForecast: true,
                            };
                        }
                        return {
                            temp: weather.value.temp !== null ? `${weather.value.temp}¬∞` : '--',
                            icon: weather.value.icon || 'ph-sun',
                            label: `${destination} (ÁõÆÂâç)`,
                            isForecast: false,
                        };
                    });

                    // --- Helpers ---
                    const getTodayDateStr = () => new Date().toISOString().split('T')[0];
                    const generateId = () =>
                        'trip_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                    // Ë®àÁÆóÊØèÁ≠ÜÊîØÂá∫‰∏≠ÊØè‰∫∫Êáâ‰ªòÁöÑÈáëÈ°ç
                    const getExpenseSplitAmount = (expense) => {
                        if (isPersonalMode.value) return [];
                        const splits =
                            expense.splitParticipants && expense.splitParticipants.length > 0
                                ? expense.splitParticipants
                                : participants.value;
                        if (splits.length === 0) return [];
                        const sharePerPerson = expense.amount / splits.length;
                        const result = [];
                        splits.forEach((person) => {
                            if (person === expense.payer) {
                                // ‰ªòÊ¨æ‰∫∫ÔºöÂ¢ä‰ªòÈáëÈ°ç - Êáâ‰ªòÈáëÈ°ç = ÊáâÊî∂ÈáëÈ°çÔºàË≤†Êï∏Ë°®Á§∫ÊáâÊî∂Ôºâ
                                result.push({
                                    person: person,
                                    amount: expense.amount - sharePerPerson,
                                });
                            } else {
                                // Èùû‰ªòÊ¨æ‰∫∫ÔºöÊáâ‰ªòÈáëÈ°çÔºàÊ≠£Êï∏Ë°®Á§∫Êáâ‰ªòÔºâ
                                result.push({
                                    person: person,
                                    amount: sharePerPerson,
                                });
                            }
                        });
                        return result;
                    };
                    const getWeatherIcon = (c) => {
                        if (c === 0) return 'ph-sun';
                        if (c < 4) return 'ph-cloud-sun';
                        if (c < 50) return 'ph-cloud-fog';
                        if (c < 70) return 'ph-cloud-rain';
                        return 'ph-cloud';
                    };
                    const getTimePeriod = (t) => {
                        if (!t) return '';
                        const h = parseInt(t.split(':')[0]);
                        return h < 5 ? 'ÂáåÊô®' : h < 11 ? '‰∏äÂçà' : h < 14 ? '‰∏≠Âçà' : h < 18 ? '‰∏ãÂçà' : 'Êôö‰∏ä';
                    };
                    const formatDate = (date) => {
                        const d = new Date(date);
                        if (isNaN(d.getTime())) return null;
                        const mm = String(d.getMonth() + 1).padStart(2, '0');
                        const dd = String(d.getDate()).padStart(2, '0');
                        const w = WEEKDAY_ZH[d.getDay()];
                        return {
                            date: `${mm}/${dd} (${w})`,
                            shortDate: `${mm}/${dd}`,
                            fullDate: date,
                        };
                    };
                    const toggleFlightCard = () => {
                        if (currentDay.value.flight) {
                            if (confirm('ÁßªÈô§Ëà™Áè≠?')) currentDay.value.flight = null;
                        } else {
                            currentDay.value.flight = {
                                type: 'arrival',
                                startTime: '10:00',
                                startAirport: 'TPE',
                                number: 'FLIGHT',
                                endTime: '14:00',
                                endAirport: 'DEST',
                                arrivalOffset: 0,
                            };
                        }
                    };
                    const getDotColor = (t) =>
                        t === 'food'
                            ? 'bg-orange-400'
                            : t === 'shop'
                            ? 'bg-pink-400'
                            : t === 'flight'
                            ? 'bg-blue-500'
                            : 'bg-teal-500';
                    const updateParticipants = () => {
                        participants.value = participantsStr.value
                            .split(',')
                            .map((s) => s.trim())
                            .filter((s) => s);
                        if (!isPersonalMode.value) {
                            resetNewExpenseSplits();
                        }
                        // Á´ãÂç≥‰øùÂ≠òÂà∞ localStorageÔºàwatch ÊúÉËá™Âãï‰øùÂ≠òÔºå‰ΩÜÈÄôË£°Á¢∫‰øùÁ´ãÂç≥‰øùÂ≠òÔºâ
                        if (currentTripId.value) {
                            localStorage.setItem(getStorageKey(currentTripId.value, 'users'), participantsStr.value);
                        }
                    };
                    const updateDate = (e, day) => {
                        const val = e.target.value;
                        if (!val) return;
                        const formatted = formatDate(val);
                        if (!formatted) return;
                        Object.assign(day, formatted);
                    };

                    // Á∑®ËºØ title Áõ∏ÈóúÂáΩÊï∏ÔºàÊóÖÈÅäÊ®ôÈ°åÔºâ
                    const startEditTitle = () => {
                        editingTitleValue.value = setup.value.title || '';
                        isEditingTitle.value = true;
                        nextTick(() => {
                            if (titleInputRef.value) {
                                titleInputRef.value.focus();
                                titleInputRef.value.select();
                            }
                        });
                    };
                    const saveTitle = async () => {
                        const newTitle = editingTitleValue.value.trim();
                        if (newTitle) {
                            setup.value.title = newTitle;
                            // Ëá™ÂãïÂÑ≤Â≠òÂà∞ localStorage
                            if (currentTripId.value) {
                                saveToStorage(currentTripId.value, 'config', setup.value);
                                // Êõ¥Êñ∞ tripList ‰∏≠ÁöÑ titleÔºàÂ¶ÇÊûúÊúâÁöÑË©±ÔºåÂê¶Ââá‰ΩøÁî® destinationÔºâ
                                const trip = tripList.value.find((t) => t.id === currentTripId.value);
                                if (trip) {
                                    trip.destination = newTitle; // tripList ‰ªç‰ΩøÁî® destination Ê¨Ñ‰ΩçÈ°ØÁ§∫Ê®ôÈ°å
                                    saveTripList();
                                }
                            }
                            // Ë™øÊï¥Â≠óÈ´îÂ§ßÂ∞è
                            adjustTitleFontSize();
                        }
                        isEditingTitle.value = false;
                    };
                    const cancelEditTitle = () => {
                        isEditingTitle.value = false;
                        editingTitleValue.value = '';
                    };

                    // Ëá™ÂãïË™øÊï¥ title ÊñáÂ≠óÂ§ßÂ∞è
                    const adjustTitleFontSize = () => {
                        nextTick(() => {
                            if (!titleTextRef.value) return;
                            const element = titleTextRef.value;

                            // Ë®≠ÂÆöÊúÄÂ§ßÂØ¨Â∫¶Ôºà200pxÔºåÂ∞èËû¢Âπï 150pxÔºâ
                            const maxWidth = window.innerWidth <= 400 ? 100 : 140;
                            element.style.maxWidth = `${maxWidth}px`;

                            // ÈáçÁΩÆÂ≠óÈ´îÂ§ßÂ∞è‰ª•Ê∏¨Èáè
                            element.style.fontSize = '1.25rem';
                            const scrollWidth = element.scrollWidth;
                            const clientWidth = element.clientWidth || maxWidth;

                            // Â¶ÇÊûúÊñáÂ≠óË∂ÖÂá∫ÔºåÈÄêÊ≠•Á∏ÆÂ∞èÂ≠óÈ´î
                            if (scrollWidth > clientWidth) {
                                const ratio = clientWidth / scrollWidth;
                                const baseSize = 20; // 1.25rem = 20px
                                const newSize = Math.max(baseSize * ratio * 0.95, 12); // ÊúÄÂ∞è 12px
                                element.style.fontSize = `${newSize}px`;
                            } else {
                                element.style.fontSize = '1.25rem';
                            }
                        });
                    };

                    // Á∑®ËºØ destinationÔºàÂúãÂÆ∂/Âú∞ÈªûÔºâÁõ∏ÈóúÂáΩÊï∏
                    const startEditDestination = () => {
                        editingDestinationValue.value = setup.value.destination || '';
                        isEditingDestination.value = true;
                        nextTick(() => {
                            if (destinationInputRef.value) {
                                destinationInputRef.value.focus();
                                destinationInputRef.value.select();
                            }
                        });
                    };
                    const saveDestination = async () => {
                        const newDestination = editingDestinationValue.value.trim();
                        if (newDestination) {
                            const oldDestination = setup.value.destination;
                            setup.value.destination = newDestination;
                            // Ëá™ÂãïÂÑ≤Â≠òÂà∞ localStorage
                            if (currentTripId.value) {
                                saveToStorage(currentTripId.value, 'config', setup.value);
                            }
                            // Ëã•ÁõÆÁöÑÂú∞ÊîπËÆäÔºåÈáçÊñ∞ÊäìÂèñÂåØÁéá / Â§©Ê∞£
                            if (newDestination !== oldDestination) {
                                await detectRate();
                                await fetchWeather(newDestination);
                            }
                        }
                        isEditingDestination.value = false;
                    };
                    const cancelEditDestination = () => {
                        isEditingDestination.value = false;
                        editingDestinationValue.value = '';
                    };

                    // --- Core ---
                    const openTimePicker = (refKey) => {
                        // ÈÄöÈÅé ref Ëß∏ÁôºÈö±ËóèÁöÑÊôÇÈñìËº∏ÂÖ•Ê°ÜÈªûÊìä
                        const timeInput = timeInputRefs.value[refKey];
                        if (timeInput) {
                            timeInput.click();
                        }
                    };
                    const openTimePickerFromEvent = (event) => {
                        // ÈÄöÈÅé‰∫ã‰ª∂Â∞çË±°ÊâæÂà∞ÊåâÈàïÁöÑÁà∂ÂÖÉÁ¥†ÔºåÁÑ∂ÂæåÊâæÂà∞ÂÖ∂‰∏≠ÁöÑ input[type="time"]
                        const container = event.currentTarget?.closest('.relative');
                        const timeInput = container?.querySelector('input[type="time"]');
                        if (timeInput) {
                            // ÂÑ™ÂÖà‰ΩøÁî® showPicker APIÔºàÁèæ‰ª£ÁÄèË¶ΩÂô®ÔºâÔºåÂê¶ÂâáÂõûÈÄÄÂà∞ click
                            timeInput.showPicker?.() || timeInput.click();
                        }
                    };
                    const addItem = () =>
                        currentDay.value.items.push({ time: '', type: 'spot', activity: '', location: '', note: '' });
                    const removeItem = (idx) => currentDay.value.items.splice(idx, 1);
                    const addDay = () =>
                        days.value.push({ date: `Day ${days.value.length + 1}`, title: '', items: [] });
                    const removeCurrentDay = () => {
                        if (days.value.length > 1 && confirm('Âà™Èô§?')) days.value.splice(currentDayIdx.value, 1);
                    };
                    const getGoogleMapLink = (loc) =>
                        loc ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}` : '#';

                    // ÂàÜÂ∏≥Ëá™ÂãïÂêåÊ≠•ÔºàÂè™ÈáùÂ∞çÈõ≤Á´ØÊóÖÁ®ãÔºâÔºå1 ÁßíÂÖßÂ§öÊ¨°Êìç‰ΩúÊúÉÂêà‰ΩµÊàê‰∏ÄÊ¨°ÂêåÊ≠•ÔºàËÉåÊôØÈùúÈªò‰∏äÂÇ≥Ôºâ
                    const scheduleExpensesAutoSync = () => {
                        if (!isCloudTrip.value || !cloudTripId.value || !currentTripId.value) {
                            // Â∞öÊú™‰∏äÂÇ≥ÊàêÈõ≤Á´ØÊóÖÁ®ãÊôÇÔºå‰∏ç‰∏ªÂãïÂêåÊ≠•ÔºàÈÅøÂÖçË™§Ëß∏Ôºâ
                            return;
                        }

                        // ÂèñÊ∂à‰∏ä‰∏ÄÊ¨°ÊéíÁ®ãÁöÑÂêåÊ≠•ÔºàË®àÊôÇÂô®Ôºâ
                        if (expensesAutoSyncTimer) {
                            clearTimeout(expensesAutoSyncTimer);
                            expensesAutoSyncTimer = null;
                        }

                        // Â¶ÇÊûúÊúâÊ≠£Âú®ÈÄ≤Ë°åÁöÑÂêåÊ≠•ÔºåÊ®ôË®òÁÇ∫ÂèñÊ∂à
                        if (expensesSyncInProgress) {
                            console.log('‚ö†Ô∏è ÂèñÊ∂àÊ≠£Âú®ÈÄ≤Ë°åÁöÑÂàÜÂ∏≥ÂêåÊ≠•');
                            expensesSyncAbortFlag = true;
                        }

                        // Âª∂ÈÅ≤ÂæåÂÜçÂü∑Ë°åÂêåÊ≠•ÔºåÊúüÈñìÁöÑÊñ∞Â¢û/Âà™Èô§ÊúÉË¢´Âêà‰Ωµ
                        expensesAutoSyncTimer = setTimeout(async () => {
                            expensesAutoSyncTimer = null;

                            // Ê™¢Êü•ÊòØÂê¶ÊáâË©≤ÂèñÊ∂àÔºàÂèØËÉΩÂú®Ë®àÊôÇÂô®Á≠âÂæÖÊúüÈñìÂèàÊúâÊñ∞ÁöÑÊìç‰ΩúÔºâ
                            if (expensesSyncAbortFlag) {
                                console.log('‚ö†Ô∏è ÂêåÊ≠•Â∑≤Ë¢´ÂèñÊ∂àÔºåË∑≥ÈÅéÊ≠§Ê¨°ÂêåÊ≠•');
                                expensesSyncAbortFlag = false;
                                return;
                            }

                            try {
                                // Ê®ôË®òÂêåÊ≠•ÈñãÂßã
                                expensesSyncInProgress = true;
                                expensesSyncAbortFlag = false;

                                // ‰ΩøÁî®Êó¢ÊúâÁöÑ‰∏äÂÇ≥ÊµÅÁ®ãÔºåÁ¢∫‰øù days / sharedExpenses ÁãÄÊÖã‰∏ÄËá¥Ôºàsilent = true ËÉåÊôØÈùúÈªòÂêåÊ≠•Ôºâ
                                await handleUploadToCloud(currentTripId.value, true);
                            } catch (e) {
                                // Âè™ÊúâÂú®‰∏çÊòØÂõ†ÁÇ∫ÂèñÊ∂àËÄåÂ§±ÊïóÊôÇÊâçË®òÈåÑÈåØË™§
                                if (!expensesSyncAbortFlag) {
                                    console.error('Ëá™ÂãïÂêåÊ≠•ÂàÜÂ∏≥Â§±ÊïóÔºö', e);
                                } else {
                                    console.log('‚ö†Ô∏è ÂêåÊ≠•Â∑≤Ë¢´ÂèñÊ∂à');
                                }
                            } finally {
                                // Ê®ôË®òÂêåÊ≠•ÁµêÊùü
                                expensesSyncInProgress = false;
                                expensesSyncAbortFlag = false;
                            }
                        }, AUTO_SYNC_DELAY);
                    };

                    // Ê†ºÂºèÂåñÊôÇÈñìÂáΩÊï∏ÔºöÂ∞á datetime-local Ê†ºÂºèËΩâÊèõÁÇ∫ "YYYY-MM-DD HH:mm‚Üí" Ê†ºÂºè
                    const formatExpenseTime = (timeString) => {
                        if (!timeString) return '';
                        // datetime-local Ê†ºÂºèÁÇ∫ "YYYY-MM-DDTHH:mm"ÔºåËΩâÊèõÁÇ∫ "YYYY-MM-DD HH:mm"
                        const formatted = timeString.replace('T', ' ');
                        return formatted + '‚Üí';
                    };

                    const addExpense = () => {
                        if (newExpense.value.item) {
                            // Âª∫Á´ãÂîØ‰∏ÄÁöÑ order ÂÄº
                            const payer = isPersonalMode.value ? 'personal' : newExpense.value.payer || 'payer';
                            const order = `${Date.now()}_${payer}`;

                            // Â¶ÇÊûúÊúâË®≠ÂÆöÊôÇÈñìÔºåÂ∞áÊôÇÈñìÊ†ºÂºèÂåñ‰∏¶Âä†Âà∞ item ÂâçÈù¢
                            let itemWithTime = newExpense.value.item;
                            if (newExpense.value.time) {
                                const timePrefix = formatExpenseTime(newExpense.value.time);
                                itemWithTime = timePrefix + itemWithTime;
                            }

                            // Á¢∫Ë™çÂàÜÊî§Â∞çË±°ÔºàËã•Êú™ÈÅ∏ÊìáÂâáÈ†êË®≠ÂÖ®ÈÉ®ÂèÉËàáËÄÖÔºâ
                            // ÈáçË¶ÅÔºöÂøÖÈ†àÊòéÁ¢∫‰øùÂ≠òÂàÜÊî§ÊàêÂì°ÂàóË°®Ôºå‰∏çËÉΩÊòØÁ©∫Èô£ÂàóÔºåÂê¶ÂâáÂêåÊ≠•ÊôÇÊúÉË¢´Ë™§Âà§
                            const selectedSplits =
                                !isPersonalMode.value && newExpense.value.splitParticipants?.length > 0
                                    ? newExpense.value.splitParticipants
                                    : isPersonalMode.value
                                    ? []
                                    : [...participants.value]; // ÊòéÁ¢∫‰ΩøÁî®ÂÖ®Âì°ÂàóË°®Ôºå‰∏çÊòØÁ©∫Èô£Âàó

                            const expense = {
                                item: itemWithTime,
                                amount: newExpense.value.amount,
                                payer: isPersonalMode.value ? 'ÂÄã‰∫∫' : payer,
                                order,
                                splitParticipants: selectedSplits, // Á¢∫‰øùÊ∞∏ÈÅ†ÊúâÊòéÁ¢∫ÁöÑÂÄº
                            };

                            if (isPersonalMode.value) {
                                // ÂÄã‰∫∫Ë®òÂ∏≥Ê®°Âºè
                                personalExpenses.value.unshift(expense);
                                saveToStorage(currentTripId.value, 'personal_exp', personalExpenses.value);
                                // ‰∏äÂÇ≥Âà∞ FirebaseÔºà‰∏çË®≠ÁΩÆÁõ£ËÅΩÂô®Ôºâ
                                if (useFirebase && isCloudTrip.value && cloudTripId.value) {
                                    addPersonalExpenseToCloud(expense);
                                }
                            } else {
                                // Â§ö‰∫∫Ë®òÂ∏≥Ê®°Âºè
                                // Â¶ÇÊûúÊòØÈõ≤Á´ØÊóÖÁ®ãÔºåÊ®ôË®òÁÇ∫Êú¨Âú∞Êõ¥Êñ∞ÔºåÈÅøÂÖçËß∏ÁôºÁõ£ËÅΩÂô®
                                if (isCloudTrip.value && cloudTripId.value) {
                                    isLocalUpdate = true;
                                }
                                expenses.value.unshift(expense);
                                // Êñ∞Â¢û‰∏äÂÇ≥Ëá≥ FirestoreÔºàsharedExpensesÔºâÔºå‰ΩøÁî® order ‰ΩúÁÇ∫Êñá‰ª∂ ID
                                if (useFirebase && isCloudTrip.value && cloudTripId.value) {
                                    addExpenseToCloudByOrder(expense);
                                }
                            }

                            // Âè™Ê∏ÖÁ©∫È†ÖÁõÆÂíåÈáëÈ°çÔºå‰øùÁïôÊôÇÈñìËàá‰ªòÊ¨æ‰∫∫
                            newExpense.value.item = '';
                            newExpense.value.amount = '';
                            if (!isPersonalMode.value) {
                                resetNewExpenseSplits();
                            }
                        }
                    };
                    const removeExpense = (idx) => {
                        if (isPersonalMode.value) {
                            // ÂÄã‰∫∫Ë®òÂ∏≥Ê®°Âºè
                            const target = personalExpenses.value[idx];
                            if (!target) return;

                            personalExpenses.value.splice(idx, 1);
                            saveToStorage(currentTripId.value, 'personal_exp', personalExpenses.value);

                            // Âà™Èô§ Firebase ‰∏≠ÁöÑË®òÈåÑ
                            if (useFirebase && isCloudTrip.value && cloudTripId.value && target.order) {
                                deletePersonalExpenseFromCloud(target.order);
                            }
                        } else {
                            // Â§ö‰∫∫Ë®òÂ∏≥Ê®°Âºè
                            const target = expenses.value[idx];
                            if (!target) return;

                            // Â¶ÇÊûúÊòØÈõ≤Á´ØÊóÖÁ®ãÔºåÊ®ôË®òÁÇ∫Êú¨Âú∞Êõ¥Êñ∞ÔºåÈÅøÂÖçËß∏ÁôºÁõ£ËÅΩÂô®Ôºå‰∏¶ÂòóË©¶ÂêåÊ≠•Âà™Èô§ Firestore ‰∏≠Â∞çÊáâÂ∏≥ÁõÆ
                            if (isCloudTrip.value && cloudTripId.value) {
                                isLocalUpdate = true;
                                if (target.order && useFirebase) {
                                    // ÈùûÂêåÊ≠•ÂëºÂè´ÔºåËÉåÊôØÂü∑Ë°åÂà™Èô§Ôºà‰∏çÂΩ±ÈüøÂâçÁ´ØÈ´îÈ©óÔºâ
                                    deleteExpenseFromCloudByOrder(target.order);
                                }
                            }

                            expenses.value.splice(idx, 1);
                        }
                    };

                    // --- LBS Êé®Ëñ¶ÂäüËÉΩ ---
                    const searchNearby = async (item, idx) => {
                        if (!item.location || item.type !== 'food') return;

                        const key = `${currentDayIdx.value}-${idx}`;
                        searchTargetIndex.value = key;
                        isSearchingRecs.value = true;
                        recommendationsMap[key] = [];

                        try {
                            const geoRes = await fetch(
                                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                                    item.location
                                )}&limit=1`
                            );
                            const geoData = await geoRes.json();

                            if (geoData && geoData.length > 0) {
                                const lat = geoData[0].lat;
                                const lon = geoData[0].lon;

                                let query = 'restaurant';
                                const finalQuery = `${query} near ${item.location}`;
                                const searchRes = await fetch(
                                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                                        finalQuery
                                    )}&limit=4`
                                );
                                const searchData = await searchRes.json();

                                recommendationsMap[key] = searchData.map((place) => ({
                                    name: place.name || place.display_name.split(',')[0],
                                    location: place.name || place.display_name.split(',')[0],
                                    note: 'Êé®Ëñ¶Âú∞Èªû',
                                }));

                                if (recommendationsMap[key].length === 0) {
                                    recommendationsMap[key] = [
                                        { name: 'Êâæ‰∏çÂà∞Êé®Ëñ¶ÔºåË´ãÂòóË©¶Êõ¥Á≤æÁ¢∫Âú∞Èªû', location: item.location, note: '' },
                                    ];
                                }
                            }
                        } catch (e) {
                            console.error('Êé®Ëñ¶ÊêúÂ∞ãÂ§±Êïó', e);
                        } finally {
                            isSearchingRecs.value = false;
                            searchTargetIndex.value = '';
                        }
                    };

                    const applyRecommendation = (item, rec) => {
                        item.activity = rec.name;
                        item.location = rec.name;
                    };

                    // --- Auto Detect ---
                    const countryInfoMap = {
                        jp: { c: 'JPY', l: 'ja', n: 'Êó•Êñá' },
                        kr: { c: 'KRW', l: 'ko', n: 'ÈüìÊñá' },
                        us: { c: 'USD', l: 'en', n: 'Ëã±Êñá' },
                        cn: { c: 'CNY', l: 'zh-CN', n: 'Á∞°‰∏≠' },
                        th: { c: 'THB', l: 'th', n: 'Ê≥∞Êñá' },
                    };
                    const detectRate = async () => {
                        if (!setup.value.destination) return;
                        isRateLoading.value = true;
                        try {
                            const geoRes = await fetch(
                                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                                    setup.value.destination
                                )}&limit=1&addressdetails=1`
                            );
                            const geoData = await geoRes.json();
                            if (geoData?.[0]?.address?.country_code) {
                                const info = countryInfoMap[geoData[0].address.country_code.toLowerCase()] || {
                                    c: 'USD',
                                    l: 'en',
                                    n: 'Ëã±Êñá',
                                };
                                setup.value.currency = info.c;
                                setup.value.langCode = info.l;
                                setup.value.langName = info.n;
                                if (info.c === 'TWD') setup.value.rate = 1;
                                else {
                                    const rRes = await fetch(`https://api.exchangerate-api.com/v4/latest/${info.c}`);
                                    const rData = await rRes.json();
                                    if (rData?.rates?.TWD) setup.value.rate = rData.rates.TWD;
                                }
                            }
                        } catch (e) {
                        } finally {
                            isRateLoading.value = false;
                        }
                    };

                    // --- Weather ---
                    const fetchWeather = async (locName) => {
                        try {
                            weather.value.location = locName;
                            const geoRes = await fetch(
                                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                                    locName
                                )}&limit=1`
                            );
                            const geoData = await geoRes.json();
                            if (geoData?.[0]) {
                                const { lat, lon } = geoData[0];
                                const wRes = await fetch(
                                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&forecast_days=16`
                                );
                                const wData = await wRes.json();
                                weather.value.temp = Math.round(wData.current_weather.temperature);
                                weather.value.icon = getWeatherIcon(wData.current_weather.weathercode);
                                if (wData.daily) weather.value.daily = wData.daily;
                            }
                        } catch (e) {
                            weather.value.temp = '--';
                        }
                    };

                    // --- LocalStorage Â∑•ÂÖ∑ÂáΩÊï∏ ---
                    const getStorageKey = (tripId, suffix) => `${tripId}_${suffix}`;
                    const saveToStorage = (tripId, suffix, data) => {
                        if (!tripId) return;
                        localStorage.setItem(getStorageKey(tripId, suffix), JSON.stringify(data));
                    };
                    const loadFromStorage = (tripId, suffix, defaultValue = null) => {
                        if (!tripId) return defaultValue;
                        const item = localStorage.getItem(getStorageKey(tripId, suffix));
                        return item ? JSON.parse(item) : defaultValue;
                    };

                    // --- Trip Management ---
                    const loadTripList = () => {
                        const list = localStorage.getItem('travel_app_index');
                        tripList.value = list ? JSON.parse(list) : [];

                        // Ëá™ÂãïËºâÂÖ•Êó•Êú¨È†êË®≠Ë°åÁ®ã (Â¶ÇÊûúÂ∞öÊú™Â≠òÂú®)
                        const hasDefault = tripList.value.find((t) => t.id === JP_TRIP_ID);
                        if (!hasDefault && tripList.value.length === 0) {
                            const defaultTrip = {
                                id: JP_TRIP_ID,
                                destination: 'Êó•Êú¨Êù±‰∫¨ÂØåÂ£´Â±±',
                                startDate: '2025-02-17',
                                daysCount: 7,
                            };
                            tripList.value.push(defaultTrip);
                            saveToStorage(JP_TRIP_ID, 'days', JP_TRIP_DATA);
                            saveToStorage(JP_TRIP_ID, 'exp', JP_EXPENSES);
                            localStorage.setItem(getStorageKey(JP_TRIP_ID, 'users'), DEFAULT_PARTICIPANTS_STR);
                            localStorage.setItem(getStorageKey(JP_TRIP_ID, 'rate'), String(DEFAULT_EXCHANGE_RATE));
                            saveToStorage(JP_TRIP_ID, 'config', {
                                title: 'Êó•Êú¨Êù±‰∫¨ÂØåÂ£´Â±±',
                                destination: 'Japan',
                                startDate: '2025-02-17',
                                days: 7,
                                rate: DEFAULT_EXCHANGE_RATE,
                                currency: 'JPY',
                                langCode: 'ja',
                                langName: 'Êó•Êñá',
                            });
                            saveTripList();
                        }
                    };
                    const saveTripList = () => {
                        localStorage.setItem('travel_app_index', JSON.stringify(tripList.value));
                    };
                    const createNewTrip = () => {
                        setup.value = {
                            title: '',
                            destination: '',
                            startDate: getTodayDateStr(),
                            days: 5,
                            rate: DEFAULT_EXCHANGE_RATE,
                            currency: 'JPY',
                            langCode: 'ja',
                            langName: 'Êó•Êñá',
                        };
                        showSetupModal.value = true;
                        showTripMenu.value = false;
                    };
                    const initTrip = () => {
                        if (!setup.value.destination) {
                            alert('Ë´ãËº∏ÂÖ•ÂúãÂÆ∂/Âú∞Èªû');
                            return;
                        }
                        // Â¶ÇÊûúÊ≤íÊúâËº∏ÂÖ•Ê®ôÈ°åÔºå‰ΩøÁî® destination ‰ΩúÁÇ∫È†êË®≠Ê®ôÈ°å
                        if (!setup.value.title) {
                            setup.value.title = setup.value.destination;
                        }
                        const newId = generateId();
                        const newTripMeta = {
                            id: newId,
                            destination: setup.value.title || setup.value.destination, // tripList ‰ΩøÁî® titleÔºåÊ≤íÊúâÂâáÁî® destination
                            startDate: setup.value.startDate,
                            daysCount: setup.value.days,
                        };

                        const newDays = [];
                        const start = new Date(setup.value.startDate);
                        for (let i = 0; i < setup.value.days; i++) {
                            const curr = new Date(start);
                            curr.setDate(start.getDate() + i);
                            const yyyy = curr.getFullYear();
                            const mm = String(curr.getMonth() + 1).padStart(2, '0');
                            const dd = String(curr.getDate()).padStart(2, '0');
                            const fullDate = `${yyyy}-${mm}-${dd}`;
                            const formatted = formatDate(fullDate);

                            newDays.push({
                                date: formatted?.date || `${mm}/${dd} (${WEEKDAY_ZH[curr.getDay()]})`,
                                shortDate: formatted?.shortDate || `${mm}/${dd}`,
                                fullDate: fullDate,
                                title: i === 0 ? 'ÊäµÈÅî & Êé¢Á¥¢' : 'Ë°åÁ®ãË¶èÂäÉ',
                                items: [],
                                flight: null,
                            });
                        }

                        saveToStorage(newId, 'days', newDays);
                        saveToStorage(newId, 'exp', []);
                        localStorage.setItem(getStorageKey(newId, 'users'), DEFAULT_PARTICIPANTS_STR);
                        localStorage.setItem(getStorageKey(newId, 'rate'), setup.value.rate.toString());
                        saveToStorage(newId, 'config', setup.value);

                        tripList.value.unshift(newTripMeta);
                        saveTripList();

                        switchTrip(newId);
                        showSetupModal.value = false;
                    };
                    const deleteTrip = (id) => {
                        if (!confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Ë°åÁ®ãÔºüÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) return;
                        tripList.value = tripList.value.filter((t) => t.id !== id);
                        saveTripList();

                        // Ê∏ÖÈô§ÊâÄÊúâÁõ∏ÈóúÁöÑ localStorage Ë≥áÊñô
                        ['days', 'exp', 'personal_exp', 'users', 'rate', 'config', 'cloud', 'synced'].forEach(
                            (suffix) => {
                                localStorage.removeItem(getStorageKey(id, suffix));
                            }
                        );

                        if (currentTripId.value === id) {
                            if (tripList.value.length > 0) switchTrip(tripList.value[0].id);
                            else {
                                days.value = [];
                                expenses.value = [];
                                personalExpenses.value = [];
                                currentTripId.value = null;
                                showSetupModal.value = true;
                            }
                        }
                    };
                    // ËºâÂÖ•È†êË®≠Ë°åÁ®ãÊ®°Êùø
                    const loadTemplateAsNew = async () => {
                        isLoadingTemplate.value = true;
                        try {
                            // Ê™¢Êü•ÊòØÂê¶Â∑≤Â≠òÂú®Áõ∏Âêå ID ÁöÑË°åÁ®ã
                            const existingTrip = tripList.value.find((t) => t.id === JP_TRIP_ID);
                            if (existingTrip) {
                                if (!confirm('Â∑≤Â≠òÂú®Áõ∏ÂêåÂêçÁ®±ÁöÑË°åÁ®ãÔºåÊòØÂê¶Ë¶ÅË¶ÜËìãÔºü')) {
                                    isLoadingTemplate.value = false;
                                    return;
                                }
                                // Âà™Èô§ËàäË°åÁ®ã
                                tripList.value = tripList.value.filter((t) => t.id !== JP_TRIP_ID);
                                ['days', 'exp', 'personal_exp', 'users', 'rate', 'config', 'cloud', 'synced'].forEach(
                                    (suffix) => {
                                        localStorage.removeItem(getStorageKey(JP_TRIP_ID, suffix));
                                    }
                                );
                            }

                            // ÂâµÂª∫Êñ∞Ë°åÁ®ã
                            const newTripMeta = {
                                id: JP_TRIP_ID,
                                destination: 'Êó•Êú¨Êù±‰∫¨ÂØåÂ£´Â±±',
                                startDate: JP_TRIP_DATA[0]?.fullDate || '2025-02-17',
                                daysCount: JP_TRIP_DATA.length,
                            };

                            // ‰øùÂ≠òË≥áÊñô
                            saveToStorage(JP_TRIP_ID, 'days', JP_TRIP_DATA);
                            saveToStorage(JP_TRIP_ID, 'exp', JP_EXPENSES);
                            localStorage.setItem(getStorageKey(JP_TRIP_ID, 'users'), DEFAULT_PARTICIPANTS_STR);
                            localStorage.setItem(getStorageKey(JP_TRIP_ID, 'rate'), String(DEFAULT_EXCHANGE_RATE));
                            saveToStorage(JP_TRIP_ID, 'config', {
                                title: 'Êó•Êú¨Êù±‰∫¨ÂØåÂ£´Â±±',
                                destination: 'Japan',
                                startDate: JP_TRIP_DATA[0]?.fullDate || '2025-02-17',
                                days: JP_TRIP_DATA.length,
                                rate: DEFAULT_EXCHANGE_RATE,
                                currency: 'JPY',
                                langCode: 'ja',
                                langName: 'Êó•Êñá',
                            });

                            tripList.value.unshift(newTripMeta);
                            saveTripList();

                            // ÂàáÊèõÂà∞Êñ∞Ë°åÁ®ã
                            await switchTrip(JP_TRIP_ID);
                            showTemplatePreview.value = false;
                            showTripMenu.value = false;
                        } catch (error) {
                            console.error('ËºâÂÖ•Ê®°ÊùøÂ§±Êïó:', error);
                            alert('ËºâÂÖ•Ê®°ÊùøÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶');
                        } finally {
                            isLoadingTemplate.value = false;
                        }
                    };
                    const loadTemplateToCurrent = async () => {
                        if (!currentTripId.value) {
                            alert('Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÂÄãË°åÁ®ã');
                            return;
                        }
                        if (!confirm('Á¢∫ÂÆöË¶ÅÂ∞áÊ®°ÊùøË≥áÊñôËºâÂÖ•Âà∞Áï∂ÂâçË°åÁ®ãÂóéÔºüÈÄôÊúÉË¶ÜËìãÁèæÊúâÁöÑË°åÁ®ãË≥áÊñô„ÄÇ')) {
                            return;
                        }
                        isLoadingTemplate.value = true;
                        try {
                            // ËºâÂÖ•Ê®°ÊùøË≥áÊñôÂà∞Áï∂ÂâçË°åÁ®ã
                            saveToStorage(currentTripId.value, 'days', JP_TRIP_DATA);

                            // Âêà‰ΩµÊîØÂá∫Ôºà‰øùÁïôÁèæÊúâÊîØÂá∫ÔºåÊ∑ªÂä†Ê®°ÊùøÊîØÂá∫Ôºâ
                            const currentExp = loadFromStorage(currentTripId.value, 'exp', []);
                            const templateExpIds = new Set(JP_EXPENSES.map((e) => e.item));
                            const filteredCurrentExp = currentExp.filter((e) => !templateExpIds.has(e.item));
                            const mergedExp = [...filteredCurrentExp, ...JP_EXPENSES];
                            saveToStorage(currentTripId.value, 'exp', mergedExp);

                            // Êõ¥Êñ∞Ë°åÁ®ãÂÖÉÊï∏Êìö
                            const tripIndex = tripList.value.findIndex((t) => t.id === currentTripId.value);
                            if (tripIndex !== -1) {
                                tripList.value[tripIndex].daysCount = JP_TRIP_DATA.length;
                                tripList.value[tripIndex].startDate =
                                    JP_TRIP_DATA[0]?.fullDate || tripList.value[tripIndex].startDate;
                                saveTripList();
                            }

                            // ÈáçÊñ∞ËºâÂÖ•Ë°åÁ®ã
                            await switchTrip(currentTripId.value);
                            showTemplatePreview.value = false;
                            showTripMenu.value = false;
                        } catch (error) {
                            console.error('ËºâÂÖ•Ê®°ÊùøÂ§±Êïó:', error);
                            alert('ËºâÂÖ•Ê®°ÊùøÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶');
                        } finally {
                            isLoadingTemplate.value = false;
                        }
                    };
                    const switchTrip = async (id) => {
                        // ÂèñÊ∂àËàäÁöÑÁõ£ËÅΩÂô®
                        if (expensesUnsubscribe) {
                            expensesUnsubscribe();
                            expensesUnsubscribe = null;
                        }

                        currentTripId.value = id;
                        // ‰øùÂ≠òÁï∂ÂâçÈÅ∏ÊìáÁöÑÊóÖÁ®ã ID Âà∞ localStorage
                        localStorage.setItem('last_selected_trip_id', id);
                        showTripMenu.value = false;

                        // ËºâÂÖ•Êú¨Âú∞Ë≥áÊñô
                        days.value = loadFromStorage(id, 'days', []);
                        expenses.value = loadFromStorage(id, 'exp', []);
                        personalExpenses.value = loadFromStorage(id, 'personal_exp', []);

                        const lUsers = localStorage.getItem(getStorageKey(id, 'users'));
                        const lRate = localStorage.getItem(getStorageKey(id, 'rate'));
                        const lConf = loadFromStorage(id, 'config');
                        const lCloud = loadFromStorage(id, 'cloud');

                        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Èõ≤Á´ØÊóÖÁ®ã
                        let cloudSyncSuccess = false; // Ê®ôË®òÈõ≤Á´ØÂêåÊ≠•ÊòØÂê¶ÊàêÂäü
                        if (lCloud) {
                            cloudTripId.value = lCloud.cloudTripId || null;
                            inviteCode.value = lCloud.inviteCode || '';
                            // Â¶ÇÊûúÊúâ cloudTripIdÔºåÂ∞±Ë¶ñÁÇ∫Èõ≤Á´ØÊóÖÁ®ãÔºàÂç≥‰Ωø isCloudTrip Êú™Ë®≠ÁΩÆÔºâ
                            isCloudTrip.value =
                                lCloud.isCloudTrip !== undefined ? lCloud.isCloudTrip : !!cloudTripId.value;

                            // Â¶ÇÊûúÊòØÈõ≤Á´ØÊóÖÁ®ãÔºåËá™ÂãïÂêåÊ≠•Ë≥áÊñô‰∏¶Ë®≠ÂÆöÂç≥ÊôÇÁõ£ËÅΩ
                            if (isCloudTrip.value && cloudTripId.value) {
                                try {
                                    await syncFromCloud(); // ÂêåÊ≠•ÊúÉÊõ¥Êñ∞ participantsStr Âíå setup.value
                                    cloudSyncSuccess = true; // Ê®ôË®òÂêåÊ≠•ÊàêÂäü
                                    await setupExpensesRealtimeListener();
                                } catch (error) {
                                    console.error('Èõ≤Á´ØÂêåÊ≠•Â§±ÊïóÔºåÂ∞á‰ΩøÁî®Êú¨Âú∞Ë≥áÊñô:', error);
                                    cloudSyncSuccess = false; // ÂêåÊ≠•Â§±ÊïóÔºå‰ΩøÁî®Êú¨Âú∞Ë≥áÊñô
                                }
                            } else {
                                // Â¶ÇÊûú‰∏çÊòØÈõ≤Á´ØÊóÖÁ®ãÔºå‰ΩøÁî®Êú¨Âú∞Ë≥áÊñô
                                if (lUsers) {
                                    participantsStr.value = lUsers;
                                    updateParticipants();
                                }
                            }
                        } else {
                            isCloudTrip.value = false;
                            cloudTripId.value = null;
                            inviteCode.value = '';
                            // ÈùûÈõ≤Á´ØÊóÖÁ®ãÔºå‰ΩøÁî®Êú¨Âú∞Ë≥áÊñô
                            if (lUsers) {
                                participantsStr.value = lUsers;
                                updateParticipants();
                            }
                        }
                        if (lRate) exchangeRate.value = parseFloat(lRate);

                        // ËºâÂÖ•Êú¨Âú∞ configÔºàÂÉÖÂú®ÈùûÈõ≤Á´ØÊóÖÁ®ãÔºåÊàñÈõ≤Á´ØÊóÖÁ®ãÂêåÊ≠•Â§±ÊïóÊôÇ‰ΩøÁî®Ôºâ
                        // Â¶ÇÊûúÊòØÈõ≤Á´ØÊóÖÁ®ã‰∏îÂ∑≤ÊàêÂäüÂêåÊ≠•ÔºåsyncFromCloud() Â∑≤Á∂ìÊõ¥Êñ∞‰∫Ü setup.valueÔºå‰∏çÈúÄË¶ÅÂÜçÁî®Êú¨Âú∞ config Ë¶ÜËìã
                        if (lConf && !cloudSyncSuccess) {
                            setup.value = lConf;
                        }

                        // Áµ±‰∏Ä‰ΩøÁî® setup.value.destination ‰æÜÁç≤ÂèñÂ§©Ê∞£ÔºàÁÑ°Ë´ñÊòØÊú¨Âú∞ÈÇÑÊòØÈõ≤Á´ØËºâÂÖ•ÁöÑÔºâ
                        if (setup.value.destination) {
                            fetchWeather(setup.value.destination);
                        }

                        if (!isPersonalMode.value) {
                            resetNewExpenseSplits();
                        }
                    };

                    // --- Firebase Èõ≤Á´ØÂäüËÉΩ ---
                    // Ë®≠ÂÆö sharedExpenses ÁöÑÂç≥ÊôÇÁõ£ËÅΩÂô®ÔºàÂè™Áõ£ËÅΩÂàÜÂ∏≥ÂäüËÉΩÔºâ
                    const setupExpensesRealtimeListener = async () => {
                        const firestoreDb = await checkCloudFirebaseReady();
                        if (!firestoreDb) {
                            console.warn('‚ö†Ô∏è Firebase ÈÄ£Á∑öÂ§±ÊïóÔºåÁÑ°Ê≥ïË®≠ÂÆöÂç≥ÊôÇÁõ£ËÅΩ');
                            return;
                        }

                        try {
                            const firestoreModule = await getFirestoreModule();
                            const { collection, onSnapshot, query, orderBy } = firestoreModule;

                            // ÂèñÊ∂àËàäÁöÑÁõ£ËÅΩÂô®;
                            if (expensesUnsubscribe) {
                                expensesUnsubscribe();
                            }

                            const expensesCollection = collection(
                                firestoreDb,
                                `trips/${cloudTripId.value}/sharedExpenses`
                            );
                            const expensesQuery = query(expensesCollection, orderBy('createdAt', 'desc'));

                            console.log('üëÇ ÈñãÂßãÁõ£ËÅΩ sharedExpenses ËÆäÊõ¥...', {
                                cloudTripId: cloudTripId.value,
                            });

                            // Ë®≠ÂÆöÂç≥ÊôÇÁõ£ËÅΩ
                            expensesUnsubscribe = onSnapshot(
                                expensesQuery,
                                async (snapshot) => {
                                    // Â¶ÇÊûúÊòØÊú¨Âú∞Êõ¥Êñ∞ÔºåÂøΩÁï•Áõ£ËÅΩÂô®ÁöÑËß∏ÁôºÔºàÈÅøÂÖç‰∏äÂÇ≥ÊôÇÊ∏ÖÁ©∫Ë≥áÊñôÔºâ
                                    if (isLocalUpdate) {
                                        console.log('‚ö†Ô∏è ÂøΩÁï•Áõ£ËÅΩÂô®Ëß∏ÁôºÔºàÊú¨Âú∞Êõ¥Êñ∞‰∏≠Ôºâ');
                                        return;
                                    }

                                    console.log('üì¢ ÂÅµÊ∏¨Âà∞ sharedExpenses ËÆäÊõ¥:', {
                                        size: snapshot.size,
                                        changes: snapshot.docChanges().map((change) => ({
                                            type: change.type,
                                            docId: change.doc.id,
                                            data: change.doc.data(),
                                        })),
                                    });

                                    // Âæû Firestore ÂèñÂæóÊúÄÊñ∞ÁöÑ expenses
                                    const remoteExpenses = [];
                                    snapshot.forEach((doc) => {
                                        const data = doc.data();
                                        // ËôïÁêÜËàäË≥áÊñôÔºöÂ¶ÇÊûúÊ≤íÊúâ splitParticipants ÊàñÁÇ∫Á©∫Èô£ÂàóÔºå‰ΩøÁî®Áï∂ÂâçÂÖ®Âì°‰ΩúÁÇ∫È†êË®≠ÂÄº
                                        let splitParts = data.splitParticipants;
                                        if (!splitParts || !Array.isArray(splitParts) || splitParts.length === 0) {
                                            // ËàäË≥áÊñôÊàñÁ©∫Èô£ÂàóÔºö‰ΩøÁî®Áï∂ÂâçÂÖ®Âì°ÂàóË°®ÔºàÈÄôÊòØÂêàÁêÜÁöÑÈ†êË®≠ÂÄºÔºâ
                                            splitParts = [...participants.value];
                                        }
                                        remoteExpenses.push({
                                            item: data.item,
                                            amount: data.amount,
                                            payer: data.payerName,
                                            order: data.order || null, // ÂîØ‰∏ÄË≠òÂà•Áî®ÁöÑ order
                                            splitParticipants: splitParts, // Á¢∫‰øùÊ∞∏ÈÅ†ÊúâÊòéÁ¢∫ÁöÑÂÄº
                                        });
                                    });

                                    // ÊØîÂ∞ç‰∏¶Âêà‰ΩµÊú¨Âú∞ÂíåÈÅ†Á´ØË≥áÊñô
                                    mergeExpenses(remoteExpenses);
                                },
                                (error) => {
                                    console.error('‚ùå Áõ£ËÅΩ sharedExpenses ÊôÇÁôºÁîüÈåØË™§:', error);
                                }
                            );

                            console.log('‚úÖ Âç≥ÊôÇÁõ£ËÅΩÂô®Ë®≠ÂÆöÂÆåÊàê');
                        } catch (error) {
                            console.error('‚ùå Ë®≠ÂÆöÂç≥ÊôÇÁõ£ËÅΩÂô®Â§±Êïó:', error);
                        }
                    };

                    // ÊØîÂ∞ç‰∏¶Âêà‰ΩµÊú¨Âú∞ÂíåÈÅ†Á´ØÁöÑ expensesÔºà‰ª• order ÁÇ∫ÂîØ‰∏ÄË≠òÂà•Ôºâ
                    // Firestore Ë¶ñÁÇ∫„ÄåÊúÄÁµÇÁúüÂØ¶‰æÜÊ∫ê„ÄçÔºö
                    // - Firestore Êúâ„ÄÅÊú¨Âú∞Ê≤íÊúâ -> Êú¨Âú∞Êñ∞Â¢û
                    // - Firestore Ê≤íÊúâ„ÄÅÊú¨Âú∞Êúâ -> Êú¨Âú∞Âà™Èô§
                    // - ÂÖ©ÈÇäÈÉΩÊúâ -> Êú¨Âú∞Ë¶ÜÂØ´ÁÇ∫ Firestore ÁöÑÂÖßÂÆπ
                    const mergeExpenses = (remoteExpenses) => {
                        // ÂÖàÂ∞áÈÅ†Á´ØË≥áÊñôËΩâÊàêÊú¨Âú∞Ê†ºÂºèÔºàÂåÖÂê´ orderÔºâ
                        const remoteFormatted = remoteExpenses.map((exp) => {
                            // ËôïÁêÜËàäË≥áÊñôÔºöÂ¶ÇÊûúÊ≤íÊúâ splitParticipants ÊàñÁÇ∫Á©∫Èô£ÂàóÔºå‰ΩøÁî®Áï∂ÂâçÂÖ®Âì°‰ΩúÁÇ∫È†êË®≠ÂÄº
                            let splitParts = exp.splitParticipants;
                            if (!splitParts || !Array.isArray(splitParts) || splitParts.length === 0) {
                                // ËàäË≥áÊñôÊàñÁ©∫Èô£ÂàóÔºö‰ΩøÁî®Áï∂ÂâçÂÖ®Âì°ÂàóË°®ÔºàÈÄôÊòØÂêàÁêÜÁöÑÈ†êË®≠ÂÄºÔºâ
                                splitParts = [...participants.value];
                            }
                            return {
                                item: exp.item,
                                amount: exp.amount,
                                payer: exp.payer,
                                order: exp.order || null,
                                splitParticipants: splitParts, // Á¢∫‰øùÊ∞∏ÈÅ†ÊúâÊòéÁ¢∫ÁöÑÂÄº
                            };
                        });

                        // Âª∫Á´ãÊú¨Âú∞ÁöÑ mapÔºàkey ÁÇ∫ orderÔºâ
                        const localByOrder = new Map();
                        expenses.value.forEach((exp, index) => {
                            if (exp.order) {
                                localByOrder.set(exp.order, { exp, index });
                            }
                        });

                        // Âª∫Á´ã Firestore ÁöÑ order set
                        const remoteOrderSet = new Set(remoteFormatted.filter((e) => e.order).map((e) => e.order));

                        let hasChanges = false;
                        const updatedExpenses = [...expenses.value];

                        // ÊÉÖÂ¢É 1 & 3Ôºö
                        // - Firestore ÊúâÁöÑ order„ÄÅÊú¨Âú∞Ê≤íÊúâ -> Êñ∞Â¢ûÂà∞Êú¨Âú∞
                        // - Firestore ËàáÊú¨Âú∞ÈÉΩÊúâÁöÑ order -> ‰ª• Firestore ÁÇ∫Ê∫ñÊõ¥Êñ∞Êú¨Âú∞
                        remoteFormatted.forEach((remoteExp) => {
                            if (!remoteExp.order) {
                                // Ê≤íÊúâ order ÁöÑËàäË≥áÊñôÊö´ÊôÇÁï•ÈÅéÔºàÈÅøÂÖçË™§Âà§Ôºâ
                                return;
                            }

                            const localEntry = localByOrder.get(remoteExp.order);
                            if (!localEntry) {
                                // Êú¨Âú∞Ê≤íÊúâÈÄôÂÄã orderÔºåÁõ¥Êé•Êñ∞Â¢û
                                updatedExpenses.push({ ...remoteExp });
                                hasChanges = true;
                            } else {
                                const { exp, index } = localEntry;
                                // ÊØîÂ∞çÊ¨Ñ‰ΩçÊòØÂê¶ÊúâËÆäÊõ¥
                                if (
                                    exp.item !== remoteExp.item ||
                                    exp.amount !== remoteExp.amount ||
                                    exp.payer !== remoteExp.payer ||
                                    JSON.stringify(exp.splitParticipants || []) !==
                                        JSON.stringify(remoteExp.splitParticipants || [])
                                ) {
                                    updatedExpenses[index] = { ...remoteExp };
                                    hasChanges = true;
                                }
                            }
                        });

                        // ÊÉÖÂ¢É 2Ôºö
                        // Firestore Ê≤íÊúâÔºå‰ΩÜÊú¨Âú∞ÊúâÁöÑ order -> ÂæûÊú¨Âú∞Âà™Èô§
                        const indexesToRemove = [];
                        updatedExpenses.forEach((exp, index) => {
                            if (!exp.order) return; // Ê≤íÊúâ order ÁöÑËàäË≥áÊñôÊö´ÊôÇ‰øùÁïô
                            if (!remoteOrderSet.has(exp.order)) {
                                indexesToRemove.push(index);
                            }
                        });
                        if (indexesToRemove.length > 0) {
                            hasChanges = true;
                            // ÂæûÂæåÈù¢ÈñãÂßãÂà™ÔºåÈÅøÂÖçÁ¥¢Âºï‰ΩçÁßª
                            indexesToRemove
                                .sort((a, b) => b - a)
                                .forEach((idx) => {
                                    updatedExpenses.splice(idx, 1);
                                });
                        }

                        if (!hasChanges) {
                            console.log('‚úÖ Expenses ÁÑ°ËÆäÊõ¥ÔºåÁÑ°ÈúÄÊõ¥Êñ∞');
                            return;
                        }

                        console.log('üîÑ ÂÅµÊ∏¨Âà∞ expenses ËÆäÊõ¥ÔºåÈñãÂßã‰æùÊìö order Ëàá Firestore Âêà‰Ωµ:', {
                            localCount: expenses.value.length,
                            remoteCount: remoteFormatted.length,
                        });

                        // Ê®ôË®òÁÇ∫Êú¨Âú∞Êõ¥Êñ∞ÔºåÈÅøÂÖçËß∏ÁôºÁõ£ËÅΩÂô®
                        isLocalUpdate = true;

                        expenses.value = updatedExpenses;

                        // ÂÑ≤Â≠òÂà∞ localStorage
                        if (currentTripId.value) {
                            localStorage.setItem(`${currentTripId.value}_exp`, JSON.stringify(expenses.value));
                        }

                        console.log('‚úÖ Expenses Â∑≤‰æùÊìö Firestore ÊúÄÊñ∞Ë≥áÊñôÂÆåÊàêÂêà‰Ωµ:', {
                            total: expenses.value.length,
                        });
                    };

                    // Ê™¢Êü• Firebase ÂíåÈõ≤Á´ØÁãÄÊÖãÁöÑËºîÂä©ÂáΩÊï∏
                    const checkCloudFirebaseReady = async () => {
                        if (!useFirebase || !cloudTripId.value) return null;
                        const result = await checkFirebaseReady();
                        return result.ready ? result.db : null;
                    };

                    // ‰æùÁÖß orderÔºàÊôÇÈñìÊà≥ + payerNameÔºâÊñ∞Â¢û‰∏ÄÁ≠Ü sharedExpenses Âà∞ FirestoreÔºà‰ΩøÁî® order ‰ΩúÁÇ∫Êñá‰ª∂ IDÔºâ
                    const addExpenseToCloudByOrder = async (expense) => {
                        try {
                            if (!expense?.order) return;
                            const firestoreDb = await checkCloudFirebaseReady();
                            if (!firestoreDb) return;

                            const firestoreModule = await getFirestoreModule();
                            const { collection, doc, setDoc, Timestamp } = firestoreModule;

                            const expensesCollection = collection(
                                firestoreDb,
                                `trips/${cloudTripId.value}/sharedExpenses`
                            );

                            // ‰ΩøÁî® order ‰ΩúÁÇ∫Êñá‰ª∂ IDÔºåÁ¢∫‰øùËàáÊú¨Âú∞ÂîØ‰∏ÄË≠òÂà•‰∏ÄËá¥
                            const expenseDocRef = doc(expensesCollection, expense.order);

                            // Á¢∫‰øù splitParticipants ÊúâÊòéÁ¢∫ÁöÑÂÄºÔºà‰∏çËÉΩÊòØÁ©∫Èô£ÂàóÔºâ
                            let splitParts = expense.splitParticipants;
                            if (!splitParts || !Array.isArray(splitParts) || splitParts.length === 0) {
                                // Â¶ÇÊûúÊ≤íÊúâÂàÜÊî§ÊàêÂì°Ôºå‰ΩøÁî®Áï∂ÂâçÂÖ®Âì°ÂàóË°®
                                splitParts = [...participants.value];
                            }

                            await setDoc(expenseDocRef, {
                                item: expense.item,
                                amount: expense.amount,
                                payerName: expense.payer,
                                order: expense.order,
                                splitParticipants: splitParts, // Á¢∫‰øùÊ∞∏ÈÅ†ÊúâÊòéÁ¢∫ÁöÑÂÄº
                                createdAt: Timestamp.now(),
                            });

                            console.log('‚úÖ Â∑≤Êñ∞Â¢û Firestore Â∏≥ÂãôÔºàorder =', expense.order, 'Ôºâ');
                        } catch (error) {
                            console.error('‚ùå Êñ∞Â¢û Firestore Â∏≥ÂãôÂ§±ÊïóÔºà‰æù orderÔºâ:', error);
                        }
                    };

                    // ÂÄã‰∫∫Ë®òÂ∏≥Ôºö‰∏äÂÇ≥Âà∞ FirebaseÔºà‰∏çË®≠ÁΩÆÁõ£ËÅΩÂô®Ôºâ
                    const addPersonalExpenseToCloud = async (expense) => {
                        try {
                            if (!expense?.order) return;
                            const firestoreDb = await checkCloudFirebaseReady();
                            if (!firestoreDb) return;

                            const firestoreModule = await getFirestoreModule();
                            const { collection, doc, setDoc, Timestamp } = firestoreModule;

                            const personalExpensesCollection = collection(
                                firestoreDb,
                                `trips/${cloudTripId.value}/personalExpenses`
                            );

                            // ‰ΩøÁî® order ‰ΩúÁÇ∫Êñá‰ª∂ ID
                            const expenseDocRef = doc(personalExpensesCollection, expense.order);

                            await setDoc(expenseDocRef, {
                                item: expense.item,
                                amount: expense.amount,
                                payerName: expense.payer,
                                order: expense.order,
                                createdAt: Timestamp.now(),
                            });

                            console.log('‚úÖ Â∑≤Êñ∞Â¢ûÂÄã‰∫∫Ë®òÂ∏≥Âà∞ FirestoreÔºàorder =', expense.order, 'Ôºâ');
                        } catch (error) {
                            console.error('‚ùå Êñ∞Â¢ûÂÄã‰∫∫Ë®òÂ∏≥Âà∞ Firestore Â§±Êïó:', error);
                        }
                    };

                    // ÂÄã‰∫∫Ë®òÂ∏≥ÔºöÂæû Firebase Âà™Èô§
                    const deletePersonalExpenseFromCloud = async (order) => {
                        try {
                            if (!order) return;
                            const firestoreDb = await checkCloudFirebaseReady();
                            if (!firestoreDb) return;

                            const firestoreModule = await getFirestoreModule();
                            const { collection, doc, deleteDoc } = firestoreModule;

                            const personalExpensesCollection = collection(
                                firestoreDb,
                                `trips/${cloudTripId.value}/personalExpenses`
                            );

                            const expenseDocRef = doc(personalExpensesCollection, order);
                            await deleteDoc(expenseDocRef);

                            console.log('‚úÖ Â∑≤Âà™Èô§ÂÄã‰∫∫Ë®òÂ∏≥Ôºàorder =', order, 'Ôºâ');
                        } catch (error) {
                            console.error('‚ùå Âà™Èô§ÂÄã‰∫∫Ë®òÂ∏≥Â§±Êïó:', error);
                        }
                    };

                    // ‰æùÁÖß orderÔºàÊôÇÈñìÊà≥ + payerNameÔºâÂà™Èô§ Firestore ‰∏äÂ∞çÊáâÁöÑ sharedExpenses Êñá‰ª∂
                    const deleteExpenseFromCloudByOrder = async (order) => {
                        try {
                            const firestoreDb = await checkCloudFirebaseReady();
                            if (!firestoreDb) return;

                            const firestoreModule = await getFirestoreModule();
                            const { collection, query, where, getDocs, deleteDoc } = firestoreModule;

                            const expensesCollection = collection(
                                firestoreDb,
                                `trips/${cloudTripId.value}/sharedExpenses`
                            );
                            const q = query(expensesCollection, where('order', '==', order));
                            const snapshot = await getDocs(q);

                            if (snapshot.empty) {
                                console.log('‚ö†Ô∏è Firestore ‰∏≠Êâæ‰∏çÂà∞Â∞çÊáâÁöÑÂ∏≥ÂãôÔºàorder =', order, 'Ôºâ');
                                return;
                            }

                            for (const docSnap of snapshot.docs) {
                                await deleteDoc(docSnap.ref);
                            }

                            console.log('‚úÖ Â∑≤Âà™Èô§ Firestore Â∏≥ÂãôÔºàorder =', order, 'ÔºâÔºåÁ≠ÜÊï∏Ôºö', snapshot.size);
                        } catch (error) {
                            console.error('‚ùå Âà™Èô§ Firestore Â∏≥ÂãôÂ§±ÊïóÔºà‰æù orderÔºâ:', error);
                        }
                    };

                    // ÂæûÊ∫êÈ†≠È©óË≠â Firebase ÈÄ£Á∑ö
                    const verifyFirebaseConnection = async () => {
                        console.log('üîç ÈñãÂßãÂæûÊ∫êÈ†≠È©óË≠â Firebase ÈÄ£Á∑ö...');
                        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

                        const results = {
                            step1_useFirebase: false,
                            step2_firebaseConfig: false,
                            step3_sdkLoaded: false,
                            step4_appInstance: false,
                            step5_db: false,
                            step6_testQuery: false,
                            step7_testWrite: false,
                            step8_testUpdate: false,
                            step9_testDelete: false,
                        };

                        // Step 1: Ê™¢Êü• useFirebase Ë®≠ÂÆö
                        console.log('üìã Step 1: Ê™¢Êü• useFirebase Ë®≠ÂÆö');
                        console.log('   useFirebase =', useFirebase);
                        if (useFirebase) {
                            results.step1_useFirebase = true;
                            console.log('   ‚úÖ useFirebase Â∑≤ÂïüÁî®');
                        } else {
                            console.log('   ‚ùå useFirebase Êú™ÂïüÁî®');
                            console.log('   üí° Ë´ãÂ∞á useFirebase Ë®≠ÁÇ∫ true');
                            return { success: false, results, error: 'useFirebase Êú™ÂïüÁî®' };
                        }
                        console.log('');

                        // Step 2: Ê™¢Êü• FirebaseConfig
                        console.log('üìã Step 2: Ê™¢Êü• FirebaseConfig');
                        try {
                            if (typeof FirebaseConfig === 'undefined') {
                                console.log('   ‚ùå FirebaseConfig Êú™ÂÆöÁæ©');
                                console.log('   üí° Ë´ãÁ¢∫Ë™ç data/trip-data.js ‰∏≠ÊúâÊ≠£Á¢∫Â∞éÂá∫ FirebaseConfig');
                                return { success: false, results, error: 'FirebaseConfig Êú™ÂÆöÁæ©' };
                            }
                            console.log('   ‚úÖ FirebaseConfig Â∑≤ËºâÂÖ•');
                            console.log('   üìù Config ÂÖßÂÆπ:', {
                                apiKey: FirebaseConfig.apiKey ? 'Â∑≤Ë®≠ÂÆö' : 'Êú™Ë®≠ÂÆö',
                                authDomain: FirebaseConfig.authDomain,
                                projectId: FirebaseConfig.projectId,
                                storageBucket: FirebaseConfig.storageBucket,
                                messagingSenderId: FirebaseConfig.messagingSenderId,
                                appId: FirebaseConfig.appId,
                            });
                            results.step2_firebaseConfig = true;
                        } catch (e) {
                            console.log('   ‚ùå FirebaseConfig ËºâÂÖ•Â§±Êïó:', e);
                            return { success: false, results, error: 'FirebaseConfig ËºâÂÖ•Â§±Êïó' };
                        }
                        console.log('');

                        // Step 3: Ê™¢Êü• Firebase SDK ÊòØÂê¶ËºâÂÖ•
                        console.log('üìã Step 3: Ê™¢Êü• Firebase SDK ÊòØÂê¶ËºâÂÖ•');
                        try {
                            const firebaseApp = await loadFirebaseApp();
                            if (firebaseApp && firebaseApp.initializeApp) {
                                console.log('   ‚úÖ Firebase App SDK Â∑≤ËºâÂÖ•');
                                results.step3_sdkLoaded = true;
                            } else {
                                console.log('   ‚ùå Firebase App SDK ËºâÂÖ•Â§±Êïó');
                                return { success: false, results, error: 'Firebase App SDK ËºâÂÖ•Â§±Êïó' };
                            }
                        } catch (e) {
                            console.log('   ‚ùå Firebase App SDK ËºâÂÖ•ÈåØË™§:', e);
                            return { success: false, results, error: 'Firebase App SDK ËºâÂÖ•ÈåØË™§: ' + e.message };
                        }
                        console.log('');

                        // Step 4: Ê™¢Êü• appInstance
                        console.log('üìã Step 4: Ê™¢Êü• appInstance ÂàùÂßãÂåñ');
                        console.log('   Á≠âÂæÖ appInstance ÂàùÂßãÂåñ...');
                        let attempts = 0;
                        while (!appInstance && attempts < 50) {
                            await new Promise((resolve) => setTimeout(resolve, 100));
                            attempts++;
                        }
                        if (appInstance) {
                            console.log('   ‚úÖ appInstance Â∑≤ÂàùÂßãÂåñ');
                            console.log('   üìù App ÂêçÁ®±:', appInstance.name);
                            results.step4_appInstance = true;
                        } else {
                            console.log('   ‚ùå appInstance ÂàùÂßãÂåñÂ§±ÊïóÔºàÁ≠âÂæÖË∂ÖÊôÇÔºâ');
                            console.log('   üí° Ë´ãÊ™¢Êü• FirebaseConfig ÊòØÂê¶Ê≠£Á¢∫');
                            return { success: false, results, error: 'appInstance ÂàùÂßãÂåñÂ§±Êïó' };
                        }
                        console.log('');

                        // Step 5: Ê™¢Êü• db (Firestore)
                        console.log('üìã Step 5: Ê™¢Êü• Firestore Ë≥áÊñôÂ∫´ÈÄ£Á∑ö');
                        console.log('   Á≠âÂæÖ db ÂàùÂßãÂåñ...');
                        const firestoreDb = await waitForDb();
                        if (firestoreDb) {
                            console.log('   ‚úÖ Firestore db Â∑≤ÂàùÂßãÂåñ');
                            results.step5_db = true;
                        } else {
                            console.log('   ‚ùå Firestore db ÂàùÂßãÂåñÂ§±ÊïóÔºàÁ≠âÂæÖË∂ÖÊôÇÔºâ');
                            return { success: false, results, error: 'Firestore db ÂàùÂßãÂåñÂ§±Êïó' };
                        }
                        console.log('');

                        // Step 6: Ê∏¨Ë©¶ Firestore Êü•Ë©¢
                        console.log('üìã Step 6: Ê∏¨Ë©¶ Firestore Êü•Ë©¢ÔºàËÆÄÂèñ trips ÈõÜÂêàÔºâ');
                        try {
                            const firestoreModule = await getFirestoreModule();
                            const { collection, getDocs, limit } = firestoreModule;
                            const testCollection = collection(firestoreDb, 'trips');
                            const testSnapshot = await getDocs(testCollection);
                            console.log('   ‚úÖ Firestore Êü•Ë©¢ÊàêÂäü');
                            console.log('   üìä Êü•Ë©¢ÁµêÊûú:', {
                                size: testSnapshot.size,
                                empty: testSnapshot.empty,
                                message: testSnapshot.empty
                                    ? 'trips ÈõÜÂêàÂ≠òÂú®‰ΩÜÁÇ∫Á©∫ÔºàÈÄôÊòØÊ≠£Â∏∏ÁöÑÔºåÂ¶ÇÊûúÈÇÑÊ≤íÊúâ‰∏äÂÇ≥Ë≥áÊñôÔºâ'
                                    : 'ÊâæÂà∞ ' + testSnapshot.size + ' ÂÄãÊñá‰ª∂',
                            });
                            results.step6_testQuery = true;
                        } catch (e) {
                            console.log('   ‚ùå Firestore Êü•Ë©¢Â§±Êïó:', e);
                            console.log('   üí° ÂèØËÉΩÁöÑÂéüÂõ†Ôºö');
                            console.log('      - Firestore Ë¶èÂâáÈôêÂà∂ÔºàËÆÄÂèñÊ¨äÈôêÊú™ÈñãÊîæÔºâ');
                            console.log('      - Á∂≤Ë∑ØÈÄ£Á∑öÂïèÈ°å');
                            console.log('      - Firebase Â∞àÊ°àË®≠ÂÆöÂïèÈ°å');
                            return { success: false, results, error: 'Firestore Êü•Ë©¢Â§±Êïó: ' + e.message };
                        }
                        console.log('');

                        // Step 7: Ê∏¨Ë©¶ÂØ´ÂÖ•Ê¨äÈôê
                        console.log('üìã Step 7: Ê∏¨Ë©¶ Firestore ÂØ´ÂÖ•Ê¨äÈôê');
                        try {
                            const firestoreModule = await getFirestoreModule();
                            const { collection, addDoc, Timestamp, deleteDoc, doc } = firestoreModule;
                            const testDocRef = doc(firestoreDb, 'trips', '_permission_test_' + Date.now());

                            // ÂòóË©¶ÂØ´ÂÖ•Ê∏¨Ë©¶Êñá‰ª∂
                            const testData = {
                                test: true,
                                timestamp: Timestamp.now(),
                                message: 'ÈÄôÊòØ‰∏ÄÂÄãÊ¨äÈôêÊ∏¨Ë©¶Êñá‰ª∂ÔºåÂèØ‰ª•ÂÆâÂÖ®Âà™Èô§',
                            };

                            // ‰ΩøÁî® setDoc ‰æÜÊ∏¨Ë©¶ÂØ´ÂÖ•Ê¨äÈôêÔºàÂ¶ÇÊûúÊñá‰ª∂‰∏çÂ≠òÂú®ÊúÉÂâµÂª∫Ôºâ
                            const { setDoc } = firestoreModule;
                            await setDoc(testDocRef, testData);
                            console.log('   ‚úÖ Firestore ÂØ´ÂÖ•Ê¨äÈôêÊ≠£Â∏∏');
                            console.log('   üìù Ê∏¨Ë©¶Êñá‰ª∂ ID:', testDocRef.id);
                            results.step7_testWrite = true;

                            // Step 8: Ê∏¨Ë©¶Êõ¥Êñ∞Ê¨äÈôê
                            console.log('');
                            console.log('üìã Step 8: Ê∏¨Ë©¶ Firestore Êõ¥Êñ∞Ê¨äÈôê');
                            try {
                                const { updateDoc } = firestoreModule;
                                await updateDoc(testDocRef, {
                                    updated: true,
                                    updateTime: Timestamp.now(),
                                });
                                console.log('   ‚úÖ Firestore Êõ¥Êñ∞Ê¨äÈôêÊ≠£Â∏∏');
                                results.step8_testUpdate = true;
                            } catch (e) {
                                console.log('   ‚ùå Firestore Êõ¥Êñ∞Ê¨äÈôêÂ§±Êïó:', e.message);
                                console.log('   üí° ÂèØËÉΩÁöÑÂéüÂõ†Ôºö');
                                console.log('      - Firestore Ë¶èÂâáÈôêÂà∂Êõ¥Êñ∞Êìç‰Ωú');
                                console.log('      - ÈúÄË¶ÅÈ©óË≠âË∫´‰ªΩÊâçËÉΩÊõ¥Êñ∞');
                                results.step8_testUpdate = false;
                            }

                            // Step 9: Ê∏¨Ë©¶Âà™Èô§Ê¨äÈôê
                            console.log('');
                            console.log('üìã Step 9: Ê∏¨Ë©¶ Firestore Âà™Èô§Ê¨äÈôê');
                            try {
                                await deleteDoc(testDocRef);
                                console.log('   ‚úÖ Firestore Âà™Èô§Ê¨äÈôêÊ≠£Â∏∏');
                                console.log('   üóëÔ∏è Ê∏¨Ë©¶Êñá‰ª∂Â∑≤Âà™Èô§');
                                results.step9_testDelete = true;
                            } catch (e) {
                                console.log('   ‚ùå Firestore Âà™Èô§Ê¨äÈôêÂ§±Êïó:', e.message);
                                console.log('   üí° ÂèØËÉΩÁöÑÂéüÂõ†Ôºö');
                                console.log('      - Firestore Ë¶èÂâáÈôêÂà∂Âà™Èô§Êìç‰Ωú');
                                console.log('      - ÈúÄË¶ÅÈ©óË≠âË∫´‰ªΩÊâçËÉΩÂà™Èô§');
                                console.log('   ‚ö†Ô∏è Ê≥®ÊÑèÔºöÊ∏¨Ë©¶Êñá‰ª∂ÂèØËÉΩ‰ªçÂ≠òÂú®ÊñºË≥áÊñôÂ∫´‰∏≠ÔºåË´ãÊâãÂãïÂà™Èô§');
                                results.step9_testDelete = false;
                            }
                        } catch (e) {
                            console.log('   ‚ùå Firestore ÂØ´ÂÖ•Ê¨äÈôêÂ§±Êïó:', e.message);
                            console.log('   üí° ÂèØËÉΩÁöÑÂéüÂõ†Ôºö');
                            console.log('      - Firestore Ë¶èÂâáÈôêÂà∂ÂØ´ÂÖ•Êìç‰ΩúÔºàÊúÄÂ∏∏Ë¶ãÔºâ');
                            console.log('      - ÈúÄË¶ÅÈ©óË≠âË∫´‰ªΩÊâçËÉΩÂØ´ÂÖ•');
                            console.log('      - Á∂≤Ë∑ØÈÄ£Á∑öÂïèÈ°å');
                            console.log('');
                            console.log('   üìñ Â¶Ç‰ΩïÊ™¢Êü• Firestore Ë¶èÂâáÔºö');
                            console.log('      1. ÂâçÂæÄ Firebase Console: https://console.firebase.google.com/');
                            console.log('      2. ÈÅ∏ÊìáÂ∞àÊ°à:', FirebaseConfig.projectId);
                            console.log('      3. ÈÄ≤ÂÖ• Firestore Database > Rules');
                            console.log('      4. Ê™¢Êü•Ë¶èÂâáÊòØÂê¶ÂÖÅË®±ËÆÄÂØ´Êìç‰Ωú');
                            console.log('      5. È†êË®≠Ë¶èÂâáÈÄöÂ∏∏ÊòØÔºö');
                            console.log('         match /{document=**} {');
                            console.log('           allow read, write: if false;');
                            console.log('         }');
                            console.log('      6. Â¶ÇÈúÄÈñãÊîæÊ¨äÈôêÔºàÂÉÖÊ∏¨Ë©¶Áî®ÔºâÔºåÂèØÊö´ÊôÇÊîπÁÇ∫Ôºö');
                            console.log('         match /{document=**} {');
                            console.log('           allow read, write: if true;');
                            console.log('         }');
                            console.log('      ‚ö†Ô∏è Ë≠¶ÂëäÔºöÈñãÊîæÊâÄÊúâÊ¨äÈôêÂÉÖÈÅ©Áî®ÊñºÊ∏¨Ë©¶ÔºåÁîüÁî¢Áí∞Â¢ÉË´ãË®≠ÂÆöÈÅ©Áï∂Ë¶èÂâáÔºÅ');
                            results.step7_testWrite = false;
                            results.step8_testUpdate = false;
                            results.step9_testDelete = false;
                        }
                        console.log('');

                        // Á∏ΩÁµê
                        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                        const allPassed = Object.values(results).every((v) => v === true);
                        if (allPassed) {
                            console.log('üéâ ÊâÄÊúâÊ™¢Êü•ÈÄöÈÅéÔºÅFirebase ÈÄ£Á∑öÊ≠£Â∏∏');
                            console.log('‚úÖ ÊÇ®ÂèØ‰ª•ÈñãÂßã‰ΩøÁî® Firebase ÂäüËÉΩ‰∫Ü');
                        } else {
                            console.log('‚ö†Ô∏è ÈÉ®ÂàÜÊ™¢Êü•Êú™ÈÄöÈÅéÔºåË´ãÊü•Áúã‰∏äÊñπË©≥Á¥∞Ë≥áË®ä');
                        }
                        console.log('üìä Ê™¢Êü•ÁµêÊûúÊëòË¶Å:', results);

                        return {
                            success: allPassed,
                            results,
                            message: allPassed ? 'Firebase ÈÄ£Á∑öÊ≠£Â∏∏' : 'ÈÉ®ÂàÜÊ™¢Êü•Êú™ÈÄöÈÅé',
                        };
                    };

                    // Áµ±‰∏ÄÁç≤Âèñ Firestore Ê®°ÁµÑÔºà‰ΩøÁî®Á∑©Â≠òÔºåÈÅøÂÖçÈáçË§áËºâÂÖ•Ôºâ
                    // Ê≥®ÊÑèÔºögetFirestoreModule Âíå waitForDb Â∑≤Âú®ÂÖ®Â±ÄÂÆöÁæ©

                    // Ê™¢Êü•Áï∂ÂâçÊóÖÁ®ãÁöÑÈõ≤Á´ØÁãÄÊÖã
                    const checkCloudStatus = () => {
                        if (!currentTripId.value) {
                            console.warn('‚ö†Ô∏è Ê≤íÊúâÁï∂ÂâçÊóÖÁ®ã');
                            return {
                                hasTrip: false,
                                message: 'Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÂÄãÊóÖÁ®ã',
                            };
                        }

                        const cloudDataStr = localStorage.getItem(`${currentTripId.value}_cloud`);
                        const cloudData = cloudDataStr ? JSON.parse(cloudDataStr) : null;

                        const getStorageStatus = (key) =>
                            localStorage.getItem(`${currentTripId.value}_${key}`) ? 'Â≠òÂú®' : '‰∏çÂ≠òÂú®';

                        const status = {
                            currentTripId: currentTripId.value,
                            hasCloudData: !!cloudData,
                            cloudData: cloudData,
                            vueState: {
                                isCloudTrip: isCloudTrip.value,
                                cloudTripId: cloudTripId.value,
                                inviteCode: inviteCode.value,
                            },
                            localStorage: {
                                days: getStorageStatus('days'),
                                expenses: getStorageStatus('exp'),
                                config: getStorageStatus('config'),
                                cloud: cloudDataStr ? 'Â≠òÂú®' : '‰∏çÂ≠òÂú®',
                            },
                        };

                        console.log('üìä Áï∂ÂâçÊóÖÁ®ãÈõ≤Á´ØÁãÄÊÖã:', status);

                        if (!cloudData) {
                            console.log('üí° ÊèêÁ§∫ÔºöÊ≠§ÊóÖÁ®ãÂ∞öÊú™‰∏äÂÇ≥Âà∞ Firebase');
                            console.log('üí° ‰ΩøÁî® window.uploadToCloud() ‰æÜ‰∏äÂÇ≥ÊóÖÁ®ãÂà∞Èõ≤Á´Ø');
                        } else {
                            console.log('‚úÖ Ê≠§ÊóÖÁ®ãÂ∑≤ÈÄ£ÁµêÂà∞ Firebase');
                            console.log('üìã Cloud Trip ID:', cloudData.cloudTripId);
                            console.log('üîó ÈÇÄË´ãÁ¢º:', cloudData.inviteCode);
                        }

                        return status;
                    };

                    // Ê∏¨Ë©¶ Firebase ÈÄ£Á∑öÂíåË≥áÊñôÊíàÂèñÔºàÁî®ÊñºË™øË©¶Ôºâ
                    const testFirebaseConnection = async () => {
                        console.log('üß™ ÈñãÂßãÊ∏¨Ë©¶ Firebase ÈÄ£Á∑ö...');

                        // ÂÖàÊ™¢Êü•Èõ≤Á´ØÁãÄÊÖã
                        const cloudStatus = checkCloudStatus();

                        console.log('üìä Áï∂ÂâçÁãÄÊÖã:', {
                            useFirebase,
                            cloudTripId: cloudTripId.value,
                            currentTripId: currentTripId.value,
                            isCloudTrip: isCloudTrip.value,
                        });

                        if (!useFirebase) {
                            console.error('‚ùå Firebase Êú™ÂïüÁî®');
                            return { success: false, error: 'Firebase Êú™ÂïüÁî®' };
                        }

                        const firestoreDb = await waitForDb();
                        if (!firestoreDb) {
                            console.error('‚ùå Firebase ÈÄ£Á∑öÂ§±Êïó');
                            return { success: false, error: 'Firebase ÈÄ£Á∑öÂ§±Êïó' };
                        }

                        console.log('‚úÖ Firebase ÈÄ£Á∑öÊàêÂäü');

                        if (!cloudTripId.value) {
                            console.warn('‚ö†Ô∏è Ê≤íÊúâ cloudTripIdÔºåÁÑ°Ê≥ïÊ∏¨Ë©¶Ë≥áÊñôÊíàÂèñ');
                            console.log('üí° Ëß£Ê±∫ÊñπÊ≥ïÔºö');
                            console.log('   1. Ê™¢Êü• localStorage ÊòØÂê¶ÊúâÈõ≤Á´ØË≥áÊñôÔºöwindow.checkCloudStatus()');
                            console.log('   2. Â¶ÇÊûúÊ≤íÊúâÔºåÂÖà‰∏äÂÇ≥ÊóÖÁ®ãÔºöwindow.uploadToCloud()');
                            console.log('   3. ÊàñËÄÖ‰ΩøÁî®ÈÇÄË´ãÁ¢ºËºâÂÖ•Èõ≤Á´ØÊóÖÁ®ã');
                            return {
                                success: false,
                                error: 'Ê≤íÊúâ cloudTripId',
                                cloudStatus: cloudStatus,
                                suggestion: 'Ë´ãÂÖà‰∏äÂÇ≥ÊóÖÁ®ãÂà∞Èõ≤Á´ØÊàñ‰ΩøÁî®ÈÇÄË´ãÁ¢ºËºâÂÖ•Èõ≤Á´ØÊóÖÁ®ã',
                            };
                        }

                        try {
                            const firestoreModule = await getFirestoreModule();
                            const { collection, getDocs, doc, getDoc } = firestoreModule;

                            // Ê∏¨Ë©¶ÊíàÂèñ trip ‰∏ªÊñá‰ª∂
                            console.log('üìã Ê∏¨Ë©¶ÊíàÂèñ trip ‰∏ªÊñá‰ª∂...');
                            const tripDoc = await getDoc(doc(firestoreDb, `trips/${cloudTripId.value}`));
                            const tripData = tripDoc.exists() ? tripDoc.data() : null;
                            console.log('üìã Trip ‰∏ªÊñá‰ª∂:', {
                                exists: tripDoc.exists(),
                                data: tripData,
                            });

                            // Ê∏¨Ë©¶ÊíàÂèñ days
                            console.log('üìÖ Ê∏¨Ë©¶ÊíàÂèñ days Â≠êÈõÜÂêà...');
                            const daysSnapshot = await getDocs(
                                collection(firestoreDb, `trips/${cloudTripId.value}/days`)
                            );
                            console.log('üìÖ Days Â≠êÈõÜÂêà:', {
                                size: daysSnapshot.size,
                                docs: daysSnapshot.docs.map((d) => ({
                                    id: d.id,
                                    data: d.data(),
                                })),
                            });

                            // Ê∏¨Ë©¶ÊíàÂèñ expenses
                            console.log('üí∞ Ê∏¨Ë©¶ÊíàÂèñ expenses Â≠êÈõÜÂêà...');
                            const expensesSnapshot = await getDocs(
                                collection(firestoreDb, `trips/${cloudTripId.value}/sharedExpenses`)
                            );
                            console.log('üí∞ Expenses Â≠êÈõÜÂêà:', {
                                size: expensesSnapshot.size,
                                docs: expensesSnapshot.docs.map((d) => ({
                                    id: d.id,
                                    data: d.data(),
                                })),
                            });

                            const result = {
                                success: true,
                                trip: {
                                    exists: tripDoc.exists(),
                                    data: tripData,
                                },
                                days: {
                                    count: daysSnapshot.size,
                                    docs: daysSnapshot.docs.map((d) => d.data()),
                                },
                                expenses: {
                                    count: expensesSnapshot.size,
                                    docs: expensesSnapshot.docs.map((d) => d.data()),
                                },
                            };

                            console.log('üéâ Ê∏¨Ë©¶ÂÆåÊàêÔºÅÁµêÊûú:', result);
                            return result;
                        } catch (error) {
                            console.error('‚ùå Ê∏¨Ë©¶Â§±Êïó:', error);
                            return { success: false, error: error.message };
                        }
                    };

                    // Áî¢ÁîüÈÇÄË´ãÁ¢º
                    const generateInviteCode = () => {
                        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                        let code = '';
                        for (let i = 0; i < 6; i++) {
                            code += chars.charAt(Math.floor(Math.random() * chars.length));
                        }
                        return code;
                    };

                    // ‰∏äÂÇ≥Âà∞Èõ≤Á´Ø
                    // silent: true ÊôÇ‰∏çÈ°ØÁ§∫„Äå‰∏äÂÇ≥ÊàêÂäü„ÄçÊèêÁ§∫ÔºàÁî®ÊñºËÉåÊôØËá™ÂãïÂêåÊ≠•Ôºâ
                    const uploadToCloud = async (silent = false) => {
                        // Â¶ÇÊûúÊòØËÉåÊôØËá™ÂãïÂêåÊ≠•‰∏îË¢´Ê®ôË®òÁÇ∫ÂèñÊ∂àÔºåÁõ¥Êé•ËøîÂõû
                        if (silent && expensesSyncAbortFlag) {
                            console.log('‚ö†Ô∏è ÂêåÊ≠•Â∑≤Ë¢´ÂèñÊ∂àÔºåÂÅúÊ≠¢‰∏äÂÇ≥');
                            return;
                        }

                        if (!useFirebase) {
                            if (!silent) alert('Firebase Êú™ÂïüÁî®');
                            return;
                        }

                        const firestoreDb = await waitForDb();
                        if (!firestoreDb) {
                            if (!silent) alert('Firebase ÈÄ£Á∑öÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
                            return;
                        }

                        if (days.value.length === 0) {
                            if (!silent) alert('Ë´ãÂÖàÂª∫Á´ãË°åÁ®ã');
                            return;
                        }

                        // ÂÜçÊ¨°Ê™¢Êü•ÊòØÂê¶Ë¢´ÂèñÊ∂àÔºàÂú®Á≠âÂæÖÊúüÈñìÂèØËÉΩË¢´ÂèñÊ∂àÔºâ
                        if (silent && expensesSyncAbortFlag) {
                            console.log('‚ö†Ô∏è ÂêåÊ≠•Â∑≤Ë¢´ÂèñÊ∂àÔºåÂÅúÊ≠¢‰∏äÂÇ≥');
                            return;
                        }

                        isUploading.value = true;

                        try {
                            const firestoreModule = await getFirestoreModule();
                            const { collection, addDoc, doc, setDoc, Timestamp, getDocs, deleteDoc } = firestoreModule;

                            let tripId;
                            let inviteCodeToUse;
                            const wasFirstUpload = !cloudTripId.value; // Âú®Êõ¥Êñ∞ÁãÄÊÖãÂâçË®òÈåÑÊòØÂê¶ÁÇ∫Á¨¨‰∏ÄÊ¨°‰∏äÂÇ≥

                            // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ì‰∏äÂÇ≥ÈÅé
                            if (cloudTripId.value) {
                                // Â∑≤‰∏äÂÇ≥ÈÅéÔºåÊõ¥Êñ∞ÁèæÊúâÊñá‰ª∂
                                tripId = cloudTripId.value;
                                inviteCodeToUse = inviteCode.value || generateInviteCode();

                                // ÈáçË¶ÅÔºöÂú®‰∏äÂÇ≥ÂâçÂÖàÂèñÊ∂àÁõ£ËÅΩÂô®ÔºåÈÅøÂÖçÂà™Èô§Ë≥áÊñôÊôÇËß∏ÁôºÁõ£ËÅΩÂô®Ê∏ÖÁ©∫Êú¨Âú∞Ë≥áÊñô
                                if (expensesUnsubscribe) {
                                    console.log('üîá Êö´ÊôÇÂèñÊ∂àÁõ£ËÅΩÂô®Ôºà‰∏äÂÇ≥‰∏≠Ôºâ');
                                    expensesUnsubscribe();
                                    expensesUnsubscribe = null;
                                }

                                // Ê®ôË®òÁÇ∫Êú¨Âú∞Êõ¥Êñ∞ÔºåÈÅøÂÖç‰ªª‰ΩïÁõ£ËÅΩÂô®Ëß∏Áôº
                                isLocalUpdate = true;

                                // Êõ¥Êñ∞ trips ‰∏ªÊñá‰ª∂ÔºàÂÆåÂÖ®Ë¶ÜËìãÔºå‰∏ç‰ΩøÁî® mergeÔºâ
                                await setDoc(doc(firestoreDb, 'trips', tripId), {
                                    title: setup.value.title || '', // ÊòéÁ¢∫‰øùÂ≠òÊ®ôÈ°åÔºàÊóÖÈÅäÊ®ôÈ°åÔºâ
                                    destination: setup.value.destination || '', // ÊòéÁ¢∫‰øùÂ≠òÂúãÂÆ∂/Âú∞Èªû
                                    startDate: setup.value.startDate,
                                    daysCount: days.value.length,
                                    inviteCode: inviteCodeToUse,
                                    participants: participantsStr.value, // ‰øùÂ≠òÂàÜÂ∏≥ÊàêÂì°
                                    // config ÂÉÖ‰øùÂ≠òÂäüËÉΩÊÄßË®≠ÂÆöÔºåÈÅøÂÖçÊ∑∑ÂÖ• title/destination
                                    config: {
                                        currency: setup.value.currency,
                                        rate: setup.value.rate,
                                        langCode: setup.value.langCode,
                                        langName: setup.value.langName,
                                    },
                                    updatedAt: Timestamp.now(),
                                }); // ‰∏ç‰ΩøÁî® mergeÔºåÂÆåÂÖ®Ë¶ÜËìãÁèæÊúâË≥áÊñô

                                // Ê™¢Êü•ÊòØÂê¶Ë¢´ÂèñÊ∂à
                                if (silent && expensesSyncAbortFlag) {
                                    console.log('‚ö†Ô∏è ÂêåÊ≠•Â∑≤Ë¢´ÂèñÊ∂àÔºåÂÅúÊ≠¢‰∏äÂÇ≥');
                                    isLocalUpdate = false;
                                    return;
                                }

                                // Âà™Èô§ËàäÁöÑ days Â≠êÈõÜÂêàÊñá‰ª∂
                                const oldDaysSnapshot = await getDocs(collection(firestoreDb, `trips/${tripId}/days`));
                                for (const oldDayDoc of oldDaysSnapshot.docs) {
                                    // Ê™¢Êü•ÊòØÂê¶Ë¢´ÂèñÊ∂à
                                    if (silent && expensesSyncAbortFlag) {
                                        console.log('‚ö†Ô∏è ÂêåÊ≠•Â∑≤Ë¢´ÂèñÊ∂àÔºåÂÅúÊ≠¢‰∏äÂÇ≥');
                                        isLocalUpdate = false;
                                        return;
                                    }
                                    await deleteDoc(doc(firestoreDb, `trips/${tripId}/days`, oldDayDoc.id));
                                }

                                // Âè™ÊúâÂú®Êú¨Âú∞Êúâ expenses ÊôÇÊâçÂà™Èô§ËàäÁöÑ sharedExpenses
                                // ÈÅøÂÖçÊú¨Âú∞ÁÇ∫Á©∫ÊôÇÊ∏ÖÁ©∫ÈÅ†Á´ØË≥áÊñô
                                if (expenses.value.length > 0) {
                                    // Ê™¢Êü•ÊòØÂê¶Ë¢´ÂèñÊ∂à
                                    if (silent && expensesSyncAbortFlag) {
                                        console.log('‚ö†Ô∏è ÂêåÊ≠•Â∑≤Ë¢´ÂèñÊ∂àÔºåÂÅúÊ≠¢‰∏äÂÇ≥');
                                        isLocalUpdate = false;
                                        return;
                                    }
                                    const oldExpensesSnapshot = await getDocs(
                                        collection(firestoreDb, `trips/${tripId}/sharedExpenses`)
                                    );
                                    for (const oldExpenseDoc of oldExpensesSnapshot.docs) {
                                        // Ê™¢Êü•ÊòØÂê¶Ë¢´ÂèñÊ∂à
                                        if (silent && expensesSyncAbortFlag) {
                                            console.log('‚ö†Ô∏è ÂêåÊ≠•Â∑≤Ë¢´ÂèñÊ∂àÔºåÂÅúÊ≠¢‰∏äÂÇ≥');
                                            isLocalUpdate = false;
                                            return;
                                        }
                                        await deleteDoc(
                                            doc(firestoreDb, `trips/${tripId}/sharedExpenses`, oldExpenseDoc.id)
                                        );
                                    }
                                }
                            } else {
                                // Á¨¨‰∏ÄÊ¨°‰∏äÂÇ≥ÔºåÂª∫Á´ãÊñ∞Êñá‰ª∂
                                inviteCodeToUse = generateInviteCode();
                                const tripRef = await addDoc(collection(firestoreDb, 'trips'), {
                                    title: setup.value.title || '', // ÊòéÁ¢∫‰øùÂ≠òÊ®ôÈ°åÔºàÊóÖÈÅäÊ®ôÈ°åÔºâ
                                    destination: setup.value.destination || '', // ÊòéÁ¢∫‰øùÂ≠òÂúãÂÆ∂/Âú∞Èªû
                                    startDate: setup.value.startDate,
                                    daysCount: days.value.length,
                                    inviteCode: inviteCodeToUse,
                                    participants: participantsStr.value, // ‰øùÂ≠òÂàÜÂ∏≥ÊàêÂì°
                                    // config ÂÉÖ‰øùÂ≠òÂäüËÉΩÊÄßË®≠ÂÆöÔºåÈÅøÂÖçÊ∑∑ÂÖ• title/destination
                                    config: {
                                        currency: setup.value.currency,
                                        rate: setup.value.rate,
                                        langCode: setup.value.langCode,
                                        langName: setup.value.langName,
                                    },
                                    createdAt: Timestamp.now(),
                                });
                                tripId = tripRef.id;
                            }

                            // Ê™¢Êü•ÊòØÂê¶Ë¢´ÂèñÊ∂àÔºàÂú®‰∏äÂÇ≥ days ÂâçÔºâ
                            if (silent && expensesSyncAbortFlag) {
                                console.log('‚ö†Ô∏è ÂêåÊ≠•Â∑≤Ë¢´ÂèñÊ∂àÔºåÂÅúÊ≠¢‰∏äÂÇ≥');
                                return;
                            }

                            // ‰∏äÂÇ≥ days Â≠êÈõÜÂêà
                            const daysCollection = collection(firestoreDb, `trips/${tripId}/days`);
                            for (let i = 0; i < days.value.length; i++) {
                                // Ê™¢Êü•ÊòØÂê¶Ë¢´ÂèñÊ∂àÔºàÂú®Âæ™Áí∞‰∏≠Ôºâ
                                if (silent && expensesSyncAbortFlag) {
                                    console.log('‚ö†Ô∏è ÂêåÊ≠•Â∑≤Ë¢´ÂèñÊ∂àÔºåÂÅúÊ≠¢‰∏äÂÇ≥');
                                    return;
                                }
                                const day = days.value[i];
                                await addDoc(daysCollection, {
                                    order: i,
                                    date: day.date || '',
                                    shortDate: day.shortDate || '',
                                    fullDate: day.fullDate || '',
                                    title: day.title || '',
                                    flight: day.flight || null,
                                    items: day.items || [],
                                });
                            }

                            // Ê™¢Êü•ÊòØÂê¶Ë¢´ÂèñÊ∂àÔºàÂú®‰∏äÂÇ≥ sharedExpenses ÂâçÔºâ
                            if (silent && expensesSyncAbortFlag) {
                                console.log('‚ö†Ô∏è ÂêåÊ≠•Â∑≤Ë¢´ÂèñÊ∂àÔºåÂÅúÊ≠¢‰∏äÂÇ≥');
                                return;
                            }

                            // ‰∏äÂÇ≥ sharedExpenses Â≠êÈõÜÂêà
                            // Ê≥®ÊÑèÔºöisLocalUpdate Â∑≤Âú®Âà™Èô§Ë≥áÊñôÂâçË®≠ÁΩÆ
                            if (expenses.value.length > 0) {
                                const expensesCollection = collection(firestoreDb, `trips/${tripId}/sharedExpenses`);
                                for (const expense of expenses.value) {
                                    // Ê™¢Êü•ÊòØÂê¶Ë¢´ÂèñÊ∂àÔºàÂú®Âæ™Áí∞‰∏≠Ôºâ
                                    if (silent && expensesSyncAbortFlag) {
                                        console.log('‚ö†Ô∏è ÂêåÊ≠•Â∑≤Ë¢´ÂèñÊ∂àÔºåÂÅúÊ≠¢‰∏äÂÇ≥');
                                        isLocalUpdate = false;
                                        return;
                                    }

                                    // Á¢∫‰øùÊØè‰∏ÄÁ≠ÜÂ∏≥ÂãôÈÉΩÊúâÂîØ‰∏ÄÁöÑ orderÔºàÂ¶ÇËàäË≥áÊñôÊ≤íÊúâÔºåÈÄôË£°Ë£ú‰∏äÔºâ
                                    if (!expense.order) {
                                        expense.order = `${Date.now()}_${expense.payer || 'payer'}`;
                                    }

                                    // Á¢∫‰øù splitParticipants ÊúâÊòéÁ¢∫ÁöÑÂÄºÔºà‰∏çËÉΩÊòØÁ©∫Èô£ÂàóÔºâ
                                    let splitParts = expense.splitParticipants;
                                    if (!splitParts || !Array.isArray(splitParts) || splitParts.length === 0) {
                                        // Â¶ÇÊûúÊ≤íÊúâÂàÜÊî§ÊàêÂì°Ôºå‰ΩøÁî®Áï∂ÂâçÂÖ®Âì°ÂàóË°®
                                        splitParts = [...participants.value];
                                    }

                                    await addDoc(expensesCollection, {
                                        item: expense.item,
                                        amount: expense.amount,
                                        payerName: expense.payer,
                                        order: expense.order,
                                        splitParticipants: splitParts, // Á¢∫‰øùÊ∞∏ÈÅ†ÊúâÊòéÁ¢∫ÁöÑÂÄº
                                        createdAt: Timestamp.now(),
                                    });
                                }
                            }

                            // ÂÑ≤Â≠òÈõ≤Á´ØË≥áË®äÂà∞ localStorage
                            const cloudData = {
                                cloudTripId: tripId,
                                inviteCode: inviteCodeToUse,
                                isCloudTrip: true,
                            };
                            saveToStorage(currentTripId.value, 'cloud', cloudData);

                            // Êõ¥Êñ∞ Vue ÁãÄÊÖã
                            isCloudTrip.value = true;
                            cloudTripId.value = tripId;
                            inviteCode.value = inviteCodeToUse;

                            // Êõ¥Êñ∞ tripList ‰∏≠ÁöÑÊ®ôË®ò
                            const trip = tripList.value.find((t) => t.id === currentTripId.value);
                            if (trip) {
                                trip.isCloudTrip = true;
                                saveTripList();
                            }

                            // Á≠âÂæÖ‰∏ÄÂ∞èÊÆµÊôÇÈñìÁ¢∫‰øùÊâÄÊúâ‰∏äÂÇ≥Êìç‰ΩúÂÆåÊàêÔºåÁÑ∂ÂæåÈáçÁΩÆÊ®ôË®ò
                            await new Promise((resolve) => setTimeout(resolve, 500));
                            isLocalUpdate = false;
                            console.log('‚úÖ ‰∏äÂÇ≥ÂÆåÊàêÔºåÈáçÁΩÆ isLocalUpdate Ê®ôË®ò');

                            // Ë®≠ÂÆöÂç≥ÊôÇÁõ£ËÅΩÂô®ÔºàÁõ£ËÅΩ sharedExpenses ÁöÑËÆäÊõ¥Ôºâ
                            await setupExpensesRealtimeListener();

                            // ÂâçÊôØÊâãÂãï‰∏äÂÇ≥ÊôÇÊâçÈ°ØÁ§∫ÊèêÁ§∫ËàáËá™ÂãïË§áË£ΩÈÇÄË´ãÈÄ£Áµê
                            if (!silent) {
                                alert('‰∏äÂÇ≥ÊàêÂäüÔºÅ');

                                // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÊ¨°‰∏äÂÇ≥ÔºåËá™ÂãïË§áË£ΩÈÇÄË´ãÈÄ£Áµê‰∏¶ÊèêÁ§∫
                                if (wasFirstUpload) {
                                    await copyInviteLink();
                                }
                            }
                        } catch (error) {
                            // Â¶ÇÊûúÊòØÂõ†ÁÇ∫ÂèñÊ∂àËÄåÂ§±ÊïóÔºå‰∏çÈ°ØÁ§∫ÈåØË™§Ë®äÊÅØ
                            if (silent && expensesSyncAbortFlag) {
                                console.log('‚ö†Ô∏è ÂêåÊ≠•Â∑≤Ë¢´ÂèñÊ∂à');
                            } else {
                                console.error('‰∏äÂÇ≥Â§±Êïó:', error);
                                if (!silent) alert('‰∏äÂÇ≥Â§±ÊïóÔºö' + error.message);
                            }
                        } finally {
                            isUploading.value = false;
                            // Á¢∫‰øùÈáçÁΩÆ isLocalUpdate Ê®ôË®òÔºàÈÅøÂÖçÈåØË™§ÊôÇÊ®ôË®ò‰∏ÄÁõ¥ÁÇ∫ trueÔºâ
                            isLocalUpdate = false;
                            // Â¶ÇÊûúÊòØËÉåÊôØËá™ÂãïÂêåÊ≠•ÔºåÁ¢∫‰øùÈáçÁΩÆÂêåÊ≠•ÁãÄÊÖã
                            if (silent) {
                                expensesSyncInProgress = false;
                                // Âè™ÊúâÂú®‰∏çÊòØÂõ†ÁÇ∫ÂèñÊ∂àËÄåÁµêÊùüÊôÇÊâçÈáçÁΩÆÊ®ôË®ò
                                if (!expensesSyncAbortFlag) {
                                    expensesSyncAbortFlag = false;
                                }
                            }
                        }
                    };

                    // ÂæûÈõ≤Á´ØÂêåÊ≠•Ë≥áÊñôÔºàÂñÆÂêëÊãâÂèñÔºöFirebase ‚Üí Êú¨Âú∞ÔºåË¶ÜËìãÊú¨Âú∞Ë≥áÊñôÔºâ
                    const syncFromCloud = async () => {
                        if (!cloudTripId.value) {
                            console.log('‚ùå ÁÑ°Ê≥ïÂêåÊ≠•ÔºöÊ≤íÊúâ cloudTripId');
                            return;
                        }

                        console.log('üîÑ ÈñãÂßãÂæû Firebase ÂêåÊ≠•Ë≥áÊñô...', {
                            cloudTripId: cloudTripId.value,
                        });

                        const firestoreDb = await checkCloudFirebaseReady();
                        if (!firestoreDb) {
                            console.warn('‚ùå Firebase ÈÄ£Á∑öÂ§±ÊïóÔºåÁÑ°Ê≥ïÂêåÊ≠•');
                            // Ê™¢Êü•ÊòØÂê¶ÊúâÊú¨Âú∞Â∑≤ÂêåÊ≠•ÁöÑË≥áÊñôÂèØ‰ª•‰ΩøÁî®
                            if (currentTripId.value) {
                                const hasLocalData =
                                    localStorage.getItem(getStorageKey(currentTripId.value, 'synced')) === 'true';
                                if (hasLocalData) {
                                    console.log('‚úÖ ‰ΩøÁî®Êú¨Âú∞Â∑≤ÂÑ≤Â≠òÁöÑË≥áÊñôÔºàÊúÄÂæå‰∏ÄÊ¨°ÂêåÊ≠•ÁöÑË≥áÊñôÔºâ');
                                    // Ë≥áÊñôÂ∑≤Á∂ìÂú® switchTrip ÊôÇÂæû localStorage ËºâÂÖ•‰∫ÜÔºåÊâÄ‰ª•‰∏çÈúÄË¶ÅÂÜçÂÅö‰ªÄÈ∫º
                                }
                            }
                            return;
                        }

                        console.log('‚úÖ Firebase ÈÄ£Á∑öÊàêÂäü');

                        isSyncing.value = true;

                        // Ê®ôË®òÁÇ∫Êú¨Âú∞Êõ¥Êñ∞ÔºåÈÅøÂÖçÁõ£ËÅΩÂô®Ëß∏Áôº
                        isLocalUpdate = true;

                        try {
                            const firestoreModule = await getFirestoreModule();
                            const { collection, getDocs, doc, getDoc } = firestoreModule;

                            // ÂÑ™ÂÖàÂêåÊ≠• trip Âü∫Êú¨Ë≥áË®äÔºàÁâπÂà•ÊòØ destinationÔºâÔºåËÆì UI ÂèØ‰ª•Êõ¥Êó©È°ØÁ§∫
                            console.log('‚öôÔ∏è Ê≠£Âú®ÊíàÂèñÊóÖÁ®ãË®≠ÂÆö (config)...');
                            const tripDoc = await getDoc(doc(firestoreDb, `trips/${cloudTripId.value}`));
                            console.log('‚öôÔ∏è Trip Doc:', {
                                exists: tripDoc.exists(),
                                id: tripDoc.id,
                                data: tripDoc.exists() ? tripDoc.data() : null,
                            });

                            if (tripDoc.exists()) {
                                const tripData = tripDoc.data();
                                console.log('üìã Trip ÂÆåÊï¥Ë≥áÊñô:', tripData);

                                // ÂÑ™ÂÖàÂêåÊ≠• title Âíå destinationÔºàËÆì UI ÂèØ‰ª•Á´ãÂç≥Êõ¥Êñ∞Ôºâ
                                // ÂêåÊ≠• titleÔºàÊóÖÈÅäÊ®ôÈ°åÔºâ- ÂÑ™ÂÖà‰ΩøÁî®Ê†πÂ±§Á¥öÔºåÂÖ∂Ê¨° config
                                const syncedTitle = tripData.title || (tripData.config && tripData.config.title) || '';
                                if (syncedTitle) {
                                    setup.value.title = syncedTitle;
                                    console.log('‚úÖ Title Â∑≤Êõ¥Êñ∞ÔºàÂÑ™ÂÖàÂêåÊ≠•Ôºâ:', syncedTitle);
                                } else {
                                    // Â¶ÇÊûúÊ≤íÊúâ titleÔºå‰ΩøÁî® destination ‰ΩúÁÇ∫ fallbackÔºàÂêëÂæåÂÖºÂÆπÔºâ
                                    const fallbackTitle =
                                        tripData.destination || (tripData.config && tripData.config.destination) || '';
                                    if (fallbackTitle) {
                                        setup.value.title = fallbackTitle;
                                        console.log('‚ö†Ô∏è Title ‰∏çÂ≠òÂú®Ôºå‰ΩøÁî® destination ‰ΩúÁÇ∫ fallback:', fallbackTitle);
                                    }
                                }

                                // ÂêåÊ≠• destinationÔºàÂúãÂÆ∂/Âú∞ÈªûÔºâ- ÂÑ™ÂÖà‰ΩøÁî®Ê†πÂ±§Á¥öÔºåÂÖ∂Ê¨° config
                                const syncedDestination =
                                    tripData.destination || (tripData.config && tripData.config.destination) || '';
                                if (syncedDestination) {
                                    setup.value.destination = syncedDestination;
                                    console.log('‚úÖ Destination Â∑≤Êõ¥Êñ∞ÔºàÂÑ™ÂÖàÂêåÊ≠•Ôºâ:', syncedDestination);
                                }

                                // Êõ¥Êñ∞ tripList ‰∏≠ÁöÑÈ°ØÁ§∫Ôºà‰ΩøÁî® titleÔºåÊ≤íÊúâÂâáÁî® destinationÔºâ
                                const trip = tripList.value.find((t) => t.id === currentTripId.value);
                                if (trip) {
                                    trip.destination = setup.value.title || setup.value.destination || trip.destination;
                                    saveTripList();
                                }
                            }

                            // ÂêåÊ≠• days
                            console.log('üìÖ Ê≠£Âú®ÊíàÂèñË°åÁ®ãË≥áÊñô (days)...');
                            const daysSnapshot = await getDocs(
                                collection(firestoreDb, `trips/${cloudTripId.value}/days`)
                            );
                            console.log('üìÖ Days Snapshot:', {
                                size: daysSnapshot.size,
                                empty: daysSnapshot.empty,
                                docs: daysSnapshot.docs.map((d) => ({
                                    id: d.id,
                                    data: d.data(),
                                })),
                            });

                            const syncedDays = [];
                            daysSnapshot.forEach((doc) => {
                                const data = doc.data();
                                syncedDays.push({
                                    order: data.order,
                                    date: data.date,
                                    shortDate: data.shortDate,
                                    fullDate: data.fullDate,
                                    title: data.title,
                                    flight: data.flight,
                                    items: data.items || [],
                                });
                            });
                            // ‰æùÁÖß order ÊéíÂ∫è
                            syncedDays.sort((a, b) => a.order - b.order);
                            days.value = syncedDays;
                            console.log('‚úÖ Ë°åÁ®ãË≥áÊñôËºâÂÖ•ÂÆåÊàê:', {
                                daysCount: syncedDays.length,
                                days: syncedDays,
                            });

                            // ÂêåÊ≠• sharedExpenses
                            console.log('üí∞ Ê≠£Âú®ÊíàÂèñÊîØÂá∫Ë≥áÊñô (expenses)...');
                            const expensesSnapshot = await getDocs(
                                collection(firestoreDb, `trips/${cloudTripId.value}/sharedExpenses`)
                            );
                            console.log('üí∞ Expenses Snapshot:', {
                                size: expensesSnapshot.size,
                                empty: expensesSnapshot.empty,
                                docs: expensesSnapshot.docs.map((d) => ({
                                    id: d.id,
                                    data: d.data(),
                                })),
                            });

                            const syncedExpenses = [];
                            expensesSnapshot.forEach((doc) => {
                                const data = doc.data();
                                // ËôïÁêÜËàäË≥áÊñôÔºöÂ¶ÇÊûúÊ≤íÊúâ splitParticipants ÊàñÁÇ∫Á©∫Èô£ÂàóÔºå‰ΩøÁî®Áï∂ÂâçÂÖ®Âì°‰ΩúÁÇ∫È†êË®≠ÂÄº
                                let splitParts = data.splitParticipants;
                                if (!splitParts || !Array.isArray(splitParts) || splitParts.length === 0) {
                                    // ËàäË≥áÊñôÊàñÁ©∫Èô£ÂàóÔºö‰ΩøÁî®Áï∂ÂâçÂÖ®Âì°ÂàóË°®ÔºàÈÄôÊòØÂêàÁêÜÁöÑÈ†êË®≠ÂÄºÔºâ
                                    splitParts = [...participants.value];
                                }
                                syncedExpenses.push({
                                    item: data.item,
                                    amount: data.amount,
                                    payer: data.payerName,
                                    order: data.order || null,
                                    splitParticipants: splitParts, // Á¢∫‰øùÊ∞∏ÈÅ†ÊúâÊòéÁ¢∫ÁöÑÂÄº
                                });
                            });
                            expenses.value = syncedExpenses;
                            console.log('‚úÖ ÊîØÂá∫Ë≥áÊñôËºâÂÖ•ÂÆåÊàê:', {
                                expensesCount: syncedExpenses.length,
                                expenses: syncedExpenses,
                            });

                            // ÂêåÊ≠• config ‰∏≠ÁöÑÂÖ∂‰ªñË®≠ÂÆöÔºàdestination Â∑≤Âú®ÂâçÈù¢ÂÑ™ÂÖàÂêåÊ≠•ÔºåÈÄôË£°‰∏çÂÜçË¶ÜËìãÔºâ
                            if (tripDoc.exists()) {
                                const tripData = tripDoc.data();

                                // ÂêåÊ≠• config ‰∏≠ÁöÑÂÖ∂‰ªñË®≠ÂÆöÔºà‰ΩÜ‰∏çË¶ÜËìãÂ∑≤ÂêåÊ≠•ÁöÑ title Âíå destinationÔºâ
                                if (tripData.config) {
                                    const currentTitle = setup.value.title || ''; // ‰øùÂ≠òÂ∑≤ÂêåÊ≠•ÁöÑ title
                                    const currentDestination = setup.value.destination || ''; // ‰øùÂ≠òÂ∑≤ÂêåÊ≠•ÁöÑ destination
                                    setup.value = {
                                        ...setup.value,
                                        ...tripData.config,
                                        // Á¢∫‰øù‰ΩøÁî®Â∑≤ÂêåÊ≠•ÁöÑ title Âíå destinationÔºàÂÑ™ÂÖà‰ΩøÁî®Ê†πÂ±§Á¥öÁöÑÂÄºÔºâ
                                        title: currentTitle || tripData.config.title || '',
                                        destination: currentDestination || tripData.config.destination || '',
                                    };
                                    // Âæû config Êõ¥Êñ∞ exchangeRate
                                    if (tripData.config.rate !== undefined) {
                                        exchangeRate.value = tripData.config.rate;
                                    }
                                    console.log('‚úÖ Ë®≠ÂÆöË≥áÊñôÂ∑≤Êõ¥Êñ∞:', {
                                        title: setup.value.title,
                                        destination: setup.value.destination,
                                        currency: setup.value.currency,
                                    });
                                }

                                if (tripData.inviteCode) {
                                    inviteCode.value = tripData.inviteCode;
                                    console.log('‚úÖ ÈÇÄË´ãÁ¢ºÂ∑≤Êõ¥Êñ∞:', inviteCode.value);
                                }

                                // ÂêåÊ≠•ÂàÜÂ∏≥ÊàêÂì°ÔºàÂÑ™ÂÖà‰ΩøÁî® Firestore ‰∏≠ÁöÑ participantsÔºâ
                                if (tripData.participants) {
                                    participantsStr.value = tripData.participants;
                                    updateParticipants();
                                    console.log('‚úÖ ÂàÜÂ∏≥ÊàêÂì°Â∑≤Êõ¥Êñ∞:', participantsStr.value);
                                } else {
                                    // Â¶ÇÊûú Firestore ‰∏≠Ê≤íÊúâ participantsÔºåÊ™¢Êü• localStorage ÊòØÂê¶Êúâ
                                    const localUsers = localStorage.getItem(
                                        getStorageKey(currentTripId.value, 'users')
                                    );
                                    if (localUsers) {
                                        participantsStr.value = localUsers;
                                        updateParticipants();
                                        console.log(
                                            '‚ö†Ô∏è Firestore ‰∏≠Ê≤íÊúâ participantsÔºå‰ΩøÁî®Êú¨Âú∞Ë≥áÊñô:',
                                            participantsStr.value
                                        );
                                    } else {
                                        // Â¶ÇÊûúÈÉΩÊ≤íÊúâÔºå‰ΩøÁî®È†êË®≠ÂÄº
                                        participantsStr.value = DEFAULT_PARTICIPANTS_STR;
                                        updateParticipants();
                                        console.log('‚ö†Ô∏è ‰ΩøÁî®È†êË®≠ÂàÜÂ∏≥ÊàêÂì°:', participantsStr.value);
                                    }
                                }
                            } else {
                                console.warn('‚ö†Ô∏è Trip Êñá‰ª∂‰∏çÂ≠òÂú®');
                            }

                            // ÂÆåÊï¥Êõ¥Êñ∞ localStorageÔºàÁ¢∫‰øùÈõ¢Á∑öÊôÇ‰πüËÉΩÁúãÂà∞ÊúÄÂæåÂêåÊ≠•ÁöÑË≥áÊñôÔºâ
                            if (currentTripId.value) {
                                saveToStorage(currentTripId.value, 'days', days.value);
                                saveToStorage(currentTripId.value, 'exp', expenses.value);
                                saveToStorage(currentTripId.value, 'config', setup.value);
                                localStorage.setItem(
                                    getStorageKey(currentTripId.value, 'rate'),
                                    exchangeRate.value.toString()
                                );
                                localStorage.setItem(
                                    getStorageKey(currentTripId.value, 'users'),
                                    participantsStr.value
                                );

                                // Êõ¥Êñ∞Èõ≤Á´ØË≥áË®äÔºåÂä†‰∏äÊúÄÂæåÂêåÊ≠•ÊôÇÈñì
                                const cloudData = loadFromStorage(currentTripId.value, 'cloud');
                                if (cloudData) {
                                    cloudData.lastSyncedAt = new Date().toISOString();
                                    saveToStorage(currentTripId.value, 'cloud', cloudData);
                                }

                                // Ê®ôË®òË≥áÊñôÂ∑≤ÂæûÈõ≤Á´ØÂêåÊ≠•ÔºàÁî®ÊñºÈõ¢Á∑öÊôÇÈ°ØÁ§∫ÊèêÁ§∫Ôºâ
                                localStorage.setItem(getStorageKey(currentTripId.value, 'synced'), 'true');
                            }

                            // È©óË≠âË≥áÊñôÂÆåÊï¥ÊÄß
                            const verification = {
                                days: {
                                    count: days.value.length,
                                    hasData: days.value.length > 0,
                                    sample: days.value[0] || null,
                                },
                                expenses: {
                                    count: expenses.value.length,
                                    hasData: expenses.value.length > 0,
                                    sample: expenses.value[0] || null,
                                },
                                config: {
                                    hasConfig: !!(setup.value.title || setup.value.destination),
                                    title: setup.value.title,
                                    destination: setup.value.destination,
                                    currency: setup.value.currency,
                                },
                            };

                            console.log('üéâ ÂêåÊ≠•ÂÆåÊàêÔºÅÈ©óË≠âÁµêÊûú:', verification);
                            console.log('üì¶ ÂÆåÊï¥Ë≥áÊñôÊëòË¶Å:', {
                                days: days.value,
                                expenses: expenses.value,
                                setup: setup.value,
                            });
                        } catch (error) {
                            console.error('‚ùå ÂêåÊ≠•Â§±Êïó:', error);

                            // Ê™¢Êü• localStorage ÊòØÂê¶Êúâ‰πãÂâçÂêåÊ≠•ÁöÑË≥áÊñô
                            if (currentTripId.value) {
                                const hasLocalData = localStorage.getItem(`${currentTripId.value}_synced`) === 'true';
                                if (hasLocalData) {
                                    console.warn('ÂêåÊ≠•Â§±ÊïóÔºå‰ΩÜÂèØ‰ΩøÁî®Êú¨Âú∞Â∑≤ÂÑ≤Â≠òÁöÑË≥áÊñô');
                                    // ‰∏çÈ°ØÁ§∫ alertÔºåËÆì‰ΩøÁî®ËÄÖÂèØ‰ª•ÁπºÁ∫å‰ΩøÁî®Êú¨Âú∞Ë≥áÊñô
                                } else {
                                    alert('ÂêåÊ≠•Â§±ÊïóÔºö' + error.message + '\n\nÂ¶ÇÊûúÊåÅÁ∫åÁÑ°Ê≥ïÈÄ£Á∑öÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØË®≠ÂÆö„ÄÇ');
                                }
                            } else {
                                alert('ÂêåÊ≠•Â§±ÊïóÔºö' + error.message);
                            }
                        } finally {
                            isSyncing.value = false;
                            // ÈáçÁΩÆ isLocalUpdate Ê®ôË®ò
                            isLocalUpdate = false;
                            console.log('‚úÖ ÂêåÊ≠•ÂÆåÊàêÔºåÈáçÁΩÆ isLocalUpdate Ê®ôË®ò');
                        }
                    };

                    // Ë§áË£ΩÈÇÄË´ãÁ¢ºÈÄ£Áµê
                    const copyInviteLink = async () => {
                        if (!inviteLink.value) {
                            alert('Ê≤íÊúâÂèØÂàÜ‰∫´ÁöÑÈÄ£Áµê');
                            return;
                        }
                        try {
                            await navigator.clipboard.writeText(inviteLink.value);
                            // È°ØÁ§∫ÊàêÂäüÊèêÁ§∫Ôºà‰ΩøÁî®Êõ¥ÂèãÂñÑÁöÑÊèêÁ§∫ÊñπÂºèÔºâ
                            const message =
                                '‚úÖ Â∑≤Ë§áË£ΩÈÇÄË´ãÈÄ£ÁµêÔºÅ\n\n' +
                                inviteLink.value +
                                '\n\nË´ãÂ∞áÊ≠§ÈÄ£ÁµêÂàÜ‰∫´Áµ¶ÊóÖ‰º¥Ôºå‰ªñÂÄëÂ∞±ËÉΩ‰∏ÄËµ∑Á∑®ËºØÈÄôÂÄãË°åÁ®ã‰∫ÜÔºÅ';
                            alert(message);
                        } catch (error) {
                            // ÈôçÁ¥öÊñπÊ°àÔºö‰ΩøÁî®ÂÇ≥Áµ±ÊñπÊ≥ï
                            const textArea = document.createElement('textarea');
                            textArea.value = inviteLink.value;
                            textArea.style.position = 'fixed';
                            textArea.style.opacity = '0';
                            document.body.appendChild(textArea);
                            textArea.select();
                            try {
                                document.execCommand('copy');
                                const message =
                                    '‚úÖ Â∑≤Ë§áË£ΩÈÇÄË´ãÈÄ£ÁµêÔºÅ\n\n' +
                                    inviteLink.value +
                                    '\n\nË´ãÂ∞áÊ≠§ÈÄ£ÁµêÂàÜ‰∫´Áµ¶ÊóÖ‰º¥Ôºå‰ªñÂÄëÂ∞±ËÉΩ‰∏ÄËµ∑Á∑®ËºØÈÄôÂÄãË°åÁ®ã‰∫ÜÔºÅ';
                                alert(message);
                            } catch (err) {
                                alert('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïË§áË£ΩÔºö\n\n' + inviteLink.value);
                            }
                            document.body.removeChild(textArea);
                        }
                    };

                    // Ë§áË£ΩÈÇÄË´ãÁ¢º
                    const copyInviteCode = async () => {
                        if (!inviteCode.value) {
                            alert('Ê≤íÊúâÈÇÄË´ãÁ¢º');
                            return;
                        }
                        try {
                            await navigator.clipboard.writeText(inviteCode.value);
                            alert('Â∑≤Ë§áË£ΩÈÇÄË´ãÁ¢ºÔºÅ');
                        } catch (error) {
                            const textArea = document.createElement('textarea');
                            textArea.value = inviteCode.value;
                            textArea.style.position = 'fixed';
                            textArea.style.opacity = '0';
                            document.body.appendChild(textArea);
                            textArea.select();
                            try {
                                document.execCommand('copy');
                                alert('Â∑≤Ë§áË£ΩÈÇÄË´ãÁ¢ºÔºÅ');
                            } catch (err) {
                                alert('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïË§áË£ΩÔºö' + inviteCode.value);
                            }
                            document.body.removeChild(textArea);
                        }
                    };

                    // Ê™¢Êü•ÊóÖÁ®ãÊòØÂê¶Â∑≤‰∏äÂÇ≥Âà∞Èõ≤Á´Ø
                    const getTripCloudStatus = (tripId) => {
                        const cloudData = localStorage.getItem(`${tripId}_cloud`);
                        if (!cloudData) return false;
                        try {
                            const cloud = JSON.parse(cloudData);
                            return cloud.isCloudTrip === true && cloud.cloudTripId;
                        } catch {
                            return false;
                        }
                    };

                    // ËôïÁêÜ‰∏äÂÇ≥Âà∞Èõ≤Á´ØÔºàÈúÄË¶ÅÂÖàÂàáÊèõÂà∞Ë©≤ÊóÖÁ®ãÔºâ
                    // silent: true ÊôÇ‰∏çÈ°ØÁ§∫„Äå‰∏äÂÇ≥ÊàêÂäü„ÄçÊèêÁ§∫ÔºàÁµ¶ËÉåÊôØËá™ÂãïÂêåÊ≠•Áî®Ôºâ
                    const handleUploadToCloud = async (tripId, silent = false) => {
                        // Â¶ÇÊûúÁï∂Ââç‰∏çÊòØÈÄôÂÄãÊóÖÁ®ãÔºåÂÖàÂàáÊèõÈÅéÂéª
                        if (currentTripId.value !== tripId) {
                            await switchTrip(tripId);
                            // Á≠âÂæÖ‰∏Ä‰∏ãËÆìË≥áÊñôËºâÂÖ•
                            await new Promise((resolve) => setTimeout(resolve, 300));
                        }
                        await uploadToCloud(silent);
                    };

                    // ËôïÁêÜÂêåÊ≠•ÔºàÈúÄË¶ÅÂÖàÂàáÊèõÂà∞Ë©≤ÊóÖÁ®ãÔºâ
                    const handleSyncFromCloud = async (tripId) => {
                        // Â¶ÇÊûúÁï∂Ââç‰∏çÊòØÈÄôÂÄãÊóÖÁ®ãÔºåÂÖàÂàáÊèõÈÅéÂéª
                        if (currentTripId.value !== tripId) {
                            await switchTrip(tripId);
                            // Á≠âÂæÖ‰∏Ä‰∏ãËÆìË≥áÊñôËºâÂÖ•
                            await new Promise((resolve) => setTimeout(resolve, 300));
                        }
                        await syncFromCloud();
                        alert('ÂêåÊ≠•ÂÆåÊàêÔºÅ');
                    };

                    // ËôïÁêÜÂàÜ‰∫´ÈÇÄË´ãÁ¢ºÈÄ£ÁµêÔºàÁõ¥Êé•Ë§áË£ΩÈÄ£ÁµêÔºâ
                    const handleShowInviteModal = async (tripId) => {
                        // Â¶ÇÊûúÁï∂Ââç‰∏çÊòØÈÄôÂÄãÊóÖÁ®ãÔºåÂÖàÂàáÊèõÈÅéÂéª
                        if (currentTripId.value !== tripId) {
                            await switchTrip(tripId);
                            // Á≠âÂæÖ‰∏Ä‰∏ãËÆìË≥áÊñôËºâÂÖ•
                            await new Promise((resolve) => setTimeout(resolve, 300));
                        }

                        // Áõ¥Êé•Ë§áË£ΩÈÇÄË´ãÁ¢ºÈÄ£Áµê
                        await copyInviteLink();
                    };

                    // ËôïÁêÜÂà™Èô§ÊâÄÊúâÊú¨Âú∞Á´Ø storage
                    const handleClearAllLocalStorage = () => {
                        if (
                            !confirm(
                                'Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊú¨Âú∞Á´ØË≥áÊñôÂóéÔºü\n\nÊ≥®ÊÑèÔºö\n- Â∞áÊ∏ÖÈô§ÊâÄÊúâÊóÖÁ®ãÁöÑÊú¨Âú∞Á´ØË≥áÊñôÔºàÂåÖÊã¨ÊóÖÁ®ãÂàóË°®Ôºâ\n- Èõ≤Á´ØÊóÖÁ®ãÂèØ‰ª•ÈÄèÈÅéÈÇÄË´ãÁ¢ºÈáçÊñ∞ËºâÂÖ•\n- Ê≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü'
                            )
                        ) {
                            return;
                        }

                        // ÂÆåÂÖ®Ê∏ÖÈô§ÊâÄÊúâ localStorage Ë≥áÊñô
                        localStorage.clear();

                        // Ê∏ÖÁ©∫ÊâÄÊúâÁãÄÊÖã
                        tripList.value = [];
                        currentTripId.value = null;
                        days.value = [];
                        expenses.value = [];
                        personalExpenses.value = [];
                        participants.value = [...DEFAULT_PARTICIPANTS];
                        participantsStr.value = DEFAULT_PARTICIPANTS_STR;
                        exchangeRate.value = DEFAULT_EXCHANGE_RATE;
                        isCloudTrip.value = false;
                        cloudTripId.value = null;
                        inviteCode.value = '';
                        setup.value = {
                            destination: '',
                            startDate: new Date().toISOString().split('T')[0],
                            days: 5,
                            rate: DEFAULT_EXCHANGE_RATE,
                            currency: 'JPY',
                            langCode: 'ja',
                            langName: 'Êó•Êñá',
                        };

                        // ÈóúÈñâÂÅ¥ÈÇäÊ¨Ñ‰∏¶È°ØÁ§∫Âª∫Á´ãÊñ∞ÊóÖÁ®ãË¶ñÁ™ó
                        showTripMenu.value = false;
                        showSetupModal.value = true;

                        alert('ÊâÄÊúâÊú¨Âú∞Á´ØË≥áÊñôÂ∑≤ÂÆåÂÖ®Ê∏ÖÈô§ÔºÅ');
                    };

                    // Ê™¢Êü• URL ÂèÉÊï∏‰∏≠ÁöÑÈÇÄË´ãÁ¢º
                    const checkInviteCodeFromUrl = async () => {
                        if (!useFirebase) return;

                        const urlParams = new URLSearchParams(window.location.search);
                        const code = urlParams.get('code');
                        if (!code) return;

                        const firestoreDb = await waitForDb();
                        if (!firestoreDb) {
                            console.warn('Firebase ÈÄ£Á∑öÂ§±ÊïóÔºåÁÑ°Ê≥ïËºâÂÖ•ÈÇÄË´ãÊóÖÁ®ã');
                            return;
                        }

                        try {
                            const firestoreModule = await getFirestoreModule();
                            const { collection, query, where, getDocs } = firestoreModule;

                            // Êü•Ë©¢Â∞çÊáâÁöÑ trip
                            const q = query(collection(firestoreDb, 'trips'), where('inviteCode', '==', code));
                            const snapshot = await getDocs(q);

                            if (snapshot.empty) {
                                alert('Êâæ‰∏çÂà∞Â∞çÊáâÁöÑÊóÖÁ®ãÔºåÈÇÄË´ãÁ¢ºÂèØËÉΩÂ∑≤Â§±Êïà');
                                return;
                            }

                            const tripDoc = snapshot.docs[0];
                            const tripData = tripDoc.data();
                            const foundTripId = tripDoc.id;

                            // Ê™¢Êü•ÊòØÂê¶Â∑≤Â≠òÂú®Êñº tripList
                            let existingTrip = tripList.value.find((t) => {
                                const cloud = localStorage.getItem(`${t.id}_cloud`);
                                if (cloud) {
                                    const cloudData = JSON.parse(cloud);
                                    return cloudData.cloudTripId === foundTripId;
                                }
                                return false;
                            });

                            if (existingTrip) {
                                // Â∑≤Â≠òÂú®ÔºåÁ¢∫‰øù cloudData ‰∏≠ÁöÑ inviteCode ÊòØÊúÄÊñ∞ÁöÑÔºåÁÑ∂ÂæåÂàáÊèõ
                                const existingCloudData = {
                                    cloudTripId: foundTripId,
                                    inviteCode: code,
                                    isCloudTrip: true,
                                };
                                saveToStorage(existingTrip.id, 'cloud', existingCloudData);
                                await switchTrip(existingTrip.id);
                            } else {
                                // ‰∏çÂ≠òÂú®ÔºåÂª∫Á´ãÊñ∞ÁöÑÊú¨Âú∞ÊóÖÁ®ã‰∏¶ÈÄ£ÁµêÂà∞Èõ≤Á´Ø
                                const newLocalId = generateId();
                                const newTripMeta = {
                                    id: newLocalId,
                                    destination: tripData.title || tripData.destination || 'Èõ≤Á´ØÊóÖÁ®ã', // tripList ‰ΩøÁî® titleÔºåÊ≤íÊúâÂâáÁî® destination
                                    startDate: tripData.startDate || new Date().toISOString().split('T')[0],
                                    daysCount: tripData.daysCount || 0,
                                    isCloudTrip: true,
                                };

                                // ÂÑ≤Â≠òÈõ≤Á´ØË≥áË®ä
                                const cloudData = {
                                    cloudTripId: foundTripId,
                                    inviteCode: code,
                                    isCloudTrip: true,
                                };
                                saveToStorage(newLocalId, 'cloud', cloudData);

                                // ÂàùÂßãÂåñÁ©∫ÁöÑË≥áÊñô
                                saveToStorage(newLocalId, 'days', []);
                                saveToStorage(newLocalId, 'exp', []);
                                // ‰ΩøÁî® Firestore ‰∏≠ÁöÑ participantsÔºåÂ¶ÇÊûúÊ≤íÊúâÂâá‰ΩøÁî®È†êË®≠ÂÄº
                                const participantsFromCloud = tripData.participants || DEFAULT_PARTICIPANTS_STR;
                                localStorage.setItem(getStorageKey(newLocalId, 'users'), participantsFromCloud);
                                localStorage.setItem(
                                    getStorageKey(newLocalId, 'rate'),
                                    (tripData.config?.rate || DEFAULT_EXCHANGE_RATE).toString()
                                );
                                // Á¢∫‰øù config ÂåÖÂê´ title Âíå destinationÔºàÊòéÁ¢∫ÂàÜÈõ¢Ôºâ
                                // ÂÑ™ÂÖà‰ΩøÁî®Ê†πÂ±§Á¥öÁöÑÂÄºÔºåÂÖ∂Ê¨° config ‰∏≠ÁöÑÂÄº
                                const syncedTitle =
                                    tripData.title ||
                                    (tripData.config && tripData.config.title) ||
                                    tripData.destination ||
                                    'Èõ≤Á´ØÊóÖÁ®ã';
                                const syncedDestination =
                                    tripData.destination || (tripData.config && tripData.config.destination) || 'Tokyo';
                                const defaultConfig = {
                                    title: syncedTitle,
                                    destination: syncedDestination,
                                    ...tripData.config,
                                    // Á¢∫‰øùË¶ÜËìã config ‰∏≠ÁöÑ title Âíå destinationÔºà‰ΩøÁî®Ê†πÂ±§Á¥öÁöÑÂÄºÔºâ
                                    title: syncedTitle,
                                    destination: syncedDestination,
                                };
                                saveToStorage(newLocalId, 'config', defaultConfig);

                                tripList.value.unshift(newTripMeta);
                                saveTripList();

                                // ÂàáÊèõÂà∞Êñ∞ÊóÖÁ®ã‰∏¶ÂêåÊ≠•
                                await switchTrip(newLocalId);
                            }

                            // Ê∏ÖÈô§ URL ÂèÉÊï∏
                            window.history.replaceState({}, document.title, window.location.pathname);
                        } catch (error) {
                            console.error('ËºâÂÖ•ÈÇÄË´ãÊóÖÁ®ãÂ§±Êïó:', error);
                            alert('ËºâÂÖ•Â§±ÊïóÔºö' + error.message);
                        }
                    };

                    // --- Init ---
                    onMounted(async () => {
                        loadTripList();

                        // ÂÖàÊ™¢Êü• URL ‰∏≠ÁöÑÈÇÄË´ãÁ¢º
                        await checkInviteCodeFromUrl();

                        if (tripList.value.length > 0) {
                            // ÂÑ™ÂÖàËºâÂÖ•‰∏äÊ¨°ÈÅ∏ÊìáÁöÑÊóÖÁ®ã
                            const lastSelectedTripId = localStorage.getItem('last_selected_trip_id');
                            const lastSelectedTrip = lastSelectedTripId
                                ? tripList.value.find((t) => t.id === lastSelectedTripId)
                                : null;

                            if (lastSelectedTrip) {
                                // Â¶ÇÊûú‰∏äÊ¨°ÈÅ∏ÊìáÁöÑÊóÖÁ®ã‰ªçÂ≠òÂú®ÔºåËºâÂÖ•ÂÆÉ
                                await switchTrip(lastSelectedTripId);
                            } else {
                                // Âê¶ÂâáÂÑ™ÂÖàËºâÂÖ•Êó•Êú¨Ë°åÁ®ã
                                const jpTrip = tripList.value.find((t) => t.id === JP_TRIP_ID);
                                if (jpTrip) await switchTrip(JP_TRIP_ID);
                                else await switchTrip(tripList.value[0].id);
                            }
                        } else {
                            showSetupModal.value = true;
                        }

                        // Watchers for Auto-Save
                        watch(
                            [days, expenses, exchangeRate, participantsStr],
                            () => {
                                if (!currentTripId.value) return;
                                saveToStorage(currentTripId.value, 'days', days.value);
                                saveToStorage(currentTripId.value, 'exp', expenses.value);
                                localStorage.setItem(
                                    getStorageKey(currentTripId.value, 'rate'),
                                    exchangeRate.value.toString()
                                );
                                localStorage.setItem(
                                    getStorageKey(currentTripId.value, 'users'),
                                    participantsStr.value
                                );
                            },
                            { deep: true }
                        );
                        // Áõ£ËÅΩÂÄã‰∫∫Ë®òÂ∏≥ËÆäÂåñ‰∏¶Ëá™ÂãïÂÑ≤Â≠ò
                        watch(
                            personalExpenses,
                            () => {
                                if (!currentTripId.value) return;
                                saveToStorage(currentTripId.value, 'personal_exp', personalExpenses.value);
                            },
                            { deep: true }
                        );

                        // ÂèÉËàáËÄÖËÆäÊõ¥ÊôÇÈáçÁΩÆÈ†êË®≠ÂàÜÊî§
                        watch(
                            participants,
                            () => {
                                if (!isPersonalMode.value) resetNewExpenseSplits();
                            },
                            { deep: true }
                        );

                        // ÂàáÊèõÂ§ö‰∫∫Ê®°ÂºèÊôÇËá™ÂãïÂÖ®ÈÅ∏ÂàÜÊî§
                        watch(isPersonalMode, (val) => {
                            if (!val) resetNewExpenseSplits();
                        });

                        // Áõ£ËÅΩ title ËÆäÂåñ‰∏¶Ë™øÊï¥Â≠óÈ´îÂ§ßÂ∞è
                        watch(
                            () => setup.value.title,
                            () => {
                                adjustTitleFontSize();
                            }
                        );
                        // Áõ£ËÅΩ destination ËÆäÂåñÔºàÊõ¥Êñ∞ÂåØÁéáËàáÂ§©Ê∞£Ôºå‰∏¶Á¢∫‰øùÂæåÁ∫åÂäüËÉΩ‰ΩøÁî®ÊúÄÊñ∞ÂÄºÔºâ
                        watch(
                            () => setup.value.destination,
                            (val, oldVal) => {
                                if (val && val !== oldVal) {
                                    detectRate();
                                    fetchWeather(val);
                                }
                            }
                        );

                        // Áõ£ËÅΩË¶ñÁ™óÂ§ßÂ∞èËÆäÂåñ
                        window.addEventListener('resize', adjustDestinationFontSize);

                        // ÂàùÂßãË™øÊï¥Â≠óÈ´îÂ§ßÂ∞è
                        adjustTitleFontSize();

                        if (!isPersonalMode.value) {
                            resetNewExpenseSplits();
                        }
                    });

                    // Map & User Location Logic
                    const initMap = async () => {
                        isMapLoading.value = true;
                        await nextTick();
                        if (!document.getElementById('map')) return;
                        if (mapInstance) {
                            mapInstance.remove();
                            mapInstance = null;
                        }
                        mapInstance = L.map('map').setView([35.6895, 139.6917], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '¬© OpenStreetMap',
                        }).addTo(mapInstance);
                        if ('geolocation' in navigator) {
                            if (geoWatchId !== null) navigator.geolocation.clearWatch(geoWatchId);
                            geoWatchId = navigator.geolocation.watchPosition(
                                (pos) => {
                                    userLocation.value = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                                    const icon = L.divIcon({
                                        className: 'custom-div-icon',
                                        html: "<div class='gps-pulse'></div>",
                                        iconSize: [14, 14],
                                    });
                                    if (userMarker) userMarker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
                                    else
                                        userMarker = L.marker([pos.coords.latitude, pos.coords.longitude], {
                                            icon: icon,
                                        }).addTo(mapInstance);
                                },
                                (err) => {},
                                { enableHighAccuracy: true }
                            );
                        }
                        const locs = currentDay.value.items.filter((i) => i.location);
                        const bounds = L.latLngBounds();
                        for (const item of locs) {
                            try {
                                await new Promise((r) => setTimeout(r, 500));
                                const res = await fetch(
                                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                                        item.location
                                    )}`
                                );
                                const d = await res.json();
                                if (d && d.length > 0) {
                                    const lat = parseFloat(d[0].lat);
                                    const lon = parseFloat(d[0].lon);
                                    L.marker([lat, lon])
                                        .addTo(mapInstance)
                                        .bindPopup(`<b>${item.activity}</b><br>${item.location}`);
                                    bounds.extend([lat, lon]);
                                }
                            } catch (e) {}
                        }
                        isMapLoading.value = false;
                        if (locs.length > 0) mapInstance.fitBounds(bounds, { padding: [50, 50] });
                    };
                    const centerOnUser = () => {
                        if (userLocation.value && mapInstance)
                            mapInstance.flyTo([userLocation.value.lat, userLocation.value.lng], 15);
                    };
                    watch(viewMode, (v) => {
                        if (v === 'map') {
                            initMap();
                        }
                        // Áï∂ÂàáÊèõÂà∞ÂàÜÂ∏≥Ë¶ñÂúñÊôÇÔºåÈ†êË®≠Êñ∞Â∏≥ÁõÆÁöÑÊôÇÈñìÁÇ∫Áï∂‰∏ãÊôÇÈñì
                        if (v === 'money') {
                            const now = new Date();
                            // ËΩâÊàê datetime-local ÂèØÁî®ÁöÑÂ≠ó‰∏≤Ê†ºÂºèÔºöYYYY-MM-DDTHH:mm
                            const yyyy = now.getFullYear();
                            const mm = String(now.getMonth() + 1).padStart(2, '0');
                            const dd = String(now.getDate()).padStart(2, '0');
                            const hh = String(now.getHours()).padStart(2, '0');
                            const min = String(now.getMinutes()).padStart(2, '0');
                            newExpense.value.time = `${yyyy}-${mm}-${dd}T${hh}:${min}`;
                        }
                    });
                    watch(currentDayIdx, () => {
                        if (viewMode.value === 'map') initMap();
                    });

                    // Â∞áÊ∏¨Ë©¶ÂáΩÊï∏ÊéõËºâÂà∞ windowÔºåÊñπ‰æøÂú®ÊéßÂà∂Âè∞Ë™øÁî®
                    window.verifyFirebase = verifyFirebaseConnection; // ÂæûÊ∫êÈ†≠È©óË≠â Firebase ÈÄ£Á∑ö
                    window.testFirebase = testFirebaseConnection;
                    window.checkCloudStatus = checkCloudStatus;
                    window.syncFromCloud = syncFromCloud;
                    window.uploadToCloud = uploadToCloud;
                    window.getCurrentState = () => {
                        return {
                            useFirebase,
                            cloudTripId: cloudTripId.value,
                            currentTripId: currentTripId.value,
                            isCloudTrip: isCloudTrip.value,
                            inviteCode: inviteCode.value,
                            daysCount: days.value.length,
                            expensesCount: expenses.value.length,
                        };
                    };

                    return {
                        viewMode,
                        currentDayIdx,
                        days,
                        currentDay,
                        participants,
                        participantsStr,
                        updateParticipants,
                        getGoogleMapLink,
                        openTimePicker,
                        openTimePickerFromEvent,
                        addItem,
                        removeItem,
                        removeCurrentDay,
                        addDay,
                        expenses,
                        personalExpenses,
                        isPersonalMode,
                        currentExpenses,
                        newExpense,
                        selectAllSplits,
                        totalExpense,
                        addExpense,
                        removeExpense,
                        paidByPerson,
                        owedByPerson,
                        settlementPlan,
                        exchangeRate,
                        getTimePeriod,
                        getExpenseSplitAmount,
                        weather,
                        isMapLoading,
                        userLocation,
                        initMap,
                        centerOnUser,
                        updateDate,
                        showSetupModal,
                        setup,
                        initTrip,
                        weatherDisplay,
                        detectRate,
                        isRateLoading,
                        currencyLabel,
                        currencySymbol,
                        toggleFlightCard,
                        getDotColor,
                        showTripMenu,
                        tripList,
                        createNewTrip,
                        switchTrip,
                        deleteTrip,
                        currentTripId,
                        // Ê®°ÊùøËºâÂÖ•ÂäüËÉΩ
                        showTemplatePreview,
                        isLoadingTemplate,
                        loadTemplateAsNew,
                        loadTemplateToCurrent,
                        JP_TRIP_DATA,
                        JP_EXPENSES,
                        searchNearby,
                        recommendationsMap,
                        isSearchingRecs,
                        applyRecommendation,
                        searchTargetIndex,
                        // Èõ≤Á´ØÂäüËÉΩ
                        isCloudTrip,
                        cloudTripId,
                        inviteCode,
                        inviteLink,
                        isUploading,
                        isSyncing,
                        uploadToCloud,
                        syncFromCloud,
                        // Èõ≤Á´Ø UI ÂäüËÉΩ
                        getTripCloudStatus,
                        handleUploadToCloud,
                        handleSyncFromCloud,
                        handleShowInviteModal,
                        handleClearAllLocalStorage,
                        copyInviteLink,
                        copyInviteCode,
                        testFirebaseConnection, // Ê∏¨Ë©¶ÂáΩÊï∏ÔºàÂèØÂú®ÊéßÂà∂Âè∞Ë™øÁî®Ôºâ
                        // Á∑®ËºØ title ÂäüËÉΩ
                        isEditingTitle,
                        editingTitleValue,
                        titleInputRef,
                        titleTextRef,
                        startEditTitle,
                        saveTitle,
                        cancelEditTitle,
                        adjustTitleFontSize,
                        // Á∑®ËºØ destination ÂäüËÉΩ
                        isEditingDestination,
                        editingDestinationValue,
                        destinationInputRef,
                        startEditDestination,
                        saveDestination,
                        cancelEditDestination,
                    };
                },
            }).mount('#app');
        </script>
    </body>
</html>
